<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INA TRAINER</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
:root{--bg:#05080f;--panel:#0a1020;--border:#0d2040;--accent:#e040fb;--accent2:#ff3d71;--accent3:#00e5ff;--green:#00ff88;--text:#dce8ff;--dim:#3a4a6a;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;height:100vh;overflow:hidden;user-select:none;}
#three-canvas{position:fixed;inset:0;display:none;cursor:none;}
#crosshair{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:50;display:none;}
.ch-line{position:absolute;background:#fff;border-radius:1px;transition:all .06s ease-out;}
.ch-top{width:2px;height:12px;left:50%;top:calc(50% - 20px);transform:translateX(-50%);}
.ch-bottom{width:2px;height:12px;left:50%;top:calc(50% + 8px);transform:translateX(-50%);}
.ch-left{height:2px;width:12px;top:50%;left:calc(50% - 20px);transform:translateY(-50%);}
.ch-right{height:2px;width:12px;top:50%;left:calc(50% + 8px);transform:translateY(-50%);}
.ch-dot{position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;left:50%;top:50%;transform:translate(-50%,-50%);}
#crosshair.shoot .ch-top{top:calc(50% - 26px);}
#crosshair.shoot .ch-bottom{top:calc(50% + 14px);}
#crosshair.shoot .ch-left{left:calc(50% - 26px);}
#crosshair.shoot .ch-right{left:calc(50% + 14px);}
#hud{position:fixed;top:0;left:0;right:0;z-index:40;display:none;justify-content:space-between;align-items:center;padding:12px 28px;background:linear-gradient(180deg,rgba(5,8,15,.95) 0%,transparent 100%);border-bottom:1px solid rgba(224,64,251,.1);}
.hud-block{display:flex;flex-direction:column;align-items:center;gap:2px;}
.hud-lbl{font-size:.55rem;letter-spacing:.3em;color:var(--dim);}
.hud-val{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:700;color:var(--accent);}
#timer-val{color:var(--accent2);}
#timer-val.warn{animation:blink .5s infinite;}
@keyframes blink{0%,100%{color:var(--accent2);}50%{color:#f00;text-shadow:0 0 15px #f00;}}
.mode-tag{font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.2em;padding:3px 10px;border:1px solid var(--accent);color:var(--accent);clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);}
#hit-flash{position:fixed;inset:0;pointer-events:none;z-index:45;background:radial-gradient(ellipse at center,rgba(224,64,251,.18) 0%,transparent 70%);opacity:0;transition:opacity .08s;}
#hit-flash.show{opacity:1;}
#bottom-bar{position:fixed;bottom:0;left:0;right:0;z-index:40;display:none;justify-content:space-between;align-items:center;padding:8px 28px;background:linear-gradient(0deg,rgba(5,8,15,.95) 0%,transparent 100%);border-top:1px solid rgba(224,64,251,.08);}
.acc-wrap{flex:1;max-width:300px;margin:0 auto;}
.acc-lbl{font-size:.52rem;letter-spacing:.3em;color:var(--dim);text-align:center;margin-bottom:3px;}
.acc-bg{height:3px;background:var(--border);border-radius:2px;overflow:hidden;}
.acc-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--green));border-radius:2px;transition:width .3s;width:0%;}
.quit-btn{background:none;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.62rem;letter-spacing:.2em;padding:5px 13px;cursor:pointer;transition:all .2s;}
.quit-btn:hover{border-color:var(--accent2);color:var(--accent2);}
#lives-hud{position:fixed;top:56px;right:24px;z-index:41;display:flex;gap:5px;}
.life{color:var(--accent2);font-size:1rem;transition:opacity .3s;}
.life.lost{opacity:.12;}
#combo-disp{position:fixed;top:68px;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:1rem;font-weight:700;letter-spacing:.3em;color:#ffd700;text-shadow:0 0 15px #ffd700;z-index:45;pointer-events:none;opacity:0;transition:opacity .3s;}
#combo-disp.show{opacity:1;}
.screen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;transition:opacity .3s;}
.screen.hidden{opacity:0;pointer-events:none;}
@keyframes glow{0%,100%{text-shadow:0 0 30px var(--accent),0 0 60px rgba(224,64,251,.3);}50%{text-shadow:0 0 50px var(--accent),0 0 100px rgba(224,64,251,.5);}}
#login-screen{gap:0;background:radial-gradient(ellipse at center,rgba(224,64,251,.06) 0%,transparent 70%);}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo h1{font-family:'Orbitron',monospace;font-size:clamp(2.5rem,6vw,4.5rem);font-weight:900;letter-spacing:.3em;color:var(--accent);animation:glow 3s ease-in-out infinite;}
.login-logo p{font-size:.68rem;letter-spacing:.5em;color:var(--dim);margin-top:6px;}
.auth-box{background:var(--panel);border:1px solid var(--border);padding:0;clip-path:polygon(0 0,calc(100% - 16px) 0,100% 16px,100% 100%,16px 100%,0 calc(100% - 16px));width:380px;overflow:hidden;}
.auth-tabs{display:flex;border-bottom:1px solid var(--border);}
.auth-tab{flex:1;background:none;border:none;color:var(--dim);font-family:'Orbitron',monospace;font-size:.62rem;letter-spacing:.25em;padding:14px 10px;cursor:pointer;transition:all .2s;position:relative;}
.auth-tab::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent);transform:scaleX(0);transition:transform .2s;}
.auth-tab.active{color:var(--accent);background:rgba(224,64,251,.05);}
.auth-tab.active::after{transform:scaleX(1);}
.auth-tab:hover:not(.active){color:var(--text);}
.auth-panel{padding:28px 32px;display:flex;flex-direction:column;gap:14px;}
.avatar-row{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}
.avatar-opt{font-size:1.4rem;cursor:pointer;padding:4px 8px;border:2px solid transparent;border-radius:8px;transition:all .15s;background:#030608;}
.avatar-opt:hover{border-color:var(--accent);transform:scale(1.1);}
.avatar-opt.selected{border-color:var(--accent);background:rgba(224,64,251,.15);transform:scale(1.15);}
.field-wrap{display:flex;flex-direction:column;gap:5px;}
.field-wrap label{font-size:.56rem;letter-spacing:.3em;color:var(--dim);}
.field-input-row{display:flex;align-items:center;gap:0;position:relative;}
.field-icon{position:absolute;left:12px;color:var(--dim);font-size:.9rem;pointer-events:none;z-index:1;}
.auth-input{background:#030608;border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.95rem;padding:11px 12px 11px 36px;outline:none;width:100%;transition:border-color .2s,box-shadow .2s;letter-spacing:.08em;}
.auth-input:focus{border-color:var(--accent);box-shadow:0 0 14px rgba(224,64,251,.18);}
.auth-input.no-icon{padding-left:12px;}
.pw-strength{height:2px;background:var(--border);margin-top:4px;border-radius:1px;overflow:hidden;}
.pw-strength-fill{height:100%;border-radius:1px;transition:width .3s,background .3s;width:0%;}
.auth-submit{background:var(--accent);border:none;color:#000;font-family:'Orbitron',monospace;font-size:.82rem;font-weight:900;letter-spacing:.2em;padding:13px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;width:100%;position:relative;overflow:hidden;}
.auth-submit:hover{box-shadow:0 0 30px rgba(224,64,251,.6);}
.auth-submit:disabled{opacity:.5;cursor:not-allowed;box-shadow:none;}
.auth-submit .btn-loader{display:none;position:absolute;inset:0;background:inherit;align-items:center;justify-content:center;}
.auth-submit.loading .btn-loader{display:flex;}
.auth-submit.loading .btn-text{opacity:0;}
@keyframes spin{to{transform:rotate(360deg);}}
.spinner{width:18px;height:18px;border:2px solid rgba(0,0,0,.3);border-top-color:#000;border-radius:50%;animation:spin .6s linear infinite;}
.auth-msg{font-size:.62rem;text-align:center;letter-spacing:.1em;min-height:16px;padding:2px 0;}
.auth-msg.error{color:var(--accent2);}
.auth-msg.success{color:var(--green);}
.auth-divider{display:flex;align-items:center;gap:10px;margin:2px 0;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.auth-divider span{font-size:.52rem;letter-spacing:.2em;color:var(--dim);}
#lb-screen{gap:0;justify-content:flex-start;padding-top:28px;overflow-y:auto;}
.lb-header{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;letter-spacing:.3em;color:var(--accent);margin-bottom:5px;text-align:center;}
.lb-sub{font-size:.6rem;letter-spacing:.3em;color:var(--dim);text-align:center;margin-bottom:18px;}
.lb-wrap{max-width:720px;width:100%;padding:0 20px;}
.lb-tabs{display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;justify-content:center;}
.lb-tab{background:var(--panel);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:.15em;padding:7px 13px;cursor:pointer;transition:all .15s;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);}
.lb-tab:hover{border-color:var(--accent);color:var(--accent);}
.lb-tab.active{background:var(--accent);color:#000;border-color:var(--accent);}
.lb-table{width:100%;border-collapse:collapse;}
.lb-table th{font-size:.53rem;letter-spacing:.3em;color:var(--dim);padding:8px 10px;text-align:left;border-bottom:1px solid var(--border);}
.lb-table td{padding:10px 10px;font-size:.73rem;border-bottom:1px solid rgba(13,32,64,.5);transition:background .15s;}
.lb-table tr:hover td{background:rgba(224,64,251,.04);}
.lb-rank{font-family:'Orbitron',monospace;font-weight:700;font-size:.82rem;}
.r1{color:#ffd700;text-shadow:0 0 10px #ffd700;}
.r2{color:#c0c0c0;text-shadow:0 0 8px #c0c0c0;}
.r3{color:#cd7f32;text-shadow:0 0 8px #cd7f32;}
.lb-player{display:flex;align-items:center;gap:8px;}
.lb-score-val{font-family:'Orbitron',monospace;color:var(--accent);font-weight:700;}
.lb-acc{color:var(--green);}
.lb-me td{background:rgba(224,64,251,.06)!important;}
.lb-loading,.lb-empty{text-align:center;color:var(--dim);font-size:.7rem;letter-spacing:.2em;padding:30px;}
.lb-footer{display:flex;gap:10px;justify-content:center;margin-top:18px;margin-bottom:28px;}
#stats-screen{gap:0;justify-content:flex-start;padding-top:26px;overflow-y:auto;}
.stats-hdr{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;letter-spacing:.3em;color:var(--accent);margin-bottom:16px;text-align:center;}
.stats-wrap{max-width:660px;width:100%;padding:0 20px;}
.profile-card{background:var(--panel);border:1px solid var(--border);padding:18px 22px;margin-bottom:14px;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));display:flex;align-items:center;gap:14px;}
.profile-avatar{font-size:2.4rem;}
.profile-info h2{font-family:'Orbitron',monospace;font-size:1rem;color:var(--text);letter-spacing:.1em;}
.profile-info p{font-size:.6rem;color:var(--dim);letter-spacing:.2em;margin-top:3px;}
.stats-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:12px;}
.st-card{background:var(--panel);border:1px solid var(--border);padding:13px;text-align:center;clip-path:polygon(0 0,calc(100% - 7px) 0,100% 7px,100% 100%,7px 100%,0 calc(100% - 7px));}
.st-val{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:700;color:var(--accent);margin-bottom:3px;}
.st-lbl{font-size:.54rem;letter-spacing:.2em;color:var(--dim);}
.mode-records{background:var(--panel);border:1px solid var(--border);padding:15px 18px;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));}
.mr-title{font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.3em;color:var(--accent);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.mr-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(13,32,64,.4);}
.mr-row:last-child{border-bottom:none;}
.mr-mode{font-size:.66rem;color:var(--text);}
.mr-score{font-family:'Orbitron',monospace;font-size:.78rem;color:var(--accent);font-weight:700;}
.mr-acc{font-size:.62rem;color:var(--green);}
.stats-footer{display:flex;gap:10px;justify-content:center;margin-top:16px;margin-bottom:28px;}
#menu-screen{gap:0;background:radial-gradient(ellipse at center,rgba(224,64,251,.04) 0%,transparent 70%);}
.logo{text-align:center;margin-bottom:20px;}
.logo h1{font-family:'Orbitron',monospace;font-size:clamp(2rem,5vw,4rem);font-weight:900;letter-spacing:.3em;color:var(--accent);animation:glow 3s ease-in-out infinite;}
.logo p{font-size:.7rem;letter-spacing:.5em;color:var(--dim);margin-top:5px;}
.sec-lbl{font-size:.58rem;letter-spacing:.4em;color:var(--dim);margin-bottom:12px;text-align:center;}
.modes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;max-width:880px;width:100%;padding:0 20px;margin-bottom:18px;}
.mode-card{background:var(--panel);border:1px solid var(--border);cursor:pointer;overflow:hidden;transition:all .2s;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));}
.mode-card:hover{transform:translateY(-3px);border-color:rgba(224,64,251,.4);}
.mode-card.selected{border-color:var(--accent);box-shadow:0 0 18px rgba(224,64,251,.25);}
.mode-prev{height:60px;background:#030608;position:relative;overflow:hidden;}
.mode-prev canvas{width:100%;height:100%;display:block;}
.mode-info{padding:8px 10px;}
.m-tag{font-size:.47rem;letter-spacing:.3em;color:var(--dim);margin-bottom:2px;}
.m-name{font-family:'Orbitron',monospace;font-size:.68rem;font-weight:700;color:var(--text);}
.mode-card.selected .m-name{color:var(--accent);}
.m-desc{font-size:.5rem;color:var(--dim);margin-top:2px;line-height:1.5;}
.bot-row{display:flex;gap:9px;align-items:center;flex-wrap:wrap;justify-content:center;max-width:880px;width:100%;padding:0 20px;}
.diff-btn{background:var(--panel);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.63rem;letter-spacing:.2em;padding:8px 16px;cursor:pointer;transition:all .15s;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);}
.diff-btn:hover{border-color:var(--accent);color:var(--accent);}
.diff-btn.act{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700;}
.diff-btn[data-d="easy"].act{background:var(--green);border-color:var(--green);}
.diff-btn[data-d="hard"].act{background:var(--accent2);border-color:var(--accent2);}
.start-btn{background:var(--accent);border:none;color:#000;font-family:'Orbitron',monospace;font-size:.8rem;font-weight:900;letter-spacing:.2em;padding:11px 30px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .15s;margin-left:8px;}
.start-btn:hover{box-shadow:0 0 28px rgba(224,64,251,.6);transform:scale(1.03);}
.cfg-btn{background:none;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:.15em;padding:8px 13px;cursor:pointer;transition:all .15s;}
.cfg-btn:hover{border-color:var(--accent3);color:var(--accent3);}
.menu-extra-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center;}
.extra-btn{background:var(--panel);border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.58rem;letter-spacing:.15em;padding:7px 13px;cursor:pointer;transition:all .15px;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);}
.extra-btn:hover{border-color:var(--accent3);color:var(--accent3);}
.user-badge{display:flex;align-items:center;gap:7px;background:var(--panel);border:1px solid rgba(224,64,251,.3);padding:7px 13px;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);}
.user-badge span{font-size:.63rem;color:var(--text);letter-spacing:.1em;}
#settings-screen{gap:0;justify-content:flex-start;padding-top:26px;overflow-y:auto;}
.cfg-hdr{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:900;letter-spacing:.3em;color:var(--accent);margin-bottom:16px;text-align:center;}
.cfg-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;max-width:700px;width:100%;padding:0 20px;}
.cfg-group{background:var(--panel);border:1px solid var(--border);padding:15px;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));}
.cg-title{font-family:'Orbitron',monospace;font-size:.55rem;letter-spacing:.3em;color:var(--accent);margin-bottom:11px;padding-bottom:5px;border-bottom:1px solid var(--border);}
.cfg-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px;}
.cfg-row:last-child{margin-bottom:0;}
.c-lbl{font-size:.64rem;color:var(--text);}
.c-sub{font-size:.52rem;color:var(--dim);display:block;margin-top:1px;}
.sl-wrap{display:flex;align-items:center;gap:5px;flex:1;justify-content:flex-end;}
input[type=range]{-webkit-appearance:none;height:3px;background:var(--border);border-radius:2px;outline:none;width:95px;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);cursor:pointer;border:2px solid var(--bg);}
.sv{font-family:'Orbitron',monospace;font-size:.66rem;color:var(--accent);min-width:30px;text-align:right;}
.toggle{position:relative;width:36px;height:20px;cursor:pointer;flex-shrink:0;}
.toggle input{display:none;}
.ttrack{position:absolute;inset:0;background:var(--border);border-radius:10px;border:1px solid var(--dim);transition:background .2s;}
.toggle input:checked~.ttrack{background:var(--accent);border-color:var(--accent);}
.tthumb{position:absolute;top:3px;left:3px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;}
.toggle input:checked~.tthumb{transform:translateX(16px);}
.color-opts{display:flex;gap:5px;}
.color-opt{width:17px;height:17px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .15s,border-color .15s;}
.color-opt:hover{transform:scale(1.2);}
.color-opt.active{border-color:#fff;transform:scale(1.15);}
.cfg-footer{margin-top:14px;display:flex;gap:11px;margin-bottom:26px;}
#results-screen{gap:20px;}
#results-screen h2{font-family:'Orbitron',monospace;font-size:1.5rem;font-weight:900;letter-spacing:.3em;color:var(--accent);text-shadow:0 0 20px var(--accent);}
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:480px;width:100%;padding:0 20px;}
.stat-card{background:var(--panel);border:1px solid var(--border);padding:12px;text-align:center;clip-path:polygon(0 0,calc(100% - 7px) 0,100% 7px,100% 100%,7px 100%,0 calc(100% - 7px));}
.s-val{font-family:'Orbitron',monospace;font-size:1.3rem;font-weight:700;color:var(--accent);margin-bottom:3px;}
.s-lbl{font-size:.54rem;letter-spacing:.2em;color:var(--dim);}
.grade{font-family:'Orbitron',monospace;font-size:3.6rem;font-weight:900;animation:glow 2s infinite;}
.btn-row{display:flex;gap:11px;}
.btn{font-family:'Orbitron',monospace;font-size:.7rem;letter-spacing:.15em;padding:11px 22px;border:none;cursor:pointer;clip-path:polygon(0 0,calc(100% - 8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100% - 8px));transition:all .2s;}
.btn-p{background:var(--accent);color:#000;font-weight:700;}
.btn-p:hover{box-shadow:0 0 25px var(--accent);}
.btn-s{background:transparent;color:var(--text);border:1px solid var(--border);}
.btn-s:hover{border-color:var(--accent);color:var(--accent);}
#lock-overlay{position:fixed;inset:0;z-index:80;background:rgba(5,8,15,.92);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;}
#lock-overlay h2{font-family:'Orbitron',monospace;font-size:1.3rem;letter-spacing:.2em;color:var(--accent);text-shadow:0 0 20px var(--accent);}
#lock-overlay p{font-size:.7rem;letter-spacing:.15em;color:var(--dim);text-align:center;line-height:1.8;}
.lock-btn{background:var(--accent);border:none;color:#000;font-family:'Orbitron',monospace;font-size:.85rem;font-weight:900;letter-spacing:.2em;padding:13px 36px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:box-shadow .2s;}
.lock-btn:hover{box-shadow:0 0 30px var(--accent);}
#pause-menu-btn:hover{border-color:var(--accent3)!important;color:var(--accent3)!important;}
#pause-quit-btn:hover{border-color:var(--accent2)!important;background:rgba(255,61,113,.08)!important;}
.room-card{background:var(--panel);border:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;clip-path:polygon(0 0,calc(100% - 7px) 0,100% 7px,100% 100%,7px 100%,0 calc(100% - 7px));transition:border-color .15s;}
.room-card:hover{border-color:rgba(255,61,113,.4);}
.room-nm{font-family:'Orbitron',monospace;font-size:.7rem;color:var(--text);}
.room-join{background:#ff3d71;border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.58rem;letter-spacing:.15em;padding:7px 14px;cursor:pointer;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);transition:box-shadow .15s;}
.room-join:hover{box-shadow:0 0 12px rgba(255,61,113,.5);}
.player-slot{background:rgba(255,255,255,.03);border:1px solid var(--border);padding:7px 12px;display:flex;align-items:center;gap:8px;clip-path:polygon(0 0,calc(100% - 5px) 0,100% 5px,100% 100%,5px 100%,0 calc(100% - 5px));}
#duel-chat-msgs::-webkit-scrollbar{width:4px;}
#duel-chat-msgs::-webkit-scrollbar-track{background:transparent;}
#duel-chat-msgs::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
@keyframes ping-pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.ping-bad{animation:ping-pulse .8s infinite;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.auth-panel{animation:slideIn .25s ease-out;}
#mobile-controls{position:fixed;inset:0;z-index:55;pointer-events:none;display:none;}
#mobile-controls.active{display:block;}
#joy-zone{position:absolute;left:0;bottom:0;width:50%;height:55%;pointer-events:all;}
#joy-base{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.2);transform:translate(-50%,-50%);display:none;transition:opacity .15s;}
#joy-knob{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(224,64,251,.7);box-shadow:0 0 18px rgba(224,64,251,.5);border:2px solid rgba(224,64,251,.9);transform:translate(-50%,-50%);display:none;transition:box-shadow .1s;}
#look-zone{position:absolute;right:0;bottom:0;width:50%;height:100%;pointer-events:all;}
#btn-fire{position:absolute;right:24px;bottom:90px;width:80px;height:80px;border-radius:50%;background:rgba(255,61,113,.25);border:3px solid rgba(255,61,113,.7);color:#ff3d71;font-size:1.8rem;display:flex;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;transition:all .1s;-webkit-tap-highlight-color:transparent;user-select:none;}
#btn-fire:active{background:rgba(255,61,113,.55);transform:scale(.9);box-shadow:0 0 24px rgba(255,61,113,.6);}
#btn-jump{position:absolute;right:120px;bottom:90px;width:60px;height:60px;border-radius:50%;background:rgba(0,229,255,.15);border:2px solid rgba(0,229,255,.5);color:#00e5ff;font-size:1.3rem;display:flex;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;transition:all .1s;-webkit-tap-highlight-color:transparent;user-select:none;}
#btn-jump:active{background:rgba(0,229,255,.4);transform:scale(.9);}
#btn-pause-mob{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(5,8,15,.75);border:1px solid rgba(224,64,251,.3);color:var(--accent);font-family:'Orbitron',monospace;font-size:.62rem;letter-spacing:.2em;padding:8px 16px;pointer-events:all;cursor:pointer;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);-webkit-tap-highlight-color:transparent;}
.mob-toggle-btn{background:rgba(0,229,255,.1);border:1px solid rgba(0,229,255,.4);color:var(--accent3);font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.2em;padding:10px 22px;cursor:pointer;clip-path:polygon(7px 0,100% 0,calc(100% - 7px) 100%,0 100%);transition:all .2s;-webkit-tap-highlight-color:transparent;}
.mob-toggle-btn:hover,.mob-toggle-btn:active{background:rgba(0,229,255,.25);box-shadow:0 0 18px rgba(0,229,255,.3);}
.mob-toggle-btn.on{background:rgba(0,229,255,.25);border-color:var(--accent3);box-shadow:0 0 14px rgba(0,229,255,.35);}
#duel-mobile-controls{position:fixed;inset:0;z-index:56;pointer-events:none;display:none;}
#duel-mobile-controls.active{display:block !important;}
</style>
</head>
<body>
<canvas id="three-canvas"></canvas>
<div id="crosshair"><div class="ch-line ch-top"></div><div class="ch-line ch-bottom"></div><div class="ch-line ch-left"></div><div class="ch-line ch-right"></div><div class="ch-dot"></div></div>
<div id="hit-flash"></div>
<div id="hud">
  <div class="hud-block"><span class="hud-lbl">PUNTUACI√ìN</span><span class="hud-val" id="score-val">0</span></div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
    <span class="hud-lbl">TIEMPO</span><span class="hud-val" id="timer-val">60</span>
    <span class="mode-tag" id="mode-tag">CLICKING</span>
  </div>
  <div class="hud-block"><span class="hud-lbl">DISPAROS / ACIERTOS</span><span class="hud-val" id="shots-val">0 / 0</span></div>
  <div class="hud-block" id="fps-block" style="position:fixed;top:12px;right:28px;text-align:right;"><span class="hud-lbl">FPS</span><span class="hud-val" id="fps-val" style="color:var(--green);font-size:1rem;">‚Äî</span></div>
</div>
<div id="lives-hud"><span class="life" id="lf1">‚ô•</span><span class="life" id="lf2">‚ô•</span><span class="life" id="lf3">‚ô•</span></div>
<div id="combo-disp">‚ú¶ COMBO x<span id="combo-num">0</span></div>
<div id="bottom-bar">
  <div style="font-size:.55rem;letter-spacing:.2em;color:var(--dim)">PRECISI√ìN</div>
  <div class="acc-wrap"><div class="acc-lbl">ACCURACY ¬∑ <span id="acc-pct">0</span>%</div><div class="acc-bg"><div class="acc-fill" id="acc-fill"></div></div></div>
  <button class="quit-btn" id="quit-btn">[ SALIR ]</button>
</div>
<div id="mobile-controls">
  <div id="joy-zone"><div id="joy-base"></div><div id="joy-knob"></div></div>
  <div id="look-zone"></div>
  <div id="btn-fire">üî¥</div>
  <div id="btn-jump">‚¨Ü</div>
  <button id="btn-pause-mob">‚è∏ PAUSA</button>
</div>
<div id="lock-overlay" style="display:none">
  <h2>üéØ INA TRAINER</h2>
  <p id="lock-hint">Mueve el mouse para apuntar<br>Clic izquierdo para disparar<br>Presiona <strong style="color:var(--accent)">ESC</strong> para pausar</p>
  <button class="lock-btn" id="lock-btn">üñ± CLIC PARA JUGAR</button>
  <button class="mob-toggle-btn" id="mob-toggle-btn" style="margin-top:4px">üì± MODO M√ìVIL</button>
  <div style="font-size:.56rem;letter-spacing:.2em;color:var(--dim);margin-top:6px">MODO: <span id="lock-mode-name" style="color:var(--accent)">‚Äî</span></div>
</div>
<div id="pause-overlay" style="display:none;position:fixed;inset:0;z-index:90;background:rgba(5,8,15,.88);backdrop-filter:blur(6px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:18px;">
  <div style="font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;letter-spacing:.4em;color:var(--accent);text-shadow:0 0 30px var(--accent);">‚è∏ PAUSA</div>
  <div style="font-size:.65rem;letter-spacing:.3em;color:var(--dim);">MODO: <span id="pause-mode-name" style="color:var(--accent)">‚Äî</span></div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:10px;">
    <button id="pause-resume-btn" class="lock-btn" style="width:240px;font-size:.8rem;">‚ñ∂ REANUDAR</button>
    <button id="pause-menu-btn" style="width:240px;background:none;border:1px solid var(--border);color:var(--dim);font-family:'Orbitron',monospace;font-size:.72rem;font-weight:700;letter-spacing:.2em;padding:13px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;">‚ò∞ IR AL MEN√ö</button>
    <button id="pause-quit-btn" style="width:240px;background:none;border:1px solid rgba(255,61,113,.35);color:var(--accent2);font-family:'Orbitron',monospace;font-size:.72rem;font-weight:700;letter-spacing:.2em;padding:13px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;">‚úï SALIR DE LA PARTIDA</button>
  </div>
  <div style="font-size:.54rem;letter-spacing:.25em;color:var(--dim);margin-top:6px;">Presiona <strong style="color:var(--accent)">ESC</strong> o haz clic en Reanudar para continuar</div>
</div>

<!-- LOGIN -->
<div class="screen" id="login-screen">
  <div class="login-logo"><h1>INA TRAINER</h1><p>ENTRENADOR FPS 3D ¬∑ COMPETITIVO</p></div>
  <div class="auth-box">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">‚ö° INICIAR SESI√ìN</button>
      <button class="auth-tab" id="tab-register" onclick="switchTab('register')">‚ú¶ REGISTRARSE</button>
    </div>
    <div class="auth-panel" id="panel-login">
      <div class="field-wrap"><label>USUARIO</label><div class="field-input-row"><span class="field-icon">‚óà</span><input class="auth-input" id="login-username" type="text" placeholder="Tu nombre de usuario" maxlength="20" autocomplete="username" autocorrect="off" autocapitalize="off"></div></div>
      <div class="field-wrap"><label>CONTRASE√ëA</label><div class="field-input-row"><span class="field-icon">üîí</span><input class="auth-input" id="login-password" type="password" placeholder="Tu contrase√±a" maxlength="40" autocomplete="current-password"></div></div>
      <div class="auth-msg" id="login-msg"></div>
      <button class="auth-submit" id="login-submit" onclick="doLogin()"><span class="btn-text">‚ñ∂ ENTRAR</span><div class="btn-loader"><div class="spinner"></div></div></button>
      <div class="auth-divider"><span>¬øA√∫n no tienes cuenta?</span></div>
      <button style="background:none;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:.15em;padding:9px;cursor:pointer;transition:all .2s;width:100%" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--dim)'" onclick="switchTab('register')">CREAR CUENTA GRATIS ‚Üí</button>
    </div>
    <div class="auth-panel" id="panel-register" style="display:none">
      <div class="field-wrap"><label>ELIGE TU AVATAR</label><div class="avatar-row" id="avatar-row"><span class="avatar-opt selected" data-av="üéØ">üéØ</span><span class="avatar-opt" data-av="üî´">üî´</span><span class="avatar-opt" data-av="‚ö°">‚ö°</span><span class="avatar-opt" data-av="üê∫">üê∫</span><span class="avatar-opt" data-av="ü¶ä">ü¶ä</span><span class="avatar-opt" data-av="üíÄ">üíÄ</span><span class="avatar-opt" data-av="üêâ">üêâ</span><span class="avatar-opt" data-av="ü§ñ">ü§ñ</span><span class="avatar-opt" data-av="üëæ">üëæ</span><span class="avatar-opt" data-av="üéÆ">üéÆ</span></div></div>
      <div class="field-wrap"><label>NOMBRE DE USUARIO <span style="color:var(--dim);font-size:.5rem">(m√≠n. 3 caracteres)</span></label><div class="field-input-row"><span class="field-icon">‚óà</span><input class="auth-input" id="reg-username" type="text" placeholder="Elige un nombre √∫nico" maxlength="20" autocomplete="off" autocorrect="off" autocapitalize="off" oninput="checkUsernameAvail()"></div><div style="font-size:.54rem;letter-spacing:.1em;min-height:14px;margin-top:2px" id="username-avail"></div></div>
      <div class="field-wrap"><label>CONTRASE√ëA <span style="color:var(--dim);font-size:.5rem">(m√≠n. 6 caracteres)</span></label><div class="field-input-row"><span class="field-icon">üîí</span><input class="auth-input" id="reg-password" type="password" placeholder="Elige una contrase√±a" maxlength="40" autocomplete="new-password" oninput="updatePwStrength()"></div><div class="pw-strength"><div class="pw-strength-fill" id="pw-strength-fill"></div></div></div>
      <div class="field-wrap"><label>CONFIRMAR CONTRASE√ëA</label><div class="field-input-row"><span class="field-icon">üîí</span><input class="auth-input" id="reg-confirm" type="password" placeholder="Repite la contrase√±a" maxlength="40" autocomplete="new-password"></div></div>
      <div class="auth-msg" id="register-msg"></div>
      <button class="auth-submit" id="register-submit" onclick="doRegister()"><span class="btn-text">‚ú¶ CREAR CUENTA</span><div class="btn-loader"><div class="spinner"></div></div></button>
    </div>
  </div>
</div>

<!-- LEADERBOARD -->
<div class="screen hidden" id="lb-screen">
  <div class="lb-header">üèÜ TABLA DE R√âCORDS</div><div class="lb-sub">MEJORES JUGADORES GLOBALES</div>
  <div class="lb-wrap">
    <div class="lb-tabs" id="lb-tabs"><button class="lb-tab active" data-mode="all">TODOS</button><button class="lb-tab" data-mode="clicking">CLICKING</button><button class="lb-tab" data-mode="flicking">FLICKING</button><button class="lb-tab" data-mode="micro">MICRO</button><button class="lb-tab" data-mode="gridshot">GRIDSHOT</button><button class="lb-tab" data-mode="strafe">STRAFE</button><button class="lb-tab" data-mode="wide">WIDE</button></div>
    <table class="lb-table"><thead><tr><th>#</th><th>JUGADOR</th><th>PUNTUACI√ìN</th><th>PRECISI√ìN</th><th>MODO</th><th>DIFICULTAD</th></tr></thead><tbody id="lb-body"><tr><td colspan="6" class="lb-loading">‚ü≥ CARGANDO...</td></tr></tbody></table>
    <div class="lb-footer"><button class="btn btn-s" id="lb-refresh-btn">‚Ü∫ ACTUALIZAR</button><button class="btn btn-p" id="lb-back-btn">‚Üê VOLVER</button></div>
  </div>
</div>

<!-- STATS -->
<div class="screen hidden" id="stats-screen">
  <div class="stats-hdr">üìä MIS ESTAD√çSTICAS</div>
  <div class="stats-wrap">
    <div class="profile-card"><div class="profile-avatar" id="profile-av">üéØ</div><div class="profile-info"><h2 id="profile-name">‚Äî</h2><p>JUGADOR INA TRAINER</p></div></div>
    <div class="stats-cards">
      <div class="st-card"><div class="st-val" id="st-games">0</div><div class="st-lbl">PARTIDAS</div></div>
      <div class="st-card"><div class="st-val" id="st-best">0</div><div class="st-lbl">MEJOR PUNTUACI√ìN</div></div>
      <div class="st-card"><div class="st-val" id="st-acc">0%</div><div class="st-lbl">PRECISI√ìN MEDIA</div></div>
      <div class="st-card"><div class="st-val" id="st-hits">0</div><div class="st-lbl">TOTAL ACIERTOS</div></div>
      <div class="st-card"><div class="st-val" id="st-shots">0</div><div class="st-lbl">TOTAL DISPAROS</div></div>
      <div class="st-card"><div class="st-val" id="st-combo">0</div><div class="st-lbl">MEJOR COMBO</div></div>
    </div>
    <div class="mode-records"><div class="mr-title">‚ú¶ R√âCORDS POR MODO</div><div id="mr-rows"></div></div>
    <div class="stats-footer"><button class="btn btn-p" id="stats-back-btn">‚Üê VOLVER</button></div>
  </div>
</div>

<!-- MENU -->
<div class="screen hidden" id="menu-screen">
  <div class="logo"><h1>INA TRAINER</h1><p>ENTRENADOR FPS 3D</p></div>
  <div id="menu-online-badge" style="display:flex;align-items:center;gap:7px;margin-bottom:6px;background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.2);padding:5px 14px;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%)">
    <span style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px #00ff88;display:inline-block;animation:ping-pulse 2s infinite"></span>
    <span style="font-size:.58rem;letter-spacing:.2em;color:#00ff88"><span id="menu-online-count">‚Äî</span> JUGANDO AHORA</span>
  </div>
  <div class="sec-lbl">‚Äî SELECCIONA MODO ‚Äî</div>
  <div class="modes-grid" id="modes-grid"></div>
  <div class="bot-row">
    <div class="sec-lbl" style="margin:0 6px 0 0">DIFICULTAD:</div>
    <button class="diff-btn" data-d="easy">F√ÅCIL</button>
    <button class="diff-btn act" data-d="medium">MEDIO</button>
    <button class="diff-btn" data-d="hard">DIF√çCIL</button>
    <button class="start-btn" id="start-btn">‚ñ∂ JUGAR</button>
    <button class="cfg-btn" id="open-cfg-btn">‚öô CFG</button>
  </div>
  <div class="menu-extra-row">
    <div class="user-badge"><span id="menu-user-av">üéØ</span><span id="menu-user-name">‚Äî</span></div>
    <button class="extra-btn" id="open-lb-btn">üèÜ R√âCORDS</button>
    <button class="extra-btn" id="open-stats-btn">üìä ESTAD√çSTICAS</button>
    <button class="extra-btn" id="open-friends-btn">üë• AMIGOS</button>
    <button class="extra-btn" id="logout-btn">‚èè CERRAR SESI√ìN</button>
  </div>
  <div class="menu-extra-row" style="margin-top:8px">
    <button id="open-1v1-btn" style="background:linear-gradient(135deg,#ff3d71,#e040fb);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.78rem;font-weight:900;letter-spacing:.2em;padding:11px 28px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;box-shadow:0 0 20px rgba(224,64,251,.3);">‚öî 1v1 ONLINE</button>
    <button id="open-zombie-btn" style="background:linear-gradient(135deg,#1a6622,#44cc22);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.78rem;font-weight:900;letter-spacing:.2em;padding:11px 28px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;box-shadow:0 0 20px rgba(68,204,34,.3);">üßü ZOMBIES</button>
    <button id="open-bots-btn" style="background:linear-gradient(135deg,#1a4a7a,#2277cc);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.78rem;font-weight:900;letter-spacing:.2em;padding:11px 28px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);transition:all .2s;box-shadow:0 0 20px rgba(34,119,204,.3);">ü§ñ VS BOTS</button>
    <button class="mob-toggle-btn" id="mob-toggle-menu-btn">üì± MODO M√ìVIL</button>
  </div>
</div>

<!-- FRIENDS SCREEN -->
<div class="screen hidden" id="friends-screen" style="max-width:480px;margin:auto;padding:24px 16px">
  <div style="font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;letter-spacing:.2em;color:var(--accent);margin-bottom:18px;text-align:center">üë• AMIGOS</div>
  <!-- Agregar amigo -->
  <div style="display:flex;gap:8px;margin-bottom:18px">
    <input id="friend-search-input" placeholder="Buscar usuario..." maxlength="20"
      style="flex:1;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);font-family:'Orbitron',monospace;font-size:.65rem;padding:9px 12px;outline:none;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%)">
    <button id="friend-search-btn"
      style="background:var(--accent);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.6rem;font-weight:900;letter-spacing:.12em;padding:9px 16px;cursor:pointer;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%)">BUSCAR</button>
  </div>
  <div id="friend-search-result" style="margin-bottom:14px;min-height:36px"></div>
  <!-- Solicitudes pendientes -->
  <div id="friend-requests-wrap" style="display:none;margin-bottom:16px">
    <div style="font-size:.52rem;letter-spacing:.2em;color:var(--dim);margin-bottom:6px">üì¨ SOLICITUDES PENDIENTES</div>
    <div id="friend-requests-list"></div>
  </div>
  <!-- Lista de amigos -->
  <div style="font-size:.52rem;letter-spacing:.2em;color:var(--dim);margin-bottom:8px">TUS AMIGOS <span id="friends-count" style="color:var(--accent)">0</span></div>
  <div id="friends-list" style="display:flex;flex-direction:column;gap:6px;max-height:340px;overflow-y:auto"></div>
  <div id="friends-empty" style="text-align:center;color:var(--dim);font-size:.6rem;padding:24px 0">No tienes amigos a√∫n ‚Äî ¬°busca uno!</div>
  <button id="friends-back-btn" style="margin-top:20px;width:100%;background:transparent;border:1px solid var(--border);color:var(--dim);font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.2em;padding:11px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)">‚Üê VOLVER</button>
</div>

<!-- BOTS LOBBY -->
<div class="screen hidden" id="bots-screen" style="max-width:460px;margin:auto;padding:24px 16px">
  <div style="font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;letter-spacing:.2em;color:#2277cc;margin-bottom:18px;text-align:center">ü§ñ PR√ÅCTICA VS BOTS</div>
  <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:22px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:.6rem;letter-spacing:.15em;color:var(--dim)">N√öMERO DE BOTS</span>
      <div style="display:flex;gap:6px">
        <button class="bot-count-btn" data-n="1" style="padding:5px 13px;background:rgba(34,119,204,.7);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.65rem;font-weight:900;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">1</button>
        <button class="bot-count-btn" data-n="2" style="padding:5px 13px;background:rgba(34,119,204,.35);border:1px solid rgba(34,119,204,.5);color:#fff;font-family:'Orbitron',monospace;font-size:.65rem;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">2</button>
        <button class="bot-count-btn" data-n="3" style="padding:5px 13px;background:rgba(34,119,204,.35);border:1px solid rgba(34,119,204,.5);color:#fff;font-family:'Orbitron',monospace;font-size:.65rem;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">3</button>
      </div>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:.6rem;letter-spacing:.15em;color:var(--dim)">DIFICULTAD</span>
      <div style="display:flex;gap:6px">
        <button class="bot-diff-btn" data-d="easy"   style="padding:5px 13px;background:rgba(34,204,34,.7);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.6rem;font-weight:900;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">F√ÅCIL</button>
        <button class="bot-diff-btn" data-d="medium" style="padding:5px 13px;background:rgba(255,170,0,.35);border:1px solid rgba(255,170,0,.5);color:#fff;font-family:'Orbitron',monospace;font-size:.6rem;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">MEDIO</button>
        <button class="bot-diff-btn" data-d="hard"   style="padding:5px 13px;background:rgba(255,61,61,.35);border:1px solid rgba(255,61,61,.5);color:#fff;font-family:'Orbitron',monospace;font-size:.6rem;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">DIF√çCIL</button>
      </div>
    </div>
    <div style="background:rgba(34,119,204,.08);border:1px solid rgba(34,119,204,.2);padding:10px 14px;font-size:.55rem;line-height:1.9;color:var(--dim)" id="bots-desc">
      <b style="color:#66aaff">F√ÅCIL</b> ‚Äî Los bots patrullan lentamente y tienen mala punter√≠a<br>
      <b style="color:#fff">1 BOT</b> ‚Äî Ideal para calentar, mapa PVP normal
    </div>
  </div>
  <button id="bots-start-btn" style="width:100%;background:linear-gradient(135deg,#1a4a7a,#2277cc);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.8rem;font-weight:900;letter-spacing:.2em;padding:14px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%);box-shadow:0 0 20px rgba(34,119,204,.4)">ü§ñ INICIAR PR√ÅCTICA</button>
  <button id="bots-back-btn" style="margin-top:10px;width:100%;background:transparent;border:1px solid var(--border);color:var(--dim);font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;letter-spacing:.2em;padding:11px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)">‚Üê VOLVER</button>
</div>

<!-- SETTINGS -->
<div class="screen hidden" id="settings-screen">
  <div class="cfg-hdr">‚öô CONFIGURACI√ìN</div>
  <div class="cfg-grid">
    <div class="cfg-group">
      <div class="cg-title">‚ú¶ MIRA</div>
      <div class="cfg-row"><span class="c-lbl">Color</span><div class="color-opts" id="ch-colors"><div class="color-opt active" data-c="#ffffff" style="background:#fff"></div><div class="color-opt" data-c="#00e5ff" style="background:#00e5ff"></div><div class="color-opt" data-c="#00ff88" style="background:#00ff88"></div><div class="color-opt" data-c="#ff3d71" style="background:#ff3d71"></div><div class="color-opt" data-c="#ffd700" style="background:#ffd700"></div><div class="color-opt" data-c="#e040fb" style="background:#e040fb"></div></div></div>
      <div class="cfg-row"><div><span class="c-lbl">Tama√±o</span></div><div class="sl-wrap"><input type="range" id="ch-size" min="6" max="24" value="12"><span class="sv" id="ch-size-v">12</span></div></div>
      <div class="cfg-row"><div><span class="c-lbl">Grosor</span></div><div class="sl-wrap"><input type="range" id="ch-thick" min="1" max="5" value="2"><span class="sv" id="ch-thick-v">2</span></div></div>
      <div class="cfg-row"><div><span class="c-lbl">Separaci√≥n</span></div><div class="sl-wrap"><input type="range" id="ch-gap" min="2" max="16" value="8"><span class="sv" id="ch-gap-v">8</span></div></div>
      <div class="cfg-row"><span class="c-lbl">Punto central</span><label class="toggle"><input type="checkbox" id="ch-dot" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
    </div>
    <div class="cfg-group">
      <div class="cg-title">üéÆ C√ÅMARA / JUEGO</div>
      <div class="cfg-row"><div><span class="c-lbl">Sensibilidad</span><span class="c-sub">Aplica a modo pr√°ctica Y PVP</span></div><div class="sl-wrap"><input type="range" id="sens-sl" min="1" max="100" value="30"><span class="sv" id="sens-v">3.0</span></div></div>
      <div class="cfg-row"><div><span class="c-lbl">Tama√±o objetivos</span></div><div class="sl-wrap"><input type="range" id="tgt-size" min="50" max="200" value="100" step="10"><span class="sv" id="tgt-size-v">1.0x</span></div></div>
      <div class="cfg-row"><div><span class="c-lbl">Velocidad</span></div><div class="sl-wrap"><input type="range" id="tgt-spd" min="50" max="300" value="100" step="10"><span class="sv" id="tgt-spd-v">1.0x</span></div></div>
      <div class="cfg-row"><div><span class="c-lbl">M√°x. objetivos</span></div><div class="sl-wrap"><input type="range" id="tgt-max" min="1" max="8" value="4"><span class="sv" id="tgt-max-v">4</span></div></div>
    </div>
    <div class="cfg-group">
      <div class="cg-title">‚óà VISUAL</div>
      <div class="cfg-row"><span class="c-lbl">Efectos de impacto</span><label class="toggle"><input type="checkbox" id="fx-tog" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Puntos flotantes</span><label class="toggle"><input type="checkbox" id="pts-tog" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Mostrar combo</span><label class="toggle"><input type="checkbox" id="combo-tog" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Color entorno</span><div class="color-opts" id="room-colors"><div class="color-opt active" data-c="#1a0a2e" style="background:#1a0a2e"></div><div class="color-opt" data-c="#0a1a2e" style="background:#0a1a2e"></div><div class="color-opt" data-c="#0a2e0a" style="background:#0a2e0a"></div><div class="color-opt" data-c="#1a1a1a" style="background:#1a1a1a"></div></div></div>
    </div>
    <div class="cfg-group">
      <div class="cg-title">‚ô™ AUDIO</div>
      <div class="cfg-row"><span class="c-lbl">Sonido disparo</span><label class="toggle"><input type="checkbox" id="snd-shot" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Sonido acierto</span><label class="toggle"><input type="checkbox" id="snd-hit" checked><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Sonido fallo</span><label class="toggle"><input type="checkbox" id="snd-miss"><div class="ttrack"></div><div class="tthumb"></div></label></div>
      <div class="cfg-row"><span class="c-lbl">Volumen</span><div class="sl-wrap"><input type="range" id="vol-sl" min="0" max="100" value="70"><span class="sv" id="vol-v">70%</span></div></div>
    </div>
  </div>
  <div class="cfg-footer"><button class="btn btn-s" id="cfg-reset">RESTABLECER</button><button class="btn btn-p" id="cfg-save">GUARDAR Y VOLVER</button></div>
</div>

<!-- RESULTS -->
<div class="screen hidden" id="results-screen">
  <h2>RESULTADOS</h2>
  <div class="grade" id="grade-el">‚Äî</div>
  <div class="stats-grid">
    <div class="stat-card"><div class="s-val" id="r-score">0</div><div class="s-lbl">PUNTUACI√ìN</div></div>
    <div class="stat-card"><div class="s-val" id="r-acc">0%</div><div class="s-lbl">PRECISI√ìN</div></div>
    <div class="stat-card"><div class="s-val" id="r-hits">0</div><div class="s-lbl">ACIERTOS</div></div>
    <div class="stat-card"><div class="s-val" id="r-misses">0</div><div class="s-lbl">FALLOS</div></div>
    <div class="stat-card"><div class="s-val" id="r-combo">0</div><div class="s-lbl">MEJOR COMBO</div></div>
    <div class="stat-card"><div class="s-val" id="r-mode">‚Äî</div><div class="s-lbl">MODO</div></div>
  </div>
  <div class="btn-row"><button class="btn btn-p" id="play-again-btn">JUGAR DE NUEVO</button><button class="btn btn-s" id="menu-btn">MEN√ö</button></div>
</div>

<!-- ONLINE SCREENS -->
<div class="screen hidden" id="duel-lobby-screen" style="gap:0;background:radial-gradient(ellipse at center,rgba(255,61,113,.07) 0%,transparent 70%)">
  <div class="login-logo">
    <h1 style="color:#ff3d71;animation:glow 3s ease-in-out infinite">‚öî ONLINE</h1>
    <p style="letter-spacing:.4em;color:var(--dim)">SALAS MULTIJUGADOR ¬∑ INA MAP</p>
    <div style="display:flex;align-items:center;gap:6px;margin-top:6px">
      <span style="width:7px;height:7px;border-radius:50%;background:#00ff88;box-shadow:0 0 6px #00ff88;display:inline-block;animation:ping-pulse 2s infinite"></span>
      <span style="font-size:.58rem;letter-spacing:.2em;color:#00ff88"><span id="lobby-online-count">‚Äî</span> JUGANDO AHORA</span>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
    <span id="lobby-conn-dot" style="width:8px;height:8px;border-radius:50%;background:#666;display:inline-block;transition:background .3s"></span>
    <span id="lobby-conn-label" style="font-size:.55rem;letter-spacing:.2em;color:var(--dim)">CONECTANDO...</span>
  </div>
  <div style="max-width:680px;width:100%;padding:0 20px">
    <div style="display:flex;gap:8px;margin-bottom:14px;justify-content:center;flex-wrap:wrap">
      <button class="login-btn" id="duel-open-create" style="background:#ff3d71;border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.78rem;font-weight:900;letter-spacing:.2em;padding:10px 24px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)">+ CREAR SALA</button>
      <button class="extra-btn" id="duel-refresh-rooms">&#8635; ACTUALIZAR</button>
      <button class="extra-btn" id="duel-lobby-back">&#8592; VOLVER</button>
    </div>
    <div id="duel-room-list" style="display:flex;flex-direction:column;gap:7px;max-height:50vh;overflow-y:auto;padding-right:4px"></div>
    <div class="auth-msg error" id="duel-lobby-err" style="margin-top:10px;text-align:center"></div>
  </div>
</div>

<div class="screen hidden" id="duel-create-screen" style="gap:0">
  <div class="auth-box" style="border-color:rgba(255,61,113,.3);width:410px">
    <div style="padding:20px 28px 0;font-family:'Orbitron',monospace;font-size:.88rem;letter-spacing:.25em;color:#ff3d71;text-align:center">&#10022; CREAR SALA</div>
    <div class="auth-panel" style="gap:12px">
      <div class="field-wrap"><label>NOMBRE DE LA SALA</label><input class="auth-input no-icon" id="duel-room-name" placeholder="Ej: La sala de ina..." maxlength="30" autocomplete="off"></div>
      <div class="field-wrap"><label>MODO DE JUEGO</label><div style="display:flex;gap:6px;flex-wrap:wrap" id="duel-mode-pills"><button class="diff-btn act" data-mode="1v1">1v1</button><button class="diff-btn" data-mode="2v2">2v2</button><button class="diff-btn" data-mode="3v3">3v3</button><button class="diff-btn" data-mode="4v4">4v4</button><button class="diff-btn" data-mode="ffa">FFA</button></div></div>
      <div class="field-wrap"><label style="display:flex;align-items:center;gap:10px;cursor:pointer"><label class="toggle" style="flex-shrink:0"><input type="checkbox" id="duel-is-private"><div class="ttrack"></div><div class="tthumb"></div></label>SALA PRIVADA (con contrase√±a)</label></div>
      <div class="field-wrap" id="duel-password-wrap" style="display:none"><label>CONTRASE√ëA</label><input class="auth-input no-icon" id="duel-room-password" type="password" placeholder="Contrase√±a..." maxlength="20"></div>
      <div class="auth-msg error" id="duel-create-err"></div>
      <button class="auth-submit" id="duel-do-create" style="background:#ff3d71"><span class="btn-text">&#9889; CREAR Y ENTRAR</span><div class="btn-loader"><div class="spinner"></div></div></button>
      <button style="background:none;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.6rem;letter-spacing:.15em;padding:9px;cursor:pointer;transition:all .2s;width:100%" id="duel-create-back-btn">&#8592; VOLVER</button>
    </div>
  </div>
</div>

<div class="screen hidden" id="duel-waiting-screen" style="gap:10px">
  <div style="font-family:'Orbitron',monospace;font-size:1.4rem;letter-spacing:.3em;color:#ff3d71;text-shadow:0 0 20px #ff3d71">&#9203; SALA DE ESPERA</div>
  <div id="duel-room-info" style="font-size:.6rem;letter-spacing:.2em;color:var(--dim)"></div>
  <div id="duel-players-in-room" style="display:flex;flex-direction:column;gap:5px;min-width:320px;max-width:500px;width:90%"></div>
  <div style="font-size:.55rem;letter-spacing:.2em;color:var(--dim);margin-top:2px">COMPARTE EL LINK:</div>
  <div id="duel-share-url" style="font-size:.6rem;color:var(--accent3);background:rgba(0,229,255,.06);border:1px solid rgba(0,229,255,.2);padding:10px 18px;max-width:520px;word-break:break-all;text-align:center">cargando...</div>
  <div style="width:100%;max-width:500px">
    <div style="font-size:.5rem;letter-spacing:.25em;color:var(--dim);margin-bottom:5px">üí¨ CHAT DE SALA</div>
    <div id="duel-chat-msgs" style="background:rgba(5,8,15,.85);border:1px solid var(--border);height:100px;overflow-y:auto;padding:8px 10px;display:flex;flex-direction:column;gap:3px;margin-bottom:6px;clip-path:polygon(0 0,calc(100% - 6px) 0,100% 6px,100% 100%,6px 100%,0 calc(100% - 6px))"></div>
    <div style="display:flex;gap:6px">
      <input id="duel-chat-input" class="auth-input no-icon" style="flex:1;padding:8px 11px;font-size:.65rem" placeholder="Escribe algo..." maxlength="80" autocomplete="off">
      <button onclick="onSendChat()" style="background:rgba(255,61,113,.15);border:1px solid rgba(255,61,113,.4);color:#ff3d71;font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;padding:8px 13px;cursor:pointer;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%);transition:all .15s;letter-spacing:.1em" onmouseover="this.style.background='rgba(255,61,113,.3)'" onmouseout="this.style.background='rgba(255,61,113,.15)'">ENVIAR</button>
    </div>
  </div>
  <div style="display:flex;gap:8px;margin-top:4px">
    <button class="auth-submit" id="duel-force-start" style="background:#ff3d71;width:auto;padding:10px 20px;display:none;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)">&#9654; INICIAR PARTIDA</button>
    <button class="btn btn-s" id="duel-waiting-back">&#10005; SALIR</button>
  </div>
</div>

<div class="screen hidden" id="duel-gameover-screen" style="gap:18px">
  <div id="duel-go-title" style="font-family:'Orbitron',monospace;font-size:3.2rem;font-weight:900"></div>
  <div id="duel-go-vs" style="font-size:.72rem;letter-spacing:.2em;color:var(--dim)"></div>
  <div id="duel-go-score" style="font-family:'Orbitron',monospace;font-size:1.6rem;font-weight:700;color:var(--accent)"></div>
  <div style="display:flex;gap:10px;margin-top:8px">
    <button class="auth-submit" id="duel-rematch-btn" style="width:200px;background:#ff3d71">‚Ü∫ REVANCHA</button>
    <button style="width:200px;background:transparent;border:1px solid var(--border);color:var(--text);font-family:'Orbitron',monospace;font-size:.72rem;font-weight:700;letter-spacing:.2em;padding:13px;cursor:pointer;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)" id="duel-menu-btn">‚ò∞ MEN√ö</button>
  </div>
</div>

<!-- 1v1 CANVAS + HUD -->
<canvas id="duel-canvas" style="position:fixed;inset:0;display:none;cursor:none;z-index:5"></canvas>
<div id="duel-crosshair" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:50;display:none">
  <div style="width:20px;height:2px;background:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"></div>
  <div style="width:2px;height:20px;background:#fff;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"></div>
  <div style="width:3px;height:3px;background:#fff;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"></div>
</div>
<div id="duel-hit-flash" style="position:fixed;inset:0;background:radial-gradient(ellipse at center,rgba(255,61,113,.35) 0%,transparent 70%);pointer-events:none;z-index:52;opacity:0;transition:opacity .08s"></div>
<div id="duel-death-vignette" style="position:fixed;inset:0;background:rgba(255,0,0,.25);pointer-events:none;z-index:53;display:none"></div>
<div id="duel-respawn-msg" style="position:fixed;top:56%;left:50%;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:1.1rem;letter-spacing:.3em;color:#ff3d71;text-shadow:0 0 14px #ff3d71;z-index:60;display:none">üíÄ REAPARECIENDO...</div>
<div id="duel-kill-notif" style="position:fixed;top:42%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:60;opacity:0;transition:opacity .15s;text-align:center">
  <div style="font-family:'Orbitron',monospace;font-size:2.2rem;font-weight:900;color:var(--green);text-shadow:0 0 20px var(--green)">¬°ELIMINADO!</div>
  <div style="font-size:.62rem;letter-spacing:.3em;color:var(--dim)">+1 KILL</div>
</div>
<div id="duel-hud" style="position:fixed;inset:0;pointer-events:none;z-index:40;display:none">
  <div style="position:absolute;top:14px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:16px;background:rgba(5,8,15,.88);border:1px solid rgba(255,61,113,.2);padding:10px 22px;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))">
    <div style="text-align:center"><div style="font-size:.48rem;letter-spacing:.2em;color:var(--dim)" id="duel-my-name-hud">YO</div><div style="font-family:'Orbitron',monospace;font-size:2.4rem;font-weight:900;color:#ff4444;text-shadow:0 0 12px #ff4444;line-height:1" id="duel-my-kills">0</div></div>
    <div style="text-align:center;color:var(--dim);font-size:.7rem">‚öî<br><span style="font-size:.4rem;letter-spacing:.2em">FIRST TO <span id="duel-firstto">6</span></span></div>
    <div style="text-align:center"><div style="font-size:.48rem;letter-spacing:.2em;color:var(--dim)" id="duel-opp-name-hud">RIVAL</div><div style="font-family:'Orbitron',monospace;font-size:2.4rem;font-weight:900;color:#4488ff;text-shadow:0 0 12px #4488ff;line-height:1" id="duel-opp-kills">0</div></div>
  </div>
  <div style="position:absolute;bottom:14px;left:16px;font-size:.55rem;letter-spacing:.15em;color:var(--dim)">EQUIPO: <span id="duel-team-label" style="font-weight:700">‚Äî</span></div>
  <div style="position:absolute;top:14px;right:16px;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
    <div style="font-family:'Orbitron',monospace;font-size:.75rem;color:var(--green)" id="duel-fps-hud">‚Äî FPS</div>
    <div style="font-family:'Orbitron',monospace;font-size:.75rem" id="duel-ping-hud">‚Äî MS</div>
    <div id="duel-conn-quality" style="font-size:.48rem;letter-spacing:.15em;padding:2px 7px;border-radius:3px;background:rgba(58,74,106,.3);color:var(--dim)">‚óè ‚Äî</div>
  </div>
  <div id="duel-kill-feed" style="position:absolute;top:82px;right:14px;display:flex;flex-direction:column;gap:4px"></div>
  <!-- BARRA DE SALUD PROPIA -->
  <div style="position:absolute;bottom:54px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:4px">
    <div style="display:flex;align-items:center;gap:8px">
      <span style="font-size:.5rem;letter-spacing:.2em;color:#ff4444">‚ù§ SALUD</span>
      <span id="duel-hp-num" style="font-family:'Orbitron',monospace;font-size:.75rem;font-weight:700;color:#ff4444">100</span>
    </div>
    <div style="width:200px;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;border:1px solid rgba(255,68,68,.3)">
      <div id="duel-hp-bar" style="height:100%;width:100%;background:linear-gradient(90deg,#ff4444,#ff6644);border-radius:4px;transition:width .15s,background .3s"></div>
    </div>
  </div>
  <!-- BARRA DE SALUD RIVAL (solo 1v1) -->
  <div id="duel-opp-hp-hud" style="position:absolute;top:80px;left:50%;transform:translateX(-50%);display:none;flex-direction:column;align-items:center;gap:3px">
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:.42rem;letter-spacing:.2em;color:#4488ff" id="duel-opp-hp-label">RIVAL</span>
      <span id="duel-opp-hp-num" style="font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;color:#4488ff">100</span>
    </div>
    <div style="width:160px;height:6px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;border:1px solid rgba(68,136,255,.3)">
      <div id="duel-opp-hp-bar" style="height:100%;width:100%;background:linear-gradient(90deg,#4488ff,#88ccff);border-radius:4px;transition:width .2s,background .3s"></div>
    </div>
  </div>
  <!-- HP DEL RIVAL (1v1) -->
  <div id="duel-opp-hp-wrap" style="position:absolute;top:54px;right:16px;display:none;flex-direction:column;align-items:flex-end;gap:3px">
    <div style="display:flex;align-items:center;gap:6px">
      <span id="duel-opp-hp-num" style="font-family:'Orbitron',monospace;font-size:.7rem;font-weight:700;color:#ff4444">100</span>
      <span style="font-size:.45rem;letter-spacing:.2em;color:#ff6644">‚ù§ RIVAL</span>
    </div>
    <div style="width:160px;height:7px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;border:1px solid rgba(255,68,68,.25)">
      <div id="duel-opp-hp-bar" style="height:100%;width:100%;background:linear-gradient(90deg,#ff2200,#ff6644);border-radius:3px;transition:width .2s,background .3s"></div>
    </div>
  </div>
  <!-- ARMA ACTUAL + MUNICI√ìN -->
  <div id="duel-weapon-hud" style="position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:14px">
    <div style="display:flex;gap:6px" id="duel-weapon-slots"></div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:2px">
      <span id="duel-weapon-name" style="font-family:'Orbitron',monospace;font-size:.6rem;font-weight:700;letter-spacing:.2em;color:#fff">PISTOLA</span>
      <span id="duel-ammo-hud" style="font-family:'Orbitron',monospace;font-size:.85rem;font-weight:900;color:var(--accent3)">12 / 12</span>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;gap:2px;border-left:1px solid rgba(255,255,255,.15);padding-left:12px">
      <span style="font-size:.45rem;letter-spacing:.15em;color:var(--dim)">GRANADAS</span>
      <span id="duel-gren-hud" style="font-size:.8rem">üí£üí£</span>
    </div>
  </div>
  <div style="position:absolute;bottom:14px;right:16px;font-size:.48rem;letter-spacing:.12em;color:var(--dim);text-align:right;line-height:1.8">1/2/3 ARMA ¬∑ R RECARGAR ¬∑ G GRANADA ¬∑ ESPACIO SALTAR</div>
</div>

<div id="duel-mobile-controls">
  <div id="duel-joy-zone" style="position:absolute;left:0;bottom:0;width:50%;height:55%;pointer-events:all;"></div>
  <div id="duel-joy-base" style="position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08);border:2px solid rgba(255,61,113,.4);transform:translate(-50%,-50%);display:none;"></div>
  <div id="duel-joy-knob" style="position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,61,113,.7);box-shadow:0 0 18px rgba(255,61,113,.5);border:2px solid rgba(255,61,113,.9);transform:translate(-50%,-50%);display:none;"></div>
  <div id="duel-look-zone" style="position:absolute;right:0;bottom:0;width:50%;height:100%;pointer-events:all;"></div>
  <div id="duel-btn-fire" style="position:absolute;right:24px;bottom:90px;width:80px;height:80px;border-radius:50%;background:rgba(255,61,113,.25);border:3px solid rgba(255,61,113,.7);color:#ff3d71;font-size:1.8rem;display:flex;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;">üî¥</div>
  <div id="duel-btn-jump" style="position:absolute;right:120px;bottom:90px;width:60px;height:60px;border-radius:50%;background:rgba(0,229,255,.15);border:2px solid rgba(0,229,255,.5);color:#00e5ff;font-size:1.3rem;display:flex;align-items:center;justify-content:center;pointer-events:all;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;">‚¨Ü</div>
  <button id="duel-btn-pause-mob" style="position:absolute;top:80px;left:50%;transform:translateX(-50%);background:rgba(5,8,15,.75);border:1px solid rgba(255,61,113,.3);color:#ff3d71;font-family:'Orbitron',monospace;font-size:.62rem;letter-spacing:.2em;padding:8px 16px;pointer-events:all;cursor:pointer;clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);-webkit-tap-highlight-color:transparent;">‚è∏ PAUSA</button>
  <button class="mob-toggle-btn" id="mob-toggle-duel-btn" style="position:absolute;top:14px;right:14px;padding:6px 12px;font-size:.52rem;pointer-events:all;">üì±</button>
</div>

<div id="duel-lock-screen" style="position:fixed;inset:0;z-index:80;background:rgba(5,8,15,.92);display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px">
  <div style="font-family:'Orbitron',monospace;font-size:1.5rem;letter-spacing:.3em;color:#ff3d71;text-shadow:0 0 20px #ff3d71">‚öî 1v1 ¬∑ INA MAP</div>
  <div style="font-size:.68rem;letter-spacing:.13em;color:var(--dim);text-align:center;line-height:2">VS <strong id="duel-opp-name-lock" style="color:#ff3d71">Rival</strong><br><strong style="color:var(--accent)">WASD</strong> mover ¬∑ <strong style="color:var(--accent)">MOUSE</strong> apuntar ¬∑ <strong style="color:var(--accent)">CLIC</strong> disparar ¬∑ <strong style="color:var(--accent)">ESPACIO</strong> saltar ¬∑ <strong style="color:var(--accent)">ESC</strong> pausar</div>
  <button class="lock-btn" id="duel-lock-btn" style="background:#ff3d71">üñ± CLIC PARA JUGAR</button>
  <button class="mob-toggle-btn" id="mob-toggle-duel-btn-lock" style="margin-top:2px">üì± MODO M√ìVIL</button>
  <div style="font-size:.52rem;letter-spacing:.2em;color:var(--dim)" id="duel-lock-team">‚Äî</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
// SUPABASE
// ============================================================
const SUPABASE_URL = 'https://rcybdbmdxtmshljxkdid.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjeWJkYm1keHRtc2hsanhrZGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5Nzk1MDgsImV4cCI6MjA4NzU1NTUwOH0.kAe0HhfIwFbB49VP6jd8n7yUqH5Nhem-0OQuEsW-Nc8';
const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================================
// AUTH
// ============================================================
let currentUser = null;
let selectedAvatar = 'üéØ';
let usernameCheckTimer = null;

async function hashPassword(pw) {
  const enc = new TextEncoder();
  const data = enc.encode('inatrainer_2025_' + pw);
  const buf  = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function loadSession() {
  try { const s = localStorage.getItem('ina_session'); if (s) currentUser = JSON.parse(s); } catch(e) {}
}
function saveSession() {
  try { localStorage.setItem('ina_session', JSON.stringify(currentUser)); } catch(e) {}
}
function clearSession() {
  currentUser = null;
  try { localStorage.removeItem('ina_session'); } catch(e) {}
}

loadSession();

function switchTab(tab) {
  document.getElementById('tab-login').classList.toggle('active', tab === 'login');
  document.getElementById('tab-register').classList.toggle('active', tab === 'register');
  document.getElementById('panel-login').style.display    = tab === 'login'    ? 'flex' : 'none';
  document.getElementById('panel-register').style.display = tab === 'register' ? 'flex' : 'none';
  document.getElementById('login-msg').textContent = '';
  document.getElementById('register-msg').textContent = '';
}

document.querySelectorAll('.avatar-opt').forEach(o => o.addEventListener('click', () => {
  document.querySelectorAll('.avatar-opt').forEach(x => x.classList.remove('selected'));
  o.classList.add('selected');
  selectedAvatar = o.dataset.av;
}));

function updatePwStrength() {
  const pw = document.getElementById('reg-password').value;
  const fill = document.getElementById('pw-strength-fill');
  let score = 0;
  if (pw.length >= 6)  score++;
  if (pw.length >= 10) score++;
  if (/[A-Z]/.test(pw) || /[0-9]/.test(pw)) score++;
  if (/[^a-zA-Z0-9]/.test(pw)) score++;
  const colors = ['#ff3d71','#ff9500','#ffd700','#00ff88'];
  const widths  = ['25%','50%','75%','100%'];
  fill.style.width      = pw.length ? widths[score-1] || '10%' : '0%';
  fill.style.background = pw.length ? colors[score-1] || '#ff3d71' : 'transparent';
}

function checkUsernameAvail() {
  const el  = document.getElementById('username-avail');
  const val = document.getElementById('reg-username').value.trim();
  el.textContent = '';
  if (val.length < 3) return;
  clearTimeout(usernameCheckTimer);
  el.style.color = 'var(--dim)';
  el.textContent = '‚ü≥ Verificando...';
  usernameCheckTimer = setTimeout(async () => {
    try {
      const { data } = await sbClient.from('game_users').select('id').eq('username', val.toLowerCase()).limit(1);
      if (data && data.length > 0) {
        el.style.color = 'var(--accent2)';
        el.textContent = '‚úó Nombre no disponible';
      } else {
        el.style.color = 'var(--green)';
        el.textContent = '‚úì Nombre disponible';
      }
    } catch(e) { el.textContent = ''; }
  }, 500);
}

function setBtnLoading(id, loading) {
  const btn = document.getElementById(id);
  btn.classList.toggle('loading', loading);
  btn.disabled = loading;
}

async function doRegister() {
  const msgEl    = document.getElementById('register-msg');
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const confirm  = document.getElementById('reg-confirm').value;
  msgEl.className = 'auth-msg'; msgEl.textContent = '';
  if (username.length < 3) { showAuthMsg('register', 'El nombre debe tener al menos 3 caracteres', true); return; }
  if (!/^[a-zA-Z0-9_\-\.]+$/.test(username)) { showAuthMsg('register', 'Solo letras, n√∫meros, _ - .', true); return; }
  if (password.length < 6) { showAuthMsg('register', 'La contrase√±a debe tener al menos 6 caracteres', true); return; }
  if (password !== confirm) { showAuthMsg('register', 'Las contrase√±as no coinciden', true); return; }
  setBtnLoading('register-submit', true);
  try {
    const { data: existing } = await sbClient.from('game_users').select('id').eq('username', username.toLowerCase()).limit(1);
    if (existing && existing.length > 0) { showAuthMsg('register', '‚ö† Ese nombre de usuario ya est√° en uso', true); setBtnLoading('register-submit', false); return; }
    const hash = await hashPassword(password);
    const { data, error } = await sbClient.from('game_users').insert({ username: username.toLowerCase(), display_name: username, password_hash: hash, avatar: selectedAvatar, created_at: new Date().toISOString() }).select().single();
    if (error) throw error;
    currentUser = { id: data.id, name: data.display_name, avatar: data.avatar };
    saveSession();
    showAuthMsg('register', '‚úì ¬°Cuenta creada! Entrando...', false);
    setTimeout(showMenu, 800);
  } catch(e) { console.error(e); showAuthMsg('register', '‚ö† Error al crear cuenta. Int√©ntalo de nuevo.', true); }
  setBtnLoading('register-submit', false);
}

async function doLogin() {
  const msgEl    = document.getElementById('login-msg');
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  msgEl.textContent = '';
  if (!username || !password) { showAuthMsg('login', '‚ö† Rellena todos los campos', true); return; }
  setBtnLoading('login-submit', true);
  try {
    const hash = await hashPassword(password);
    const { data, error } = await sbClient.from('game_users').select('id, display_name, avatar, password_hash').eq('username', username.toLowerCase()).single();
    if (error || !data) { showAuthMsg('login', '‚ö† Usuario no encontrado', true); setBtnLoading('login-submit', false); return; }
    if (data.password_hash !== hash) { showAuthMsg('login', '‚ö† Contrase√±a incorrecta', true); setBtnLoading('login-submit', false); return; }
    currentUser = { id: data.id, name: data.display_name, avatar: data.avatar };
    saveSession();
    showAuthMsg('login', '‚úì ¬°Bienvenido ' + data.display_name + '!', false);
    setTimeout(showMenu, 600);
  } catch(e) { console.error(e); showAuthMsg('login', '‚ö† Error de conexi√≥n. Int√©ntalo de nuevo.', true); }
  setBtnLoading('login-submit', false);
}

function showAuthMsg(panel, text, isError) {
  const el = document.getElementById(panel + '-msg');
  el.className = 'auth-msg ' + (isError ? 'error' : 'success');
  el.textContent = text;
}

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const loginPanel = document.getElementById('panel-login');
  const regPanel   = document.getElementById('panel-register');
  if (loginPanel && loginPanel.style.display !== 'none' &&
     (document.activeElement === document.getElementById('login-username') ||
      document.activeElement === document.getElementById('login-password'))) { doLogin(); }
  if (regPanel && regPanel.style.display !== 'none' &&
      document.activeElement === document.getElementById('reg-confirm')) { doRegister(); }
});

// ‚îÄ‚îÄ showMenu: carga config del perfil al entrar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showMenu() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('menu-screen').classList.remove('hidden');
  document.getElementById('menu-user-av').textContent   = currentUser.avatar;
  document.getElementById('menu-user-name').textContent = currentUser.name.toUpperCase();
  // Cargar configuraci√≥n guardada del jugador desde Supabase
  loadMyConfig();
}

document.getElementById('logout-btn').addEventListener('click', () => {
  clearSession();
  document.getElementById('menu-screen').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('login-username').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-msg').textContent = '';
});

if (currentUser) showMenu();

// ============================================================
// STORAGE ‚Äî Stats en Supabase
// ============================================================
async function getMyStats() {
  if (!currentUser) return null;
  try {
    const { data } = await sbClient.from('player_stats').select('*').eq('user_id', currentUser.id).single();
    return data || { games:0, total_hits:0, total_shots:0, best_score:0, best_combo:0, mode_records:{} };
  } catch(e) { return { games:0, total_hits:0, total_shots:0, best_score:0, best_combo:0, mode_records:{} }; }
}

async function saveMyStats(stats) {
  if (!currentUser) return;
  try {
    await sbClient.from('player_stats').upsert({ user_id: currentUser.id, games: stats.games, total_hits: stats.total_hits, total_shots: stats.total_shots, best_score: stats.best_score, best_combo: stats.best_combo, mode_records: stats.mode_records, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
  } catch(e) { console.warn('saveMyStats:', e); }
}

async function submitScore(scoreData) {
  if (!currentUser || scoreData.score <= 0) return;
  try {
    await sbClient.from('scores').insert({ user_id: currentUser.id, name: currentUser.name, avatar: currentUser.avatar, score: scoreData.score, accuracy: scoreData.acc || 0, hits: scoreData.hits || 0, shots: scoreData.shots || 0, combo: scoreData.combo || 0, mode: scoreData.mode, difficulty: scoreData.diff || 'medium' });
    const stats = await getMyStats();
    stats.games++; stats.total_hits += scoreData.hits || 0; stats.total_shots += scoreData.shots || 0;
    if (scoreData.score > stats.best_score) stats.best_score = scoreData.score;
    if ((scoreData.combo||0) > stats.best_combo) stats.best_combo = scoreData.combo || 0;
    if (!stats.mode_records) stats.mode_records = {};
    const mr = stats.mode_records[scoreData.mode];
    if (!mr || scoreData.score > mr.score) stats.mode_records[scoreData.mode] = { score: scoreData.score, acc: scoreData.acc };
    await saveMyStats(stats);
  } catch(e) { console.warn('submitScore:', e); }
}

// ============================================================
// CONFIG PERSISTENTE ‚Äî Guardar y cargar en Supabase
// ============================================================
async function saveMyConfig() {
  if (!currentUser) return;
  try {
    const cfgData = {
      ch:   { ...CFG.ch },
      sens: CFG.sens,
      tgt:  { ...CFG.tgt },
      vis:  { ...CFG.vis },
      snd:  { ...CFG.snd },
      room: { ...CFG.room }
    };
    await sbClient.from('player_stats').upsert(
      { user_id: currentUser.id, user_config: cfgData, updated_at: new Date().toISOString() },
      { onConflict: 'user_id' }
    );
    console.log('‚úì Config guardada en perfil');
  } catch(e) { console.warn('saveMyConfig:', e); }
}

async function loadMyConfig() {
  if (!currentUser) return;
  try {
    const { data } = await sbClient.from('player_stats').select('user_config').eq('user_id', currentUser.id).single();
    if (data && data.user_config) {
      const c = data.user_config;
      if (c.ch)         Object.assign(CFG.ch,  c.ch);
      if (c.sens != null) CFG.sens = c.sens;
      if (c.tgt)        Object.assign(CFG.tgt, c.tgt);
      if (c.vis)        Object.assign(CFG.vis, c.vis);
      if (c.snd)        Object.assign(CFG.snd, c.snd);
      if (c.room)       Object.assign(CFG.room, c.room);
      // Aplicar al DOM de configuraci√≥n
      applyCfgToDOM();
      applyCH();
      console.log('‚úì Config cargada del perfil');
    }
  } catch(e) { console.warn('loadMyConfig:', e); }
}

// Aplica los valores de CFG a todos los controles del panel de config
function applyCfgToDOM() {
  // Mira
  const sz=document.getElementById('ch-size');   if(sz){sz.value=CFG.ch.size;  document.getElementById('ch-size-v').textContent=CFG.ch.size;}
  const th=document.getElementById('ch-thick');  if(th){th.value=CFG.ch.thick; document.getElementById('ch-thick-v').textContent=CFG.ch.thick;}
  const gp=document.getElementById('ch-gap');    if(gp){gp.value=CFG.ch.gap;   document.getElementById('ch-gap-v').textContent=CFG.ch.gap;}
  const dt=document.getElementById('ch-dot');    if(dt) dt.checked=CFG.ch.dot;
  document.querySelectorAll('#ch-colors .color-opt').forEach(o=>o.classList.toggle('active',o.dataset.c===CFG.ch.color));
  // C√°mara/juego
  const sn=document.getElementById('sens-sl');   if(sn){sn.value=Math.round(CFG.sens*10); document.getElementById('sens-v').textContent=CFG.sens.toFixed(1);}
  const ts=document.getElementById('tgt-size');  if(ts){ts.value=Math.round(CFG.tgt.sizeMult*100);  document.getElementById('tgt-size-v').textContent=CFG.tgt.sizeMult.toFixed(1)+'x';}
  const tp=document.getElementById('tgt-spd');   if(tp){tp.value=Math.round(CFG.tgt.speedMult*100); document.getElementById('tgt-spd-v').textContent=CFG.tgt.speedMult.toFixed(1)+'x';}
  const tm=document.getElementById('tgt-max');   if(tm){tm.value=CFG.tgt.max; document.getElementById('tgt-max-v').textContent=CFG.tgt.max;}
  // Visual
  const fx=document.getElementById('fx-tog');    if(fx) fx.checked=CFG.vis.fx;
  const pt=document.getElementById('pts-tog');   if(pt) pt.checked=CFG.vis.pts;
  const cb=document.getElementById('combo-tog'); if(cb) cb.checked=CFG.vis.combo;
  document.querySelectorAll('#room-colors .color-opt').forEach(o=>o.classList.toggle('active',o.dataset.c===CFG.room.color));
  // Audio
  const sh=document.getElementById('snd-shot');  if(sh) sh.checked=CFG.snd.shot;
  const hi=document.getElementById('snd-hit');   if(hi) hi.checked=CFG.snd.hit;
  const ms=document.getElementById('snd-miss');  if(ms) ms.checked=CFG.snd.miss;
  const vl=document.getElementById('vol-sl');    if(vl){vl.value=Math.round(CFG.snd.vol*100); document.getElementById('vol-v').textContent=Math.round(CFG.snd.vol*100)+'%';}
}

// ============================================================
// LEADERBOARD
// ============================================================
let lbMode = 'all';
document.getElementById('open-lb-btn').addEventListener('click', () => { document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('lb-screen').classList.remove('hidden'); loadLB(); });

// ‚îÄ‚îÄ BOTS: lobby navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let botsCount=1, botsDiff='easy';
document.getElementById('open-bots-btn').addEventListener('click',()=>{ document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('bots-screen').classList.remove('hidden'); });
document.getElementById('bots-back-btn').addEventListener('click',()=>{ document.getElementById('bots-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); });
document.querySelectorAll('.bot-count-btn').forEach(b=>b.addEventListener('click',()=>{
  botsCount=parseInt(b.dataset.n);
  document.querySelectorAll('.bot-count-btn').forEach(x=>{ x.style.background='rgba(34,119,204,.35)'; x.style.border='1px solid rgba(34,119,204,.5)'; });
  b.style.background='rgba(34,119,204,.8)'; b.style.border='none';
  updateBotsDesc();
}));
document.querySelectorAll('.bot-diff-btn').forEach(b=>b.addEventListener('click',()=>{
  botsDiff=b.dataset.d;
  document.querySelectorAll('.bot-diff-btn').forEach(x=>{ x.style.opacity='.5'; x.style.fontWeight='400'; });
  b.style.opacity='1'; b.style.fontWeight='900';
  updateBotsDesc();
}));
function updateBotsDesc(){
  const diffMap={easy:{label:'F√ÅCIL',col:'#66ff66',txt:'patrullan lentamente y tienen mala punter√≠a'},medium:{label:'MEDIO',col:'#ffaa00',txt:'rastrean tu posici√≥n y disparan con precisi√≥n normal'},hard:{label:'DIF√çCIL',col:'#ff4444',txt:'reaccionan r√°pido, flanquean y tienen mira precisa'}};
  const d=diffMap[botsDiff];
  document.getElementById('bots-desc').innerHTML=`<b style="color:${d.col}">${d.label}</b> ‚Äî Los bots ${d.txt}<br><b style="color:#fff">${botsCount} BOT${botsCount>1?'S':''}</b> ‚Äî Mapa PVP normal, kills hasta 10`;
}
document.getElementById('bots-start-btn').addEventListener('click',()=>{
  document.getElementById('bots-screen').classList.add('hidden');
  botsStartMatch(botsCount, botsDiff);
});

// ‚îÄ‚îÄ FRIENDS: navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('open-friends-btn').addEventListener('click',()=>{ document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('friends-screen').classList.remove('hidden'); loadFriends(); });
document.getElementById('friends-back-btn').addEventListener('click',()=>{ document.getElementById('friends-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); });
document.getElementById('friend-search-btn').addEventListener('click', searchFriend);
document.getElementById('friend-search-input').addEventListener('keydown',e=>{ if(e.key==='Enter') searchFriend(); });

// ‚îÄ‚îÄ FRIENDS SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchFriend(){
  if(!currentUser){ alert('Debes iniciar sesi√≥n'); return; }
  const q=document.getElementById('friend-search-input').value.trim().toLowerCase();
  if(!q) return;
  const res=document.getElementById('friend-search-result');
  res.innerHTML='<span style="color:var(--dim);font-size:.58rem">Buscando...</span>';
  const {data,error}=await sbClient.from('game_users').select('id,display_name,avatar').eq('username',q).single();
  if(error||!data){ res.innerHTML='<span style="color:#ff4444;font-size:.58rem">‚ö† Usuario no encontrado</span>'; return; }
  if(data.id===currentUser.id){ res.innerHTML='<span style="color:#ff4444;font-size:.58rem">‚ö† Eres t√∫ mismo</span>'; return; }
  // Check if already friends
  const {data:existing}=await sbClient.from('friendships').select('id,status').or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`).or(`requester_id.eq.${data.id},addressee_id.eq.${data.id}`);
  const rel=existing?.find(r=>(r.requester_id===currentUser.id&&r.addressee_id===data.id)||(r.requester_id===data.id&&r.addressee_id===currentUser.id));
  let actionBtn='';
  if(!rel) actionBtn=`<button onclick="sendFriendReq('${data.id}','${data.display_name}')" style="padding:5px 12px;background:var(--accent);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.55rem;font-weight:900;cursor:pointer;clip-path:polygon(4px 0,100% 0,calc(100% - 4px) 100%,0 100%)">+ AGREGAR</button>`;
  else if(rel.status==='pending') actionBtn='<span style="color:#ffd700;font-size:.55rem">‚è≥ PENDIENTE</span>';
  else if(rel.status==='accepted') actionBtn='<span style="color:#44ff88;font-size:.55rem">‚úì YA SON AMIGOS</span>';
  res.innerHTML=`<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,255,255,.05);border:1px solid var(--border)">
    <span style="font-size:1.4rem">${data.avatar||'üéÆ'}</span>
    <span style="font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700;flex:1">${data.display_name}</span>
    ${actionBtn}
  </div>`;
}

async function sendFriendReq(toId, toName){
  const {error}=await sbClient.from('friendships').insert({requester_id:currentUser.id,addressee_id:toId,status:'pending',created_at:new Date().toISOString()});
  if(error){ document.getElementById('friend-search-result').innerHTML='<span style="color:#ff4444;font-size:.58rem">Error al enviar solicitud</span>'; return; }
  document.getElementById('friend-search-result').innerHTML=`<span style="color:#44ff88;font-size:.58rem">‚úì Solicitud enviada a ${toName}</span>`;
}

async function loadFriends(){
  if(!currentUser) return;
  const list=document.getElementById('friends-list');
  const empty=document.getElementById('friends-empty');
  const reqWrap=document.getElementById('friend-requests-wrap');
  const reqList=document.getElementById('friend-requests-list');
  list.innerHTML=''; reqList.innerHTML='';

  // Load accepted friends
  const {data:fs}=await sbClient.from('friendships').select('*').or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`).eq('status','accepted');
  const friendIds=(fs||[]).map(f=>f.requester_id===currentUser.id?f.addressee_id:f.requester_id);
  document.getElementById('friends-count').textContent=friendIds.length;
  if(friendIds.length===0){ empty.style.display='block'; list.style.display='none'; }
  else{
    empty.style.display='none'; list.style.display='flex';
    const {data:users}=await sbClient.from('game_users').select('id,display_name,avatar,last_seen').in('id',friendIds);
    (users||[]).forEach(u=>{
      const online=u.last_seen&&(Date.now()-new Date(u.last_seen).getTime())<120000;
      const fr=fs.find(f=>f.requester_id===u.id||f.addressee_id===u.id);
      const el=document.createElement('div');
      el.style.cssText='display:flex;align-items:center;gap:10px;padding:9px 12px;background:rgba(255,255,255,.04);border:1px solid var(--border)';
      el.innerHTML=`<span style="font-size:1.3rem">${u.avatar||'üéÆ'}</span>
        <div style="flex:1">
          <div style="font-family:'Orbitron',monospace;font-size:.65rem;font-weight:700">${u.display_name}</div>
          <div style="font-size:.48rem;color:${online?'#44ff88':'var(--dim)'}">${online?'‚óè EN L√çNEA':'‚óã Desconectado'}</div>
        </div>
        <button onclick="inviteFriend('${u.display_name}')" style="padding:4px 10px;background:rgba(34,119,204,.6);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.5rem;cursor:pointer;clip-path:polygon(3px 0,100% 0,calc(100% - 3px) 100%,0 100%)">INVITAR</button>
        <button onclick="removeFriend('${fr?.id}','${u.display_name}')" style="padding:4px 8px;background:rgba(255,50,50,.2);border:1px solid rgba(255,50,50,.3);color:#ff6666;font-family:'Orbitron',monospace;font-size:.48rem;cursor:pointer">‚úï</button>`;
      list.appendChild(el);
    });
  }

  // Load pending requests (sent TO me)
  const {data:reqs}=await sbClient.from('friendships').select('*').eq('addressee_id',currentUser.id).eq('status','pending');
  if(reqs&&reqs.length>0){
    reqWrap.style.display='block';
    const {data:reqUsers}=await sbClient.from('game_users').select('id,display_name,avatar').in('id',reqs.map(r=>r.requester_id));
    reqs.forEach(req=>{
      const u=reqUsers?.find(x=>x.id===req.requester_id);
      if(!u) return;
      const el=document.createElement('div');
      el.style.cssText='display:flex;align-items:center;gap:8px;padding:7px 10px;background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.2);margin-bottom:5px';
      el.innerHTML=`<span style="font-size:1.2rem">${u.avatar||'üéÆ'}</span>
        <span style="font-family:'Orbitron',monospace;font-size:.6rem;flex:1">${u.display_name}</span>
        <button onclick="acceptFriendReq('${req.id}','${u.display_name}')" style="padding:4px 10px;background:rgba(68,255,136,.7);border:none;color:#000;font-family:'Orbitron',monospace;font-size:.5rem;font-weight:900;cursor:pointer">‚úì ACEPTAR</button>
        <button onclick="declineFriendReq('${req.id}')" style="padding:4px 8px;background:rgba(255,50,50,.3);border:none;color:#fff;font-family:'Orbitron',monospace;font-size:.5rem;cursor:pointer">‚úï</button>`;
      reqList.appendChild(el);
    });
  } else reqWrap.style.display='none';

  // Update last_seen
  sbClient.from('game_users').update({last_seen:new Date().toISOString()}).eq('id',currentUser.id);
}

async function acceptFriendReq(reqId, name){
  await sbClient.from('friendships').update({status:'accepted'}).eq('id',reqId);
  loadFriends();
}
async function declineFriendReq(reqId){
  await sbClient.from('friendships').delete().eq('id',reqId);
  loadFriends();
}
async function removeFriend(friendshipId, name){
  if(!confirm('¬øEliminar a '+name+' de amigos?')) return;
  await sbClient.from('friendships').delete().eq('id',friendshipId);
  loadFriends();
}
function inviteFriend(name){
  // Copy invite message to clipboard
  const room=document.getElementById('duel-room-name-input')?.value||'mi sala';
  navigator.clipboard?.writeText('¬°Te invito a jugar INA TRAINER! √önete a la sala: '+room).then(()=>alert('¬°Invitaci√≥n copiada! P√©gala en el chat de '+name));
}

// Update last_seen every 60s while logged in
setInterval(()=>{ if(currentUser) sbClient.from('game_users').update({last_seen:new Date().toISOString()}).eq('id',currentUser.id); }, 60000);
document.getElementById('lb-back-btn').addEventListener('click', () => { document.getElementById('lb-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); });
document.getElementById('lb-refresh-btn').addEventListener('click', loadLB);
document.getElementById('lb-tabs').querySelectorAll('.lb-tab').forEach(t => t.addEventListener('click', () => { document.querySelectorAll('.lb-tab').forEach(x => x.classList.remove('active')); t.classList.add('active'); lbMode = t.dataset.mode; loadLB(); }));

async function loadLB() {
  const body = document.getElementById('lb-body');
  body.innerHTML = '<tr><td colspan="6" class="lb-loading">‚ü≥ CARGANDO R√âCORDS GLOBALES...</td></tr>';
  try {
    let q = sbClient.from('scores').select('*').order('score', {ascending:false}).limit(200);
    if (lbMode !== 'all') q = q.eq('mode', lbMode);
    const { data, error } = await q;
    if (error) throw error;
    const best = {};
    (data||[]).forEach(e => { const key = (e.user_id||e.name)+'_'+e.mode; if (!best[key] || e.score > best[key].score) best[key] = e; });
    let top = Object.values(best).sort((a,b) => b.score-a.score).slice(0,50);
    if (top.length === 0) { body.innerHTML = '<tr><td colspan="6" class="lb-empty">üèÜ Sin r√©cords a√∫n. ¬°S√© el primero!</td></tr>'; return; }
    renderLBRows(body, top);
  } catch(e) { body.innerHTML = '<tr><td colspan="6" class="lb-empty">‚ö† Error al cargar. Verifica tu conexi√≥n.</td></tr>'; }
}

function renderLBRows(body, top) {
  body.innerHTML = '';
  top.forEach((e,i) => {
    const tr = document.createElement('tr');
    const isMe = currentUser && (e.user_id === currentUser.id || e.name === currentUser.name);
    if (isMe) tr.classList.add('lb-me');
    const rankClass = i===0?'r1':i===1?'r2':i===2?'r3':'';
    const medal = i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    const diffLabel = {easy:'F√ÅCIL',medium:'MEDIO',hard:'DIF√çCIL'}[e.diff||e.difficulty]||(e.diff||e.difficulty||'‚Äî');
    const modeLabel = (MODES[e.mode]?.name)||e.mode||'‚Äî';
    const acc = e.acc ?? e.accuracy ?? 0;
    tr.innerHTML = `<td><span class="lb-rank ${rankClass}">${medal||('#'+(i+1))}</span></td><td><div class="lb-player"><span>${e.avatar||'üéØ'}</span><span>${e.name}${isMe?' ‚òÖ':''}</span></div></td><td><span class="lb-score-val">${(e.score||0).toLocaleString()}</span></td><td><span class="lb-acc">${acc}%</span></td><td style="color:var(--dim)">${modeLabel}</td><td style="color:var(--dim)">${diffLabel}</td>`;
    body.appendChild(tr);
  });
}

// ============================================================
// STATS UI
// ============================================================
document.getElementById('open-stats-btn').addEventListener('click', () => { document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('stats-screen').classList.remove('hidden'); loadStats(); });
document.getElementById('stats-back-btn').addEventListener('click', () => { document.getElementById('stats-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); });

async function loadStats() {
  if (!currentUser) return;
  document.getElementById('profile-av').textContent   = currentUser.avatar;
  document.getElementById('profile-name').textContent = currentUser.name.toUpperCase();
  ['st-games','st-best','st-acc','st-hits','st-shots','st-combo'].forEach(id => { document.getElementById(id).textContent = '‚Ä¶'; });
  const s = await getMyStats();
  document.getElementById('st-games').textContent  = s.games || 0;
  document.getElementById('st-best').textContent   = (s.best_score||0).toLocaleString();
  const avgAcc = (s.total_shots||0) > 0 ? Math.round((s.total_hits||0)/(s.total_shots||0)*100) : 0;
  document.getElementById('st-acc').textContent    = avgAcc+'%';
  document.getElementById('st-hits').textContent   = (s.total_hits||0).toLocaleString();
  document.getElementById('st-shots').textContent  = (s.total_shots||0).toLocaleString();
  document.getElementById('st-combo').textContent  = s.best_combo || 0;
  const mrRows = document.getElementById('mr-rows'); mrRows.innerHTML = '';
  const recs = s.mode_records || {};
  Object.keys(MODES).forEach(id => {
    const rec = recs[id]; const row = document.createElement('div'); row.className = 'mr-row';
    row.innerHTML = `<span class="mr-mode">${MODES[id]?.name||id}</span><span class="mr-score">${rec?(rec.score||0).toLocaleString():'‚Äî'}</span><span class="mr-acc">${rec?rec.acc+'%':'‚Äî'}</span>`;
    mrRows.appendChild(row);
  });
}

// ============================================================
// MODES ‚Äî ‚úÖ CAMBIO: todos los modos duran 60 segundos
// ============================================================
const MODES = {
  clicking:  { id:'clicking',  tag:'CLICKING',    name:'Clicking',      desc:'M√∫ltiples objetivos. Elim√≠nalos antes de que desaparezcan.', color:'#00e5ff' },
  flicking:  { id:'flicking',  tag:'FLICKING',    name:'Flick Shot',    desc:'Un objetivo a la vez en posici√≥n aleatoria. Reacciona r√°pido.', color:'#ff9500' },
  tracking:  { id:'tracking',  tag:'TRACKING',    name:'Tracking',      desc:'Un objetivo en movimiento. Apunta continuamente hacia √©l.', color:'#00ff88' },
  micro:     { id:'micro',     tag:'PRECISION',   name:'Micro Shot',    desc:'Objetivos peque√±os. M√°xima precisi√≥n requerida.', color:'#ff3d71' },
  strafe:    { id:'strafe',    tag:'STRAFE',       name:'Strafe Aim',   desc:'Objetivos que se mueven lateralmente a alta velocidad.', color:'#a259ff' },
  survival:  { id:'survival',  tag:'SURVIVAL',    name:'Supervivencia', desc:'Sin tiempo. 3 vidas. Cada objetivo perdido cuesta una vida.', color:'#ffd700' },
  gridshot:  { id:'gridshot',  tag:'GRIDSHOT',    name:'Grid Shot',     desc:'Cuadr√≠cula de objetivos. Elimina en orden lo m√°s r√°pido posible.', color:'#e040fb' },
  wide:      { id:'wide',      tag:'WIDE ANGLE',  name:'Wide Angle',    desc:'Objetivos en los extremos. Entrena movimientos amplios.', color:'#ff6b35' },
};

// ‚úÖ CAMBIO: Todos los modos ahora duran 60 segundos
const DIFF = {
  easy:   { time:60, maxT:4, rate:1200, minR:.28, maxR:.42, speed:1.8, life:[3.5,6] },
  medium: { time:60, maxT:5, rate:850,  minR:.18, maxR:.30, speed:3.0, life:[2,3.5] },
  hard:   { time:60, maxT:6, rate:550,  minR:.10, maxR:.20, speed:5.0, life:[1,2] },
};

// ============================================================
// MENU PREVIEWS
// ============================================================
const prevFns = {};
function dp(id,fn){ prevFns[id]=fn; }
dp('clicking',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);[{x:.2,y:.4,r:9},{x:.6,y:.6,r:12},{x:.78,y:.25,r:7}].forEach((tg,i)=>{ const a=.4+.6*Math.abs(Math.sin(t/900+i*2));c.beginPath();c.arc(tg.x*w,tg.y*h,tg.r,0,Math.PI*2);c.fillStyle=`rgba(0,160,200,${.25*a})`;c.fill();c.strokeStyle=`rgba(0,229,255,${a})`;c.lineWidth=2;c.stroke();}); });
dp('flicking',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);const x=w*(.15+.7*((Math.sin(t/800)+1)/2)),y=h*.5;c.beginPath();c.arc(x,y,11,0,Math.PI*2);c.fillStyle='rgba(180,80,0,.25)';c.fill();c.strokeStyle='rgba(255,149,0,.9)';c.lineWidth=2;c.stroke(); });
dp('tracking',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);const x=w*.5+Math.cos(t/1100)*w*.3,y=h*.5+Math.sin(t/800)*h*.25;c.beginPath();c.arc(x,y,14,0,Math.PI*2);c.fillStyle='rgba(0,180,80,.2)';c.fill();c.strokeStyle='rgba(0,255,136,.9)';c.lineWidth=2;c.stroke(); });
dp('micro',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);[{x:.25,y:.4},{x:.68,y:.3},{x:.5,y:.65},{x:.15,y:.65},{x:.82,y:.55}].forEach((p,i)=>{ const a=.4+.6*Math.abs(Math.sin(t/700+i));c.beginPath();c.arc(p.x*w,p.y*h,3.5,0,Math.PI*2);c.fillStyle=`rgba(180,0,60,${.3*a})`;c.fill();c.strokeStyle=`rgba(255,61,113,${a})`;c.lineWidth=1.5;c.stroke();}); });
dp('strafe',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);const x=w*.5+Math.sin(t/700)*w*.38,y=h*.5;c.beginPath();c.arc(x,y,12,0,Math.PI*2);c.fillStyle='rgba(100,40,200,.2)';c.fill();c.strokeStyle='rgba(162,89,255,.9)';c.lineWidth=2;c.stroke(); });
dp('survival',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);for(let i=0;i<4;i++){const ang=(i/4)*Math.PI*2+t/2000,x=w*.5+Math.cos(ang)*w*.3,y=h*.5+Math.sin(ang)*h*.28,a=.5+.5*Math.sin(t/600+i*1.5);c.beginPath();c.arc(x,y,8,0,Math.PI*2);c.fillStyle=`rgba(180,140,0,${.2*a})`;c.fill();c.strokeStyle=`rgba(255,215,0,${a})`;c.lineWidth=2;c.stroke();} });
dp('gridshot',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);const act=Math.floor(t/600)%8;for(let r=0;r<2;r++)for(let col=0;col<4;col++){const idx=r*4+col,x=(col+.5)*(w/4),y=(r+.5)*(h/2),hit=idx===act;c.beginPath();c.arc(x,y,8,0,Math.PI*2);c.fillStyle=hit?'rgba(224,64,251,.35)':'rgba(50,20,80,.3)';c.fill();c.strokeStyle=hit?'rgba(224,64,251,1)':'rgba(100,60,140,.4)';c.lineWidth=hit?2:1;c.stroke();} });
dp('wide',(c,w,h,t)=>{ c.fillStyle='#030608';c.fillRect(0,0,w,h);[{x:.05,y:.5},{x:.95,y:.5},{x:.15,y:.25},{x:.85,y:.75}].forEach((p,i)=>{ const a=.5+.5*Math.abs(Math.sin(t/800+i*1.5));c.beginPath();c.arc(p.x*w,p.y*h,7,0,Math.PI*2);c.fillStyle=`rgba(255,100,40,${.2*a})`;c.fill();c.strokeStyle=`rgba(255,107,53,${a})`;c.lineWidth=2;c.stroke();}); });

function animPrevs(){ const t=performance.now(); Object.keys(prevFns).forEach(id=>{ const cv=document.getElementById('prev-'+id); if(cv) prevFns[id](cv.getContext('2d'),cv.width,cv.height,t); }); requestAnimationFrame(animPrevs); }

let selMode='clicking', selDiff='medium';
function buildMenu(){
  const grid=document.getElementById('modes-grid'); grid.innerHTML='';
  Object.values(MODES).forEach(m=>{
    const card=document.createElement('div'); card.className='mode-card'+(m.id===selMode?' selected':''); card.dataset.id=m.id;
    card.innerHTML=`<div class="mode-prev"><canvas id="prev-${m.id}" width="200" height="60"></canvas></div><div class="mode-info"><div class="m-tag" style="color:${m.color}">${m.tag}</div><div class="m-name">${m.name}</div><div class="m-desc">${m.desc}</div></div>`;
    card.addEventListener('click',()=>{ selMode=m.id; document.querySelectorAll('.mode-card').forEach(c=>c.classList.toggle('selected',c.dataset.id===m.id)); });
    grid.appendChild(card);
  });
  animPrevs();
}
buildMenu();
document.querySelectorAll('.diff-btn[data-d]').forEach(b=>b.addEventListener('click',()=>{ document.querySelectorAll('.diff-btn[data-d]').forEach(x=>x.classList.remove('act')); b.classList.add('act'); selDiff=b.dataset.d; }));
document.getElementById('start-btn').addEventListener('click',()=>startGame(selMode,selDiff));

// ============================================================
// CFG
// ============================================================
const CFG={ ch:{color:'#ffffff',size:12,thick:2,gap:8,dot:true}, sens:3.0, tgt:{sizeMult:1.0,speedMult:1.0,max:4}, vis:{fx:true,pts:true,combo:true}, snd:{shot:true,hit:true,miss:false,vol:0.7}, room:{color:'#1a0a2e'} };

function applyCH(){
  const col=CFG.ch.color,ch=document.getElementById('crosshair');
  document.querySelectorAll('.ch-line,.ch-dot').forEach(el=>el.style.background=col);
  const gap=CFG.ch.gap,len=CFG.ch.size,th=CFG.ch.thick;
  const base=`background:${col};border-radius:1px;position:absolute;transition:all 0.06s;`;
  const chT=ch.querySelector('.ch-top'),chB=ch.querySelector('.ch-bottom'),chL=ch.querySelector('.ch-left'),chR=ch.querySelector('.ch-right');
  if(chT){ chT.style.cssText=`${base}width:${th}px;height:${len}px;left:50%;top:calc(50% - ${gap+len}px);transform:translateX(-50%);`; chB.style.cssText=`${base}width:${th}px;height:${len}px;left:50%;top:calc(50% + ${gap}px);transform:translateX(-50%);`; chL.style.cssText=`${base}height:${th}px;width:${len}px;top:50%;left:calc(50% - ${gap+len}px);transform:translateY(-50%);`; chR.style.cssText=`${base}height:${th}px;width:${len}px;top:50%;left:calc(50% + ${gap}px);transform:translateY(-50%);`; }
  const dot=ch.querySelector('.ch-dot'); if(dot) dot.style.display=CFG.ch.dot?'block':'none';
}

function initCFG(){
  document.querySelectorAll('#ch-colors .color-opt').forEach(o=>o.addEventListener('click',()=>{ document.querySelectorAll('#ch-colors .color-opt').forEach(x=>x.classList.remove('active')); o.classList.add('active'); CFG.ch.color=o.dataset.c; applyCH(); }));
  document.querySelectorAll('#room-colors .color-opt').forEach(o=>o.addEventListener('click',()=>{ document.querySelectorAll('#room-colors .color-opt').forEach(x=>x.classList.remove('active')); o.classList.add('active'); CFG.room.color=o.dataset.c; if(scene)updateRoomColor(); }));
  [['ch-size','ch-size-v',v=>{CFG.ch.size=v;applyCH();},v=>v],['ch-thick','ch-thick-v',v=>{CFG.ch.thick=v;applyCH();},v=>v],['ch-gap','ch-gap-v',v=>{CFG.ch.gap=v;applyCH();},v=>v],['sens-sl','sens-v',v=>CFG.sens=v/10,v=>(v/10).toFixed(1)],['tgt-size','tgt-size-v',v=>CFG.tgt.sizeMult=v/100,v=>(v/100).toFixed(1)+'x'],['tgt-spd','tgt-spd-v',v=>CFG.tgt.speedMult=v/100,v=>(v/100).toFixed(1)+'x'],['tgt-max','tgt-max-v',v=>CFG.tgt.max=v,v=>v],['vol-sl','vol-v',v=>CFG.snd.vol=v/100,v=>v+'%']].forEach(([id,vid,fn,fmt])=>document.getElementById(id).addEventListener('input',function(){fn(+this.value);document.getElementById(vid).textContent=fmt(this.value);}));
  [['ch-dot',CFG.ch,'dot',applyCH],['fx-tog',CFG.vis,'fx'],['pts-tog',CFG.vis,'pts'],['combo-tog',CFG.vis,'combo'],['snd-shot',CFG.snd,'shot'],['snd-hit',CFG.snd,'hit'],['snd-miss',CFG.snd,'miss']].forEach(([id,obj,key,cb])=>document.getElementById(id).addEventListener('change',function(){obj[key]=this.checked;if(cb)cb();}));
  document.getElementById('open-cfg-btn').addEventListener('click',()=>{ document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('settings-screen').classList.remove('hidden'); });
  // ‚úÖ CAMBIO: guarda config en Supabase al hacer clic en "GUARDAR Y VOLVER"
  document.getElementById('cfg-save').addEventListener('click',()=>{
    document.getElementById('settings-screen').classList.add('hidden');
    document.getElementById('menu-screen').classList.remove('hidden');
    applyCH();
    saveMyConfig();
  });
  document.getElementById('cfg-reset').addEventListener('click',()=>{ CFG.ch={color:'#ffffff',size:12,thick:2,gap:8,dot:true};CFG.sens=3.0;CFG.tgt={sizeMult:1,speedMult:1,max:4};CFG.vis={fx:true,pts:true,combo:true};CFG.snd={shot:true,hit:true,miss:false,vol:.7};applyCH();applyCfgToDOM(); });
}
initCFG(); applyCH();

// ============================================================
// SOUNDS
// ============================================================
let audioCtx;
function getAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); return audioCtx; }

function playGunshot() {
  if(!CFG.snd.shot) return;
  try {
    const ctx=getAudio(), vol=CFG.snd.vol, now=ctx.currentTime;
    const buf=ctx.createBuffer(1,ctx.sampleRate*.15,ctx.sampleRate); const data=buf.getChannelData(0);
    for(let i=0;i<data.length;i++){ const t=i/ctx.sampleRate; data[i]=(Math.random()*2-1)*Math.exp(-t*25)*1.5+Math.sin(2*Math.PI*180*t)*Math.exp(-t*18)*.7+Math.sin(2*Math.PI*60*t)*Math.exp(-t*10)*.8; }
    const src=ctx.createBufferSource(); src.buffer=buf;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=80;
    const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3500;
    const gain=ctx.createGain(); gain.gain.value=vol*2.5;
    src.connect(hp); hp.connect(lp); lp.connect(gain); gain.connect(ctx.destination); src.start(now); src.stop(now+.18);
    const buf2=ctx.createBuffer(1,ctx.sampleRate*.4,ctx.sampleRate); const d2=buf2.getChannelData(0);
    for(let i=0;i<d2.length;i++){ const t=i/ctx.sampleRate; d2[i]=(Math.random()*2-1)*Math.exp(-t*8)*.3; }
    const src2=ctx.createBufferSource(); src2.buffer=buf2;
    const g2=ctx.createGain(); g2.gain.value=vol*.6; const lp2=ctx.createBiquadFilter(); lp2.type='lowpass'; lp2.frequency.value=1200;
    src2.connect(lp2); lp2.connect(g2); g2.connect(ctx.destination); src2.start(now+.02); src2.stop(now+.45);
  } catch(e){}
}

function playHitSound() {
  if(!CFG.snd.hit) return;
  try {
    const ctx=getAudio(), now=ctx.currentTime, vol=CFG.snd.vol;
    const o=ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(1200,now); o.frequency.exponentialRampToValueAtTime(800,now+.08);
    const g=ctx.createGain(); g.gain.setValueAtTime(vol*.5,now); g.gain.exponentialRampToValueAtTime(.001,now+.12);
    o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+.15);
    const o2=ctx.createOscillator(); o2.type='square'; o2.frequency.value=2400;
    const g2=ctx.createGain(); g2.gain.setValueAtTime(vol*.15,now); g2.gain.exponentialRampToValueAtTime(.001,now+.03);
    o2.connect(g2); g2.connect(ctx.destination); o2.start(now); o2.stop(now+.04);
  } catch(e){}
}

function playMissSound() {
  if(!CFG.snd.miss) return;
  try {
    const ctx=getAudio(), now=ctx.currentTime, vol=CFG.snd.vol;
    const o=ctx.createOscillator(); o.type='sawtooth'; o.frequency.value=200;
    const g=ctx.createGain(); g.gain.setValueAtTime(vol*.1,now); g.gain.exponentialRampToValueAtTime(.001,now+.1);
    o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+.12);
  } catch(e){}
}

// ============================================================
// THREE.JS (SINGLE PLAYER)
// ============================================================
let scene,camera,renderer,gunGroup,yawObj,pitchObj,raycaster,animFrameId,locked=false,mouseDX=0,mouseDY=0,roomMat;

function initThree(){
  const canvas=document.getElementById('three-canvas');
  renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setPixelRatio(window.devicePixelRatio); renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true;
  scene=new THREE.Scene();
  yawObj=new THREE.Object3D(); pitchObj=new THREE.Object3D(); yawObj.add(pitchObj); scene.add(yawObj);
  camera=new THREE.PerspectiveCamera(90,window.innerWidth/window.innerHeight,.05,500);
  pitchObj.add(camera); camera.position.set(0,0,0); yawObj.position.set(0,1.7,0);
  raycaster=new THREE.Raycaster();
  buildRoom(); buildGun(); buildLights();
  window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });
}

function updateRoomColor(){ const col=new THREE.Color(CFG.room.color); scene.background=col; scene.fog=new THREE.Fog(col,20,80); if(roomMat) roomMat.color.set(col.clone().multiplyScalar(1.8)); }

function buildRoom(){
  const col=new THREE.Color(CFG.room.color); scene.background=col; scene.fog=new THREE.Fog(col,20,80);
  roomMat=new THREE.MeshLambertMaterial({color:new THREE.Color(CFG.room.color).multiplyScalar(1.8),side:THREE.BackSide});
  const room=new THREE.Mesh(new THREE.BoxGeometry(30,10,50),roomMat); room.position.set(0,3.3,-23); scene.add(room);
  const grid=new THREE.GridHelper(60,30,0x222244,0x111133); grid.position.set(0,-1.7,0); scene.add(grid);
  const wallMat=new THREE.MeshLambertMaterial({color:0x0d0520,side:THREE.DoubleSide});
  const wall=new THREE.Mesh(new THREE.PlaneGeometry(28,8),wallMat); wall.position.set(0,2.3,-22); scene.add(wall);
  const lm=new THREE.LineBasicMaterial({color:0x331155});
  for(let i=-14;i<=14;i+=2){ const g=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(i,-1.7,-22),new THREE.Vector3(i,6.3,-22)]); scene.add(new THREE.Line(g,lm)); }
  for(let j=-1.7;j<=6.3;j+=2){ const g=new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-14,j,-22),new THREE.Vector3(14,j,-22)]); scene.add(new THREE.Line(g,lm)); }
}

function buildGun(){
  gunGroup=new THREE.Group();
  const bodyMat=new THREE.MeshLambertMaterial({color:0x1a1a2e}),slideMat=new THREE.MeshLambertMaterial({color:0x2a2a3e}),darkMat=new THREE.MeshLambertMaterial({color:0x111111}),accentMat=new THREE.MeshLambertMaterial({color:0xe040fb,emissive:0xe040fb,emissiveIntensity:.8});
  const body=new THREE.Mesh(new THREE.BoxGeometry(.08,.12,.55),bodyMat); gunGroup.add(body);
  const slide=new THREE.Mesh(new THREE.BoxGeometry(.065,.06,.48),slideMat); slide.position.set(0,.09,-.02); gunGroup.add(slide);
  const barrel=new THREE.Mesh(new THREE.CylinderGeometry(.018,.018,.22,8),darkMat); barrel.rotation.x=Math.PI/2; barrel.position.set(0,.06,-.37); gunGroup.add(barrel);
  const tip=new THREE.Mesh(new THREE.CylinderGeometry(.022,.022,.04,8),darkMat); tip.rotation.x=Math.PI/2; tip.position.set(0,.06,-.50); gunGroup.add(tip);
  const handle=new THREE.Mesh(new THREE.BoxGeometry(.07,.16,.10),bodyMat); handle.position.set(0,-.14,.08); handle.rotation.x=.18; gunGroup.add(handle);
  const tg=new THREE.Mesh(new THREE.TorusGeometry(.03,.008,8,12,Math.PI),darkMat); tg.position.set(0,-.065,-.02); tg.rotation.z=Math.PI/2; tg.rotation.y=Math.PI/2; gunGroup.add(tg);
  const sf=new THREE.Mesh(new THREE.BoxGeometry(.008,.025,.01),accentMat); sf.position.set(0,.132,-.25); gunGroup.add(sf);
  const al=new THREE.Mesh(new THREE.BoxGeometry(.002,.12,.01),accentMat); al.position.set(.04,0,.04); gunGroup.add(al);
  const al2=al.clone(); al2.position.set(-.04,0,.04); gunGroup.add(al2);
  gunGroup.position.set(.22,-.22,-.4); gunGroup.rotation.y=.06;
  camera.add(gunGroup);
}

function buildLights(){
  scene.add(new THREE.AmbientLight(0x221133,1.2));
  const spot=new THREE.SpotLight(0xffffff,1.5); spot.position.set(0,8,-10); spot.target.position.set(0,0,-20); spot.angle=.5; spot.penumbra=.4; spot.castShadow=true; scene.add(spot); scene.add(spot.target);
  const dl1=new THREE.DirectionalLight(0x6622aa,.6); dl1.position.set(-10,5,0); scene.add(dl1);
  const dl2=new THREE.DirectionalLight(0x00e5ff,.3); dl2.position.set(10,3,-20); scene.add(dl2);
}

const PI_2=Math.PI/2;
function updateCamera(){
  if(!mouseDX&&!mouseDY) return;
  const s=CFG.sens*.001; yawObj.rotation.y-=mouseDX*s; pitchObj.rotation.x-=mouseDY*s;
  pitchObj.rotation.x=Math.max(-PI_2+.05,Math.min(PI_2-.05,pitchObj.rotation.x));
  mouseDX=0; mouseDY=0;
}

let shootAnim=0,gunBob=0;
function updateGun(dt){
  if(!gunGroup) return;
  if(shootAnim>0){ shootAnim=Math.max(0,shootAnim-dt*8); gunGroup.position.z=-.4+shootAnim*.06; gunGroup.rotation.x=shootAnim*.12; }
  else{ gunGroup.position.z+=(-.4-gunGroup.position.z)*dt*8; gunGroup.rotation.x+=(0-gunGroup.rotation.x)*dt*8; }
  gunBob+=dt*1.2; gunGroup.position.y=-.22+Math.sin(gunBob)*.003;
}

function triggerShoot(){
  shootAnim=1;
  const flash=new THREE.PointLight(0xe040fb,8,2); flash.position.set(0,.06,-.5); camera.add(flash); setTimeout(()=>camera.remove(flash),50);
}

// ============================================================
// POINTER LOCK + PAUSA
// ============================================================
let paused = false;

function showPause(){
  paused = true;
  if(state.timerIv){ clearInterval(state.timerIv); state.timerIv=null; }
  if(state.spawnIv){ clearInterval(state.spawnIv); state.spawnIv=null; }
  document.getElementById('pause-mode-name').textContent = MODES[state.modeId]?.name||'‚Äî';
  document.getElementById('pause-overlay').style.display='flex';
  document.getElementById('mobile-controls').classList.remove('active');
  crosshairEl.style.display='none';
}

function hidePause(){
  paused = false;
  document.getElementById('pause-overlay').style.display='none';
  crosshairEl.style.display='block';
  if(mobileMode) document.getElementById('mobile-controls').classList.add('active');
  if(state.running && state.timerStarted){
    if(state.modeId==='survival') startSurvivalTimer(); else startTimer();
    if(state.modeId!=='tracking') startSpawner3D();
  }
}

document.addEventListener('pointerlockchange',()=>{
  locked=document.pointerLockElement===document.getElementById('three-canvas');
  if(locked){ document.getElementById('lock-overlay').style.display='none'; if(paused) hidePause(); if(!state.timerStarted) beginTimerAndSpawn(); }
  else if(state.running){ if(!state.timerStarted) document.getElementById('lock-overlay').style.display='flex'; else showPause(); }
});

document.addEventListener('keydown', e=>{
  if(e.key==='Escape' && state.running && locked) document.exitPointerLock();
});

document.getElementById('pause-resume-btn').addEventListener('click',()=>{ document.getElementById('three-canvas').requestPointerLock(); });
document.getElementById('pause-menu-btn').addEventListener('click',()=>{ document.getElementById('pause-overlay').style.display='none'; paused=false; endGame(); setTimeout(()=>{ resultsScreen.classList.add('hidden'); menuScreen.classList.remove('hidden'); }, 50); });
document.getElementById('pause-quit-btn').addEventListener('click',()=>{ document.getElementById('pause-overlay').style.display='none'; paused=false; endGame(); });
document.addEventListener('mousemove',e=>{ if(!locked||!state.running||paused) return; mouseDX+=e.movementX; mouseDY+=e.movementY; });
document.getElementById('lock-btn').addEventListener('click',()=>document.getElementById('three-canvas').requestPointerLock());

// ============================================================
// GAME STATE
// ============================================================
let state={};
const menuScreen=document.getElementById('menu-screen');
const resultsScreen=document.getElementById('results-screen');
const hud=document.getElementById('hud');
const bottomBar=document.getElementById('bottom-bar');
const crosshairEl=document.getElementById('crosshair');
const comboDisp=document.getElementById('combo-disp');
const comboNum=document.getElementById('combo-num');
const scoreVal=document.getElementById('score-val');
const timerVal=document.getElementById('timer-val');
const shotsVal=document.getElementById('shots-val');
const accPct=document.getElementById('acc-pct');
const accFill=document.getElementById('acc-fill');

const fsty=document.createElement('style');
fsty.textContent='@keyframes float-up{0%{opacity:1;transform:translate(-50%,-50%);}100%{opacity:0;transform:translate(-50%,calc(-50% - 55px));}}';
document.head.appendChild(fsty);

function startGame(modeId,diff){
  state={running:true,modeId,diff,score:0,shots:0,hits:0,combo:0,bestCombo:0,timeLeft:DIFF[diff].time,lives:3,targets:[],timerStarted:false,survSec:0,spawnIv:null,timerIv:null,trackData:null};
  menuScreen.classList.add('hidden'); resultsScreen.classList.add('hidden');
  document.getElementById('login-screen').classList.add('hidden');
  if(!scene) initThree(); updateRoomColor();
  document.getElementById('three-canvas').style.display='block';
  hud.style.display='flex'; bottomBar.style.display='flex'; crosshairEl.style.display='block';
  const m=MODES[modeId];
  document.getElementById('mode-tag').textContent=m.tag; document.getElementById('mode-tag').style.borderColor=m.color; document.getElementById('mode-tag').style.color=m.color;
  if(modeId==='survival'){ timerVal.textContent='0s'; document.getElementById('lives-hud').style.display='flex'; updateLives(); }
  else{ timerVal.textContent=DIFF[diff].time; document.getElementById('lives-hud').style.display='none'; }
  document.getElementById('lock-mode-name').textContent=m.name;
  if(mobileMode){
    document.getElementById('lock-overlay').style.display='none';
    document.getElementById('mobile-controls').classList.add('active');
    crosshairEl.style.display='block';
    if(!state.timerStarted) beginTimerAndSpawn();
  } else {
    document.getElementById('mobile-controls').classList.remove('active');
    document.getElementById('lock-overlay').style.display='flex';
  }
  if(animFrameId) cancelAnimationFrame(animFrameId);
  let last=performance.now(), fpsFrames=0, fpsAccum=0;
  const fpsVal=document.getElementById('fps-val');
  function renderLoop(now){
    animFrameId=requestAnimationFrame(renderLoop);
    const dt=Math.min((now-last)/1000,.05);
    fpsAccum+=(now-last); fpsFrames++;
    if(fpsAccum>=500){ const fd=Math.round(fpsFrames/(fpsAccum/1000)); fpsFrames=0; fpsAccum=0;
      if(fpsVal){ fpsVal.textContent=fd; fpsVal.style.color=fd>=100?'var(--green)':fd>=60?'var(--accent3)':fd>=30?'#ffd700':'var(--accent2)'; }
    }
    last=now;
    if(state.running){ updateCamera(); updateGun(dt); updateTargets(dt); if(modeId==='tracking')updateTracking(dt); }
    renderer.render(scene,camera);
  }
  renderLoop(performance.now());
  const canvas=document.getElementById('three-canvas');
  canvas.removeEventListener('click',onShoot); canvas.addEventListener('click',onShoot);
}

function beginTimerAndSpawn(){
  if(state.timerStarted) return; state.timerStarted=true;
  if(state.modeId==='tracking') startTracking3D(); else startSpawner3D();
  if(state.modeId==='survival') startSurvivalTimer(); else startTimer();
}

function updateLives(){ for(let i=1;i<=3;i++) document.getElementById('lf'+i).classList.toggle('lost',i>state.lives); }
function startTimer(){ state.timerIv=setInterval(()=>{ if(!state.running) return; state.timeLeft--; timerVal.textContent=state.timeLeft; if(state.timeLeft<=5) timerVal.classList.add('warn'); if(state.timeLeft<=0) endGame(); },1000); }
function startSurvivalTimer(){ state.timerIv=setInterval(()=>{ if(!state.running) return; state.survSec++; timerVal.textContent=state.survSec+'s'; },1000); }

function startSpawner3D(){
  const m=state.modeId,d=DIFF[state.diff];
  spawnFor3D();
  state.spawnIv=setInterval(()=>{ if(!state.running) return; const max=m==='flicking'?1:CFG.tgt.max; if(state.targets.length<max) spawnFor3D(); },m==='flicking'?150:d.rate);
}

function spawnFor3D(){
  const m=state.modeId;
  if(m==='flicking'&&state.targets.length>0) return;
  if(m==='gridshot'){ spawnGridShot(); return; }
  spawnTarget3D(m);
}

function makeTargetMesh(radius,modeId){
  const cols={clicking:0x00aacc,flicking:0xcc6600,tracking:0x00cc66,micro:0xcc1144,strafe:0x7733cc,survival:0xccaa00,gridshot:0xaa00cc,wide:0xcc4400};
  const col=cols[modeId]||0x00aacc;
  const geo=new THREE.SphereGeometry(radius,24,24);
  const mat=new THREE.MeshPhongMaterial({color:col,emissive:new THREE.Color(col).multiplyScalar(.3),shininess:80,transparent:true,opacity:1});
  const mesh=new THREE.Mesh(geo,mat); mesh.castShadow=true;
  const ring=new THREE.Mesh(new THREE.TorusGeometry(radius*1.2,radius*.06,8,32),new THREE.MeshBasicMaterial({color:col,transparent:true,opacity:.5}));
  mesh.add(ring);
  const dot=new THREE.Mesh(new THREE.SphereGeometry(radius*.15,8,8),new THREE.MeshBasicMaterial({color:0xffffff}));
  dot.position.z=radius*.85; mesh.add(dot);
  return mesh;
}

function spawnTarget3D(modeId){
  if(!state.running||!scene) return;
  const d=DIFF[state.diff],[minL,maxL]=d.life,life=minL+Math.random()*(maxL-minL);
  let r; if(modeId==='micro') r=(d.minR*.5+Math.random()*d.minR*.3)*CFG.tgt.sizeMult; else r=(d.minR+Math.random()*(d.maxR-d.minR))*CFG.tgt.sizeMult;
  let x,y; const z=-10-Math.random()*10;
  if(modeId==='strafe'){ x=(Math.random()<.5?-1:1)*(4+Math.random()*6); y=1+Math.random()*3; }
  else if(modeId==='wide'){ x=(Math.random()<.5?-1:1)*(5+Math.random()*7); y=.5+Math.random()*3.5; }
  else{ x=(Math.random()-.5)*14; y=.5+Math.random()*4; }
  const mesh=makeTargetMesh(r,modeId); mesh.position.set(x,y,z); mesh.scale.set(0,0,0); scene.add(mesh);
  const spd=d.speed*CFG.tgt.speedMult;
  let vx=(Math.random()-.5)*spd*(modeId==='strafe'?3:.6),vy=(Math.random()-.5)*spd*.3;
  if(modeId==='strafe'){ vx=(Math.random()<.5?-1:1)*spd*2; vy=0; }
  const tgt={mesh,modeId,radius:r,life,age:0,vx,vy,alive:true}; state.targets.push(tgt);
  let sa=0; const si=()=>{ sa+=.016; const s=Math.min(1,sa/.12); mesh.scale.set(s,s,s); if(s<1) requestAnimationFrame(si); }; requestAnimationFrame(si);
  return tgt;
}

let gridActive=-1;
function spawnGridShot(){
  state.targets.forEach(t=>scene.remove(t.mesh)); state.targets=[];
  const sx=-5.5,sy=1.2,stx=3.7,sty=2.4,z=-14;
  for(let r=0;r<2;r++)for(let c=0;c<4;c++){
    const mesh=makeTargetMesh(.22,'gridshot'); mesh.position.set(sx+c*stx,sy+r*sty,z); mesh.scale.set(.8,.8,.8); scene.add(mesh);
    state.targets.push({mesh,modeId:'gridshot',radius:.22,life:9999,age:0,vx:0,vy:0,alive:true,gridIdx:r*4+c});
  }
  gridActive=0; updateGridActive();
}
function updateGridActive(){ state.targets.forEach(t=>{ if(!t.mesh||!t.mesh.material)return; const a=t.gridIdx===gridActive; t.mesh.material.emissiveIntensity=a?.8:.1; t.mesh.material.opacity=a?1:.35; t.mesh.scale.set(a?1:.75,a?1:.75,a?1:.75); }); }

function startTracking3D(){
  const d=DIFF[state.diff],r=(d.minR+d.maxR)*.5*CFG.tgt.sizeMult;
  const tgt=spawnTarget3D('tracking');
  if(tgt){ tgt.vx=(Math.random()-.5)*d.speed*CFG.tgt.speedMult*1.5; tgt.vy=(Math.random()-.5)*d.speed*CFG.tgt.speedMult; }
  state.trackData={frames:0,onFrames:0}; startTimer();
}

function updateTracking(dt){
  if(!state.trackData||!state.running||!state.targets[0]) return;
  state.trackData.frames++;
  const tgt=state.targets[0]; if(!tgt.mesh) return;
  raycaster.setFromCamera(new THREE.Vector2(0,0),camera);
  const hits=raycaster.intersectObject(tgt.mesh,false);
  if(hits.length>0){ state.trackData.onFrames++; state.score+=3; state.hits++; tgt.mesh.material.emissiveIntensity=.9; } else tgt.mesh.material.emissiveIntensity=.3;
  state.shots++;
  const pct=Math.round(state.trackData.onFrames/state.trackData.frames*100);
  accPct.textContent=pct; accFill.style.width=pct+'%'; scoreVal.textContent=state.score.toLocaleString();
}

function updateTargets(dt){
  const d=DIFF[state.diff],m=state.modeId;
  state.targets.forEach(tgt=>{
    if(!tgt.alive||m==='gridshot') return;
    tgt.age+=dt; tgt.mesh.position.x+=tgt.vx*dt; tgt.mesh.position.y+=tgt.vy*dt;
    const px=tgt.mesh.position.x,py=tgt.mesh.position.y;
    if(Math.abs(px)>13){ tgt.vx*=-1; tgt.mesh.position.x=Math.sign(px)*13; }
    if(py<.3){ tgt.vy=Math.abs(tgt.vy); tgt.mesh.position.y=.3; } if(py>6){ tgt.vy=-Math.abs(tgt.vy); tgt.mesh.position.y=6; }
    if(Math.random()<.008*dt*60){ tgt.vx+=(Math.random()-.5)*d.speed*CFG.tgt.speedMult*.3; tgt.vy+=(Math.random()-.5)*d.speed*CFG.tgt.speedMult*.2; }
    if(tgt.mesh.children[0]){ tgt.mesh.children[0].rotation.y+=dt*1.5; tgt.mesh.children[0].rotation.x+=dt*.8; }
    if(m!=='tracking'){ tgt.mesh.material.opacity=Math.max(0,1-Math.pow(tgt.age/tgt.life,3)*.5); if(tgt.age>=tgt.life){ if(m==='survival') loseLife(); removeTarget3D(tgt); } }
  });
}

function onShoot(){
  if(!state.running||!locked) return;
  const m=state.modeId;
  if(m==='tracking') return;
  playGunshot(); triggerShoot();
  const ch=document.getElementById('crosshair'); ch.classList.add('shoot'); setTimeout(()=>ch.classList.remove('shoot'),100);
  if(m==='gridshot'){
    const at=state.targets.find(t=>t.gridIdx===gridActive);
    if(at){ raycaster.setFromCamera(new THREE.Vector2(0,0),camera); if(raycaster.intersectObject(at.mesh,false).length>0){ gridHit(at); return; } }
    recordMiss(); return;
  }
  raycaster.setFromCamera(new THREE.Vector2(0,0),camera);
  const hits=raycaster.intersectObjects(state.targets.map(t=>t.mesh).filter(Boolean),false);
  if(hits.length>0){
    const ht=state.targets.find(t=>t.mesh===hits[0].object||t.mesh===hits[0].object.parent);
    if(ht&&ht.alive){ recordHit(ht); if(m==='flicking') setTimeout(spawnFor3D,200); } else recordMiss();
  } else recordMiss();
}

function recordHit(tgt){
  state.hits++; state.shots++; state.combo++; if(state.combo>state.bestCombo) state.bestCombo=state.combo;
  const pts=calcPts(tgt); state.score+=pts;
  playHitSound(); showHitFlash();
  if(CFG.vis.combo&&state.combo>=2){ comboNum.textContent=state.combo; comboDisp.classList.add('show'); clearTimeout(state.comboT); state.comboT=setTimeout(()=>comboDisp.classList.remove('show'),1500); }
  showFloatPts(pts,tgt.mesh.position); removeTarget3D(tgt); updateHUD();
}

function gridHit(tgt){
  state.hits++; state.shots++; state.combo++; if(state.combo>state.bestCombo) state.bestCombo=state.combo;
  const pts=150+Math.min(state.combo,10)*10; state.score+=pts;
  playHitSound(); showHitFlash(); showFloatPts(pts,tgt.mesh.position);
  gridActive++; if(gridActive>=8){ gridActive=0; state.score+=200; } updateGridActive(); updateHUD();
}

function recordMiss(){ state.shots++; state.combo=0; comboDisp.classList.remove('show'); playMissSound(); updateHUD(); }
function loseLife(){ if(!state.running) return; state.lives--; updateLives(); if(state.lives<=0) setTimeout(endGame,300); }
function calcPts(tgt){ const base={clicking:100,flicking:180,micro:280,strafe:130,survival:90,wide:120,gridshot:150}[tgt.modeId]||100; return Math.max(base+Math.round(Math.max(0,(.3-tgt.radius)*300))+Math.min(state.combo,10)*10,30); }
function showHitFlash(){ const f=document.getElementById('hit-flash'); f.classList.add('show'); setTimeout(()=>f.classList.remove('show'),80); }

function showFloatPts(pts,worldPos){
  if(!CFG.vis.pts) return;
  const v=worldPos.clone().project(camera);
  const x=(v.x*.5+.5)*window.innerWidth,y=(-.5*v.y+.5)*window.innerHeight;
  const el=document.createElement('div');
  el.textContent='+'+pts;
  el.style.cssText=`position:fixed;left:${x}px;top:${y}px;font-family:Orbitron,monospace;font-weight:700;font-size:1rem;color:#e040fb;text-shadow:0 0 10px #e040fb;pointer-events:none;z-index:60;transform:translate(-50%,-50%);animation:float-up .7s ease-out forwards;`;
  document.body.appendChild(el); setTimeout(()=>el.remove(),700);
}

function removeTarget3D(tgt){
  if(!tgt.alive) return; tgt.alive=false;
  let a=0; const s=()=>{ a+=.016; const sc=Math.max(0,1-a/.1); if(tgt.mesh){ tgt.mesh.scale.set(sc,sc,sc); if(sc>0) requestAnimationFrame(s); else scene.remove(tgt.mesh); } }; requestAnimationFrame(s);
  state.targets=state.targets.filter(t=>t!==tgt);
}

function updateHUD(){ scoreVal.textContent=state.score.toLocaleString(); shotsVal.textContent=state.shots+' / '+state.hits; const acc=state.shots>0?Math.round(state.hits/state.shots*100):0; accPct.textContent=acc; accFill.style.width=acc+'%'; }

document.getElementById('quit-btn').addEventListener('click',endGame);

function endGame(){
  state.running=false; clearInterval(state.timerIv); clearInterval(state.spawnIv);
  document.exitPointerLock();
  state.targets.forEach(t=>{ if(t.mesh) scene.remove(t.mesh); }); state.targets=[];
  document.getElementById('three-canvas').style.display='none';
  document.getElementById('mobile-controls').classList.remove('active');
  hud.style.display='none'; bottomBar.style.display='none'; crosshairEl.style.display='none';
  document.getElementById('pause-overlay').style.display='none'; paused=false;
  const fpsV=document.getElementById('fps-val'); if(fpsV) fpsV.textContent='‚Äî';
  document.getElementById('lives-hud').style.display='none'; document.getElementById('lock-overlay').style.display='none';
  comboDisp.classList.remove('show'); timerVal.classList.remove('warn');
  if(animFrameId){ cancelAnimationFrame(animFrameId); animFrameId=null; }
  const acc=state.shots>0?Math.round(state.hits/state.shots*100):0;
  document.getElementById('r-score').textContent=state.score.toLocaleString();
  document.getElementById('r-acc').textContent=acc+'%';
  document.getElementById('r-hits').textContent=state.hits;
  document.getElementById('r-misses').textContent=Math.max(0,state.shots-state.hits);
  document.getElementById('r-combo').textContent=state.bestCombo;
  document.getElementById('r-mode').textContent=MODES[state.modeId]?.name||'‚Äî';
  const g=getGrade(acc),ge=document.getElementById('grade-el');
  ge.textContent=g.label; ge.style.color=g.color; ge.style.textShadow=`0 0 30px ${g.color}`;
  if(currentUser&&state.score>0) submitScore({ score:state.score, acc, hits:state.hits, shots:state.shots, combo:state.bestCombo, mode:state.modeId, diff:state.diff, ts:Date.now() });
  resultsScreen.classList.remove('hidden');
}

function getGrade(acc){ if(acc>=90)return{label:'S+',color:'#ffd700'};if(acc>=75)return{label:'A',color:'#00ff88'};if(acc>=60)return{label:'B',color:'#00e5ff'};if(acc>=40)return{label:'C',color:'#a259ff'};return{label:'D',color:'#ff3d71'}; }
document.getElementById('play-again-btn').addEventListener('click',()=>{ resultsScreen.classList.add('hidden'); startGame(state.modeId,state.diff); });
document.getElementById('menu-btn').addEventListener('click',()=>{ resultsScreen.classList.add('hidden'); menuScreen.classList.remove('hidden'); });

// ============================================================
// MODO ONLINE MULTIJUGADOR
// ============================================================
const ONLINE_SRV = location.protocol==='https:' ? 'wss://'+location.host : 'ws://'+location.host;
const TEAM_COLORS=[0xff4444,0x4488ff,0x44cc66,0xffcc00,0xcc44ff,0x44cccc,0xff8844,0x88ff44];
const TEAM_HEX   =['#ff4444','#4488ff','#44cc66','#ffcc00','#cc44ff','#44cccc','#ff8844','#88ff44'];
const TEAM_LBL   =['ROJO','AZUL','VERDE','AMARILLO','MORADO','CYAN','NARANJA','LIMA'];

let onWS=null, onMySlot=-1, onMyTeam=-1, onMySpawn=null, onMyName='';
let onRoomMode='1v1', onFirstTo=6;
let onActive=false, onLocked=false, onAlive=true;
let onPos={x:0,z:0}, onYaw=0, onPitch=0;
const onOpps=new Map(), onPlayerNames=new Map();
let onTeamScores=[0,0], onPScores={};
let onCreateMode='1v1', onWaitPlayers=[];

function onUpdateOnlineCount(count) {
  const m = document.getElementById('menu-online-count');
  const l = document.getElementById('lobby-online-count');
  if (m) m.textContent = count;
  if (l) l.textContent = count;
}

let onPing = 0, onPingIv = null, onReconnectT = null;

function onUpdatePingDisplay() {
  const pingEl = document.getElementById('duel-ping-hud');
  const qualEl = document.getElementById('duel-conn-quality');
  if (!pingEl) return;
  pingEl.textContent = onPing + ' MS';
  let color, label;
  if (onPing === 0) { color = 'var(--dim)'; label = '‚óè ‚Äî'; }
  else if (onPing < 60) { color = '#00ff88'; label = '‚óè BUENA'; if(qualEl){qualEl.className='';qualEl.style.background='rgba(0,255,136,.08)';} }
  else if (onPing < 120) { color = '#ffd700'; label = '‚óè MEDIA'; if(qualEl){qualEl.className='';qualEl.style.background='rgba(255,215,0,.08)';} }
  else { color = '#ff3d71'; label = '‚óè ALTA'; if(qualEl){qualEl.className='ping-bad';qualEl.style.background='rgba(255,61,113,.08)';} }
  pingEl.style.color = color;
  if (qualEl) { qualEl.textContent = label; qualEl.style.color = color; }
}

function onUpdateLobbyStatus(connected) {
  const dot = document.getElementById('lobby-conn-dot');
  const lbl = document.getElementById('lobby-conn-label');
  if (!dot || !lbl) return;
  if (connected) { dot.style.background='#00ff88'; lbl.textContent='CONECTADO'; lbl.style.color='#00ff88'; dot.style.animation=''; }
  else { dot.style.background='#ff3d71'; lbl.textContent='DESCONECTADO ¬∑ Reconectando...'; lbl.style.color='#ff3d71'; dot.style.animation='ping-pulse .8s infinite'; }
}

let onScene=null, onCamera=null, onRenderer=null, onRaycaster=null;
let onYawObj=null, onPitchObj=null, onGun=null, onGunAnim=0;
let onAnimId=null, onStateIv=null, onCanShoot=true;
const onWalls=[], onObs=[];
const onKeys={};
let onMX=0, onMY=0, onThreeReady=false;
const ON_H=1.65, ON_SPD=7.5, ON_SENS=.002, ON_CD=1500;
const ON_GRAVITY=22, ON_JUMP_FORCE=8.0;
let onVelY=0, onPosY=0, onIsGrounded=true;

// ‚îÄ‚îÄ SISTEMA DE ARMAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WEAPONS = {
  pistol:  { name:'PISTOLA',  key:'1', dmgHead:50, dmgBody:25, dmgLegs:15, cd:900,  spread:0,    ammoMax:12, reload:1600, pellets:1, color:0x999999 },
  rifle:   { name:'RIFLE',    key:'2', dmgHead:50, dmgBody:25, dmgLegs:15, cd:140,  spread:0.012,ammoMax:30, reload:2000, pellets:1, color:0x334455 },
  shotgun: { name:'ESCOPETA', key:'3', dmgHead:50, dmgBody:25, dmgLegs:15, cd:850,  spread:0.09, ammoMax:6,  reload:2400, pellets:7, color:0x553322 }
};
let onCurWeapon = 'pistol';
let onAmmo      = { pistol:12, rifle:30, shotgun:6 };
let onReloading = false;
let onReloadT   = null;
let onMyHP      = 100;
let onGrenades  = 2;
let onGrenCooldown = false;
const onGrenList = [];

document.getElementById('open-1v1-btn').addEventListener('click',()=>{
  menuScreen.classList.add('hidden'); onShowScreen('duel-lobby-screen');
  onMyName = currentUser?.name||'Jugador'; onConnect();
});
document.getElementById('duel-lobby-back').addEventListener('click',()=>{
  onDisconnect(); onShowScreen(null); menuScreen.classList.remove('hidden');
});
document.getElementById('duel-refresh-rooms').addEventListener('click',()=>onSend({type:'get_rooms'}));
document.getElementById('duel-open-create').addEventListener('click',()=>{
  document.getElementById('duel-room-name').value=''; document.getElementById('duel-create-err').textContent='';
  document.getElementById('duel-is-private').checked=false; document.getElementById('duel-password-wrap').style.display='none';
  onShowScreen('duel-create-screen');
});
document.getElementById('duel-create-back-btn').addEventListener('click',()=>onShowScreen('duel-lobby-screen'));
document.getElementById('duel-is-private').addEventListener('change',function(){ document.getElementById('duel-password-wrap').style.display=this.checked?'block':'none'; });
document.querySelectorAll('#duel-mode-pills .diff-btn').forEach(b=>b.addEventListener('click',()=>{ document.querySelectorAll('#duel-mode-pills .diff-btn').forEach(x=>x.classList.remove('act')); b.classList.add('act'); onCreateMode=b.dataset.mode; }));
document.getElementById('duel-do-create').addEventListener('click',()=>{
  const name=document.getElementById('duel-room-name').value.trim();
  const isPrivate=document.getElementById('duel-is-private').checked;
  const pw=document.getElementById('duel-room-password').value;
  if(!name){document.getElementById('duel-create-err').textContent='Pon un nombre a la sala';return;}
  if(isPrivate&&!pw){document.getElementById('duel-create-err').textContent='Pon una contrase√±a';return;}
  if(!onWS||onWS.readyState!==1){document.getElementById('duel-create-err').textContent='Sin conexi√≥n al servidor';return;}
  onSend({type:'create_room',name,mode:onCreateMode,isPrivate,password:pw,playerName:onMyName});
});
document.getElementById('duel-waiting-back').addEventListener('click',()=>{ onWS?.close(); onCleanup(); onShowScreen('duel-lobby-screen'); onConnect(); });
document.getElementById('duel-force-start').addEventListener('click',()=>onSend({type:'force_start'}));
document.getElementById('duel-rematch-btn').addEventListener('click',()=>{ onWS?.close(); onCleanup(); onShowScreen('duel-lobby-screen'); onConnect(); });
document.getElementById('duel-menu-btn').addEventListener('click',()=>{ onWS?.close(); onCleanup(); onShowScreen(null); menuScreen.classList.remove('hidden'); });

function onShowScreen(id){
  ['duel-lobby-screen','duel-create-screen','duel-waiting-screen','duel-gameover-screen'].forEach(s=>document.getElementById(s).classList.add('hidden'));
  if(id) document.getElementById(id).classList.remove('hidden');
}

function onSendChat() {
  const input = document.getElementById('duel-chat-input');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  onSend({ type: 'chat', text });
  input.value = '';
}

function onHandleChatMsg(msg) {
  const el = document.getElementById('duel-chat-msgs');
  if (!el) return;
  const div = document.createElement('div');
  const isMe = !msg.system && msg.slot === onMySlot;
  if (msg.system) {
    div.style.cssText = 'font-size:.58rem;color:var(--dim);font-style:italic;padding:1px 0;';
    div.textContent = '¬∑ ' + msg.text;
  } else {
    div.style.cssText = `font-size:.6rem;padding:1px 0;color:${isMe?'var(--accent)':'var(--text)'}`;
    div.innerHTML = `<span style="color:${isMe?'var(--accent)':'#7a9acc'};font-weight:700">[${esc(msg.sender)}]</span> ${esc(msg.text)}`;
  }
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const chatInput = document.getElementById('duel-chat-input');
    if (chatInput && document.activeElement === chatInput) onSendChat();
  }
});

function onConnect() {
  if (onWS && onWS.readyState <= 1) return;
  onUpdateLobbyStatus(false);
  try { onWS = new WebSocket(ONLINE_SRV); } catch(e) { onLobbyErr('No se pudo conectar al servidor'); return; }
  onWS.onopen = () => {
    onUpdateLobbyStatus(true);
    onSend({ type: 'get_rooms' });
    clearInterval(onPingIv);
    onPingIv = setInterval(() => { if (onWS && onWS.readyState === 1) onSend({ type: 'ping', t: Date.now() }); }, 2000);
  };
  onWS.onmessage = e => { try { onMsg(JSON.parse(e.data)); } catch(err) { console.error('onMsg:', err); } };
  onWS.onclose = e => {
    clearInterval(onPingIv); onPingIv = null;
    onUpdateLobbyStatus(false);
    if (onActive) { onSetErr('Conexi√≥n perdida'); }
    else { onLobbyErr('Desconectado ¬∑ reconectando en 3s...'); clearTimeout(onReconnectT); onReconnectT = setTimeout(() => { if (!onActive) onConnect(); }, 3000); }
  };
  onWS.onerror = () => { onUpdateLobbyStatus(false); onLobbyErr('Error de conexi√≥n con el servidor'); };
}
function onDisconnect() { clearInterval(onPingIv); if(onWS){onWS.onclose=null;onWS.close();onWS=null;} }
function onSend(msg) { if(onWS&&onWS.readyState===1) onWS.send(JSON.stringify(msg)); }

function onMsg(msg) {
  switch(msg.type) {
    case 'pong': onPing = Date.now() - msg.t; onUpdatePingDisplay(); break;
    case 'online_count': onUpdateOnlineCount(msg.count); break;
    case 'room_list':    onUpdateRoomList(msg.rooms); break;
    case 'room_joined':  onRoomJoined(msg); break;
    case 'player_joined': onPlayerJoined(msg); break;
    case 'chat_msg':     onHandleChatMsg(msg); break;
    case 'start':        setTimeout(()=>onStartGame(msg), 150); break;
    case 'opp_state':    onUpdateOpp(msg.slot,msg.pos,msg.yaw,msg.pitch||0,msg.posY||0); break;
    case 'opp_shoot':  { const o=onOpps.get(msg.slot); if(o&&o.group.userData.anim) o.group.userData.anim.shootT=1; break; }
    case 'kill':         onTeamScores=msg.teamScores; onPScores=msg.pScores; onHandleKill(msg); break;
    case 'damage':       onHandleDamage(msg); break;
    case 'opp_hp':       onHandleOppHP(msg); break;
    case 'opp_grenade':  onHandleOppGrenade(msg); break;
    case 'respawn':      onHandleRespawn(msg.spawn); break;
    case 'player_respawn': onHandlePlayerRespawn(msg.slot,msg.spawn); break;
    case 'join_err':     onLobbyErr(msg.msg); break;
    case 'opp_disconnect': onSetErr((msg.name||'Un jugador')+' se desconect√≥'); break;
  }
}

function onRoomJoined(msg) {
  onMySlot=msg.slot; onMyTeam=msg.team; onMySpawn=msg.spawn;
  onRoomMode=msg.mode; onFirstTo=msg.firstTo;
  onWaitPlayers=msg.players||[{slot:msg.slot,team:msg.team,name:onMyName}];
  onPlayerNames.clear(); onWaitPlayers.forEach(p=>onPlayerNames.set(p.slot,p.name));
  document.getElementById('duel-room-info').textContent = msg.name+' ¬∑ '+msg.mode.toUpperCase()+' ¬∑ Primero en '+msg.firstTo+' kills gana';
  document.getElementById('duel-share-url').textContent = location.href;
  document.getElementById('duel-force-start').style.display = msg.slot===0?'block':'none';
  const chatEl = document.getElementById('duel-chat-msgs');
  if (chatEl && msg.chatHistory) { chatEl.innerHTML=''; msg.chatHistory.forEach(m=>onHandleChatMsg(m)); }
  onRenderWaitingPlayers(msg.max); onUpdateStartBtn(); onShowScreen('duel-waiting-screen');
}
function onPlayerJoined(p) {
  if(!onWaitPlayers.find(x=>x.slot===p.slot)) onWaitPlayers.push(p);
  onPlayerNames.set(p.slot,p.name); onRenderWaitingPlayers(); onUpdateStartBtn();
  if(onThreeReady) onAddOppMesh(p.slot,p.team);
}
function onUpdateStartBtn() {
  const btn=document.getElementById('duel-force-start'); if(!btn) return;
  const ready=onWaitPlayers.length>=2;
  btn.style.background=ready?'#ff3d71':'#555566';
  btn.style.color=ready?'#fff':'#aaa';
  btn.style.boxShadow=ready?'0 0 18px rgba(255,61,113,.5)':'none';
  btn.style.opacity=ready?'1':'.5';
  btn.textContent=ready?'‚ñ∂ INICIAR PARTIDA':'‚è≥ ESPERANDO JUGADORES...';
  btn.style.cursor=ready?'pointer':'not-allowed';
  btn.disabled=!ready;
}
function onRenderWaitingPlayers(max) {
  const el=document.getElementById('duel-players-in-room'); el.innerHTML='';
  const total=max||onWaitPlayers.length;
  for(let i=0;i<total;i++){
    const p=onWaitPlayers[i], div=document.createElement('div'); div.className='player-slot';
    if(p){
      const col=TEAM_HEX[p.team]||'#fff', isMe=p.slot===onMySlot;
      div.innerHTML=`<span style="width:10px;height:10px;border-radius:2px;background:${col};display:inline-block;flex-shrink:0"></span><span style="font-size:.68rem;color:${isMe?'var(--accent)':'var(--text)'}">${esc(p.name)}${isMe?' (T√∫)':''}</span><span style="margin-left:auto;font-size:.55rem;letter-spacing:.15em;font-weight:700;color:${col}">${TEAM_LBL[p.team]||'?'}</span>`;
    } else {
      div.innerHTML=`<span style="width:10px;height:10px;border-radius:2px;background:var(--border);display:inline-block"></span><span style="font-size:.6rem;color:var(--dim);font-style:italic">Esperando jugador...</span>`;
    }
    el.appendChild(div);
  }
}

function onUpdateRoomList(rooms) {
  const el=document.getElementById('duel-room-list');
  if(!rooms||!rooms.length){ el.innerHTML='<div style="text-align:center;color:var(--dim);font-size:.68rem;letter-spacing:.15em;padding:28px">No hay salas disponibles. ¬°Crea la primera!</div>'; return; }
  el.innerHTML='';
  rooms.forEach(r=>{
    const card=document.createElement('div'); card.className='room-card';
    const ml={'1v1':'1v1','2v2':'2v2','3v3':'3v3','4v4':'4v4','ffa':'FFA'}[r.mode]||r.mode;
    card.innerHTML=`<div style="display:flex;flex-direction:column;gap:3px"><span class="room-nm">${r.isPrivate?'üîí ':''}${esc(r.name)}</span><span style="font-size:.54rem;color:var(--dim)">${ml} ¬∑ ${r.players}/${r.max} jugadores</span></div><div style="display:flex;gap:7px;align-items:center"><span style="font-size:.52rem;letter-spacing:.2em;color:var(--accent);background:rgba(224,64,251,.1);padding:2px 8px">${ml}</span><button class="room-join" onclick="onJoinClick(${r.id},${r.isPrivate})">ENTRAR ‚Üí</button></div>`;
    el.appendChild(card);
  });
}
function onJoinClick(roomId,isPrivate){
  if(isPrivate){ const pw=prompt('Contrase√±a de la sala:'); if(pw===null) return; onSend({type:'join_room',roomId,playerName:onMyName,password:pw}); }
  else onSend({type:'join_room',roomId,playerName:onMyName,password:''});
}
function onLobbyErr(msg){ const el=document.getElementById('duel-lobby-err'); if(el){el.textContent='‚ö† '+msg;setTimeout(()=>el.textContent='',5000);} }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function onInitThree(){
  const cv=document.getElementById('duel-canvas');
  onRenderer=new THREE.WebGLRenderer({canvas:cv,antialias:true,powerPreference:'high-performance'});
  onRenderer.setPixelRatio(Math.min(window.devicePixelRatio,2)); onRenderer.setSize(window.innerWidth,window.innerHeight); onRenderer.shadowMap.enabled=true;
  onScene=new THREE.Scene(); onScene.background=new THREE.Color(0x87ceeb); onScene.fog=new THREE.Fog(0x87ceeb,28,70);
  onYawObj=new THREE.Object3D(); onPitchObj=new THREE.Object3D(); onYawObj.add(onPitchObj); onScene.add(onYawObj);
  onCamera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.05,200); onPitchObj.add(onCamera);
  onRaycaster=new THREE.Raycaster(); onRaycaster.far=150;
  window.addEventListener('resize',()=>{ onCamera.aspect=window.innerWidth/window.innerHeight; onCamera.updateProjectionMatrix(); onRenderer.setSize(window.innerWidth,window.innerHeight); });
  onBuildMap(); onBuildLights(); onBuildGun(); onThreeReady=true;
}

function onBuildGun(){
  if(onGun){ onCamera.remove(onGun); onGun=null; }
  onGun=new THREE.Group();
  const wp=WEAPONS[onCurWeapon];
  const m1=new THREE.MeshLambertMaterial({color:0x1a1a2a}),m2=new THREE.MeshLambertMaterial({color:0x0a0a0f}),m4=new THREE.MeshLambertMaterial({color:0x333348});
  const mAcc=new THREE.MeshLambertMaterial({color:wp.color,emissive:wp.color,emissiveIntensity:.5});
  if(onCurWeapon==='pistol'){
    const body=new THREE.Mesh(new THREE.BoxGeometry(.065,.085,.4),m1); onGun.add(body);
    const slide=new THREE.Mesh(new THREE.BoxGeometry(.05,.04,.36),m4); slide.position.set(0,.065,-.01); onGun.add(slide);
    const barrel=new THREE.Mesh(new THREE.BoxGeometry(.03,.03,.18),m2); barrel.position.set(0,.03,-.29); onGun.add(barrel);
    const tip=new THREE.Mesh(new THREE.BoxGeometry(.034,.034,.04),m2); tip.position.set(0,.03,-.39); onGun.add(tip);
    const handle=new THREE.Mesh(new THREE.BoxGeometry(.055,.12,.065),m1); handle.position.set(0,-.1,.06); handle.rotation.x=.2; onGun.add(handle);
    const stripe=new THREE.Mesh(new THREE.BoxGeometry(.067,.007,.18),mAcc); stripe.position.set(0,.048,.0); onGun.add(stripe);
    onGun.position.set(.19,-.19,-.33); onGun.rotation.y=.05;
  } else if(onCurWeapon==='rifle'){
    const body=new THREE.Mesh(new THREE.BoxGeometry(.055,.075,.65),m1); onGun.add(body);
    const top=new THREE.Mesh(new THREE.BoxGeometry(.04,.03,.55),m4); top.position.set(0,.055,0); onGun.add(top);
    const barrel=new THREE.Mesh(new THREE.BoxGeometry(.028,.028,.3),m2); barrel.position.set(0,.02,-.47); onGun.add(barrel);
    const muzzle=new THREE.Mesh(new THREE.BoxGeometry(.04,.04,.06),m2); muzzle.position.set(0,.02,-.63); onGun.add(muzzle);
    const stock=new THREE.Mesh(new THREE.BoxGeometry(.05,.07,.18),m4); stock.position.set(0,-.01,.36); stock.rotation.x=.05; onGun.add(stock);
    const handle=new THREE.Mesh(new THREE.BoxGeometry(.048,.13,.065),m1); handle.position.set(0,-.1,.12); handle.rotation.x=.18; onGun.add(handle);
    const scope=new THREE.Mesh(new THREE.BoxGeometry(.03,.03,.2),mAcc); scope.position.set(0,.075,.05); onGun.add(scope);
    const mag=new THREE.Mesh(new THREE.BoxGeometry(.04,.1,.055),m2); mag.position.set(0,-.06,.07); onGun.add(mag);
    onGun.position.set(.2,-.18,-.42); onGun.rotation.y=.04;
  } else if(onCurWeapon==='shotgun'){
    const body=new THREE.Mesh(new THREE.BoxGeometry(.07,.09,.55),m1); onGun.add(body);
    const barrel1=new THREE.Mesh(new THREE.BoxGeometry(.03,.028,.38),m2); barrel1.position.set(-.022,.01,-.34); onGun.add(barrel1);
    const barrel2=new THREE.Mesh(new THREE.BoxGeometry(.03,.028,.38),m2); barrel2.position.set(.022,.01,-.34); onGun.add(barrel2);
    const muzzle=new THREE.Mesh(new THREE.BoxGeometry(.075,.04,.07),m2); muzzle.position.set(0,.01,-.57); onGun.add(muzzle);
    const stock=new THREE.Mesh(new THREE.BoxGeometry(.06,.085,.22),mAcc); stock.position.set(0,-.01,.3); onGun.add(stock);
    const handle=new THREE.Mesh(new THREE.BoxGeometry(.055,.14,.07),m1); handle.position.set(0,-.1,.08); handle.rotation.x=.2; onGun.add(handle);
    const pump=new THREE.Mesh(new THREE.BoxGeometry(.065,.055,.14),m4); pump.position.set(0,-.018,-.12); onGun.add(pump);
    onGun.position.set(.2,-.2,-.38); onGun.rotation.y=.05;
  }
  onCamera.add(onGun);
}

function onAnimGun(dt){
  if(!onGun) return;
  if(onGunAnim>0){ onGunAnim=Math.max(0,onGunAnim-dt*9); onGun.position.z=-.33+onGunAnim*.06; onGun.rotation.x=onGunAnim*.12; }
  else{ onGun.position.z+=(-.33-onGun.position.z)*dt*9; onGun.rotation.x*=(1-dt*9); }
  onGun.position.y=-.19+Math.sin(performance.now()*.0009)*.003;
}

function onBuildMap(){
  // Limpiar objetos del mapa zombie si exist√≠an
  const toRemove=[];
  onScene.children.forEach(c=>{ if(c.userData.isMapObj) toRemove.push(c); });
  toRemove.forEach(c=>onScene.remove(c));
  onWalls.length=0; onObs.length=0;
  // Restaurar cielo/niebla PVP
  onScene.background=new THREE.Color(0x87ceeb);
  onScene.fog=new THREE.Fog(0x87ceeb,30,75);
  // ‚îÄ‚îÄ SUELO: tierra con caminos, c√©sped y logo INA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const gc=document.createElement('canvas'); gc.width=gc.height=1024;
  const gx=gc.getContext('2d');
  // Base tierra
  gx.fillStyle='#8B6914'; gx.fillRect(0,0,1024,1024);
  // Parches de hierba
  gx.fillStyle='#4a7c3f';
  [[0,0,220,220],[804,0,220,220],[0,804,220,220],[804,804,220,220],
   [200,350,120,80],[650,600,110,90],[300,700,90,70],[700,280,80,90]].forEach(([x,y,w,h])=>gx.fillRect(x,y,w,h));
  // Caminos de tierra m√°s claros
  gx.fillStyle='#a07830';
  gx.fillRect(400,0,224,1024); gx.fillRect(0,400,1024,224);
  // Logo INA en el centro
  gx.save(); gx.globalAlpha=.18; gx.font='bold 160px Arial Black';
  gx.textAlign='center'; gx.textBaseline='middle'; gx.fillStyle='#fff';
  gx.fillText('INA',512,512); gx.restore();
  // Borde ovalado (asfalto)
  gx.strokeStyle='#555555'; gx.lineWidth=40;
  gx.beginPath(); gx.ellipse(512,512,490,490,0,0,Math.PI*2); gx.stroke();

  const groundTex = new THREE.CanvasTexture(gc);
  groundTex.wrapS=groundTex.wrapT=THREE.RepeatWrapping; groundTex.repeat.set(1,1);
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(44,44),new THREE.MeshLambertMaterial({map:groundTex}));
  ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; ground.userData.isMapObj=true; onScene.add(ground);

  // ‚îÄ‚îÄ CIELO / FOG ya seteado arriba ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // ‚îÄ‚îÄ MATERIALES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const concMat = new THREE.MeshLambertMaterial({color:0xaab0b8}); // concreto gris
  const concDark= new THREE.MeshLambertMaterial({color:0x8a9098});
  const sandMat = new THREE.MeshLambertMaterial({color:0xc8a86a}); // sacos arena
  const barrelR = new THREE.MeshLambertMaterial({color:0xcc2200});
  const barrelB = new THREE.MeshLambertMaterial({color:0x1144cc});
  const barrelG = new THREE.MeshLambertMaterial({color:0x226622});
  const woodMat = new THREE.MeshLambertMaterial({color:0x8B6020});
  const coneMat = new THREE.MeshLambertMaterial({color:0xff6600});

  function addConcreteWall(x,z,w,h,d,ry=0){
    const wall=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),concMat);
    wall.position.set(x,h/2,z); wall.rotation.y=ry;
    wall.castShadow=true; wall.receiveShadow=true; onScene.add(wall); onWalls.push(wall);
    // Cap
    const cap=new THREE.Mesh(new THREE.BoxGeometry(w+.1,.15,d+.1),concDark);
    cap.position.set(x,h+.075,z); cap.rotation.y=ry; onScene.add(cap);
    // Colisi√≥n
    const hw=ry!==0?(d/2+.45):(w/2+.45), hd=ry!==0?(w/2+.45):(d/2+.45);
    onObs.push({x,z,hw,hd});
  }

  function addSandbagWall(x,z,len,ry=0){
    const H=0.7,D=0.55;
    const wall=new THREE.Mesh(new THREE.BoxGeometry(len,H,D),sandMat);
    wall.position.set(x,H/2,z); wall.rotation.y=ry;
    wall.castShadow=true; onScene.add(wall);
    const hw=ry!==0?(D/2+.35):(len/2+.35), hd=ry!==0?(len/2+.35):(D/2+.35);
    onObs.push({x,z,hw,hd});
    // Detalle sacos individuales
    const nb=Math.floor(len/0.9);
    for(let i=0;i<nb;i++){
      const bx=(i-(nb-1)/2)*0.9, bag=new THREE.Mesh(new THREE.BoxGeometry(.75,.38,.5),sandMat);
      const cos_r=Math.cos(ry),sin_r=Math.sin(ry);
      bag.position.set(x+cos_r*bx,H/2+.22,z+sin_r*bx); bag.rotation.y=ry; onScene.add(bag);
    }
  }

  function addBarrel(x,z,mat){
    const b=new THREE.Mesh(new THREE.CylinderGeometry(.28,.28,.7,10),mat);
    b.position.set(x,.35,z); b.castShadow=true; onScene.add(b);
    onObs.push({x,z,hw:.55,hd:.55});
  }

  function addCrate(x,z,s=1){
    const c=new THREE.Mesh(new THREE.BoxGeometry(.8*s,.8*s,.8*s),woodMat);
    c.position.set(x,.4*s,z); c.castShadow=true; onScene.add(c);
    const lines=new THREE.EdgesGeometry(c.geometry);
    const lm=new THREE.LineSegments(lines,new THREE.LineBasicMaterial({color:0x5a3a00}));
    lm.position.copy(c.position); onScene.add(lm);
    onObs.push({x,z,hw:.6*s,hd:.6*s});
  }

  function addCone(x,z){
    const g=new THREE.ConeGeometry(.18,.55,8);
    const c=new THREE.Mesh(g,coneMat); c.position.set(x,.275,z); onScene.add(c);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PAREDES DE CONCRETO CENTRALES (basadas en la imagen)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Estructura superior-central: forma T/L
  addConcreteWall(-1, -7,  5.5, 1.8, .5);      // horizontal izq-centro arriba
  addConcreteWall( 5, -7,  4.0, 1.8, .5);      // horizontal der arriba
  addConcreteWall(-1, -4.5,.5, 1.8, 4.5, 0);   // vertical izq centro

  // Estructura izquierda-centro: L
  addConcreteWall(-7, -1,  4.5, 1.8, .5);      // horizontal izq
  addConcreteWall(-7,  2,  .5,  1.8, 4.0, 0);  // vertical izq baja

  // Estructura derecha-centro: L
  addConcreteWall( 7,  0,  4.5, 1.8, .5);      // horizontal der
  addConcreteWall( 7, -3,  .5,  1.8, 3.5, 0);  // vertical der alta

  // Estructura inferior-central: U abierta
  addConcreteWall( 0,  7,  5.5, 1.8, .5);      // horizontal inferior
  addConcreteWall(-2.5, 5, .5,  1.8, 3.5, 0);  // vertical izq inferior
  addConcreteWall( 2.5, 5, .5,  1.8, 3.5, 0);  // vertical der inferior

  // Pared central horizontal corta
  addConcreteWall( 2, -1,  3.5, 1.8, .5);      // centro mapa
  addConcreteWall(-3,  2,  3.5, 1.8, .5);      // centro mapa 2

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SACOS DE ARENA PERIMETRALES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Esquina superior-izquierda
  addSandbagWall(-14,-13, 4.5);
  addSandbagWall(-16,-11, 3.5, Math.PI/2);
  addSandbagWall(-12,-15, 3.0);
  // Esquina superior-derecha
  addSandbagWall( 14,-13, 4.5);
  addSandbagWall( 16,-11, 3.5, Math.PI/2);
  addSandbagWall( 12,-15, 3.0);
  // Esquina inferior-izquierda (zona camuflaje)
  addSandbagWall(-14, 14, 4.0);
  addSandbagWall(-16, 12, 3.0, Math.PI/2);
  addSandbagWall(-12, 16, 3.5);
  // Esquina inferior-derecha
  addSandbagWall( 14, 14, 4.0);
  addSandbagWall( 16, 12, 3.0, Math.PI/2);
  addSandbagWall( 12, 16, 3.5);
  // Laterales medio
  addSandbagWall(-17,  0, 5.0, Math.PI/2);
  addSandbagWall( 17,  0, 5.0, Math.PI/2);
  addSandbagWall(  0,-18, 5.0);
  addSandbagWall(  0, 18, 5.0);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BARRILES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Zona roja (arriba-izq)
  addBarrel(-16,-14,barrelR); addBarrel(-15,-13,barrelR); addBarrel(-14,-14,barrelG);
  // Zona azul (abajo-der)
  addBarrel( 16, 14,barrelB); addBarrel( 15, 13,barrelB); addBarrel( 14, 14,barrelG);
  // Dispersos
  addBarrel( 10,-10,barrelG); addBarrel(-10, 10,barrelR);
  addBarrel(  4,  4,barrelB); addBarrel( -4, -4,barrelG);
  addBarrel( 12,  2,barrelR); addBarrel(-12, -2,barrelB);
  addBarrel(  8,-15,barrelG); addBarrel( -8, 15,barrelR);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CAJAS/CRATES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  addCrate(-13,-13); addCrate(-12,-11); addCrate(-11,-13,1.2);
  addCrate( 13, 13); addCrate( 12, 11); addCrate( 11, 13,1.2);
  addCrate( 14, -8); addCrate( 13, -7);
  addCrate(-14,  8); addCrate(-13,  7);
  addCrate(  8,  8); addCrate( -8, -8);
  addCrate( 16,  4); addCrate( 15,  5);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONOS NARANJA (zona central)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  addCone(-2,-3); addCone(2,-3); addCone(0, 0);
  addCone(-4, 0); addCone(4,  2); addCone(-1, 4);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TECHO CAMUFLAJE (esquina inf-izq)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const camGeo=new THREE.PlaneGeometry(5,4);
  const camMat=new THREE.MeshLambertMaterial({color:0x3d5a2a,side:THREE.DoubleSide,transparent:true,opacity:.85});
  const cam=new THREE.Mesh(camGeo,camMat); cam.rotation.x=-Math.PI/2;
  cam.position.set(-14,1.8,14); onScene.add(cam);
  // Postes del techo camuflaje
  [[-.13,14,2.1],[.13,14,2.1],[-14,-.13,2.1],[-14,.13,2.1]].forEach(([dx,dz,h])=>{
    const p=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,h,6),new THREE.MeshLambertMaterial({color:0x4a3010}));
    p.position.set(-14+dx,h/2,14+dz); onScene.add(p);
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BASES ROJA Y AZUL
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  onAddBuilding(-16,-16, 0xdd3311, 'red');
  onAddBuilding( 16, 16, 0x1155cc, 'blue');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BORDE DEL MAPA (invisible, colisi√≥n)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  [{x:0,z:-21,w:44,d:.6},{x:0,z:21,w:44,d:.6},{x:-21,z:0,w:.6,d:44},{x:21,z:0,w:.6,d:44}].forEach(({x,z,w,d})=>{
    onObs.push({x,z,hw:w/2,hd:d/2});
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // √ÅRBOLES DECORATIVOS (esquinas)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  [[-19,-19],[ 19,-19],[-19, 19]].forEach(([tx,tz])=>{
    const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.18,.22,1.5,8),new THREE.MeshLambertMaterial({color:0x4a2e08}));
    trunk.position.set(tx,.75,tz); onScene.add(trunk);
    const leaves=new THREE.Mesh(new THREE.SphereGeometry(1.2,8,6),new THREE.MeshLambertMaterial({color:0x2d6e1a}));
    leaves.position.set(tx,2.5,tz); onScene.add(leaves);
  });
}

function onAddBuilding(cx,cz,color,team){
  const mat=new THREE.MeshLambertMaterial({color});
  const dmat=new THREE.MeshLambertMaterial({color:new THREE.Color(color).multiplyScalar(.3)});
  const roofmat=new THREE.MeshLambertMaterial({color:new THREE.Color(color).multiplyScalar(.7)});
  // Cuerpo
  const body=new THREE.Mesh(new THREE.BoxGeometry(5,2.8,4.5),mat);
  body.position.set(cx,1.4,cz); body.castShadow=true; body.receiveShadow=true;
  onScene.add(body); onWalls.push(body); onObs.push({x:cx,z:cz,hw:3.0,hd:2.7});
  // Techo plano con reborde
  const roof=new THREE.Mesh(new THREE.BoxGeometry(5.4,.2,4.9),roofmat);
  roof.position.set(cx,2.9,cz); onScene.add(roof);
  // Escalones de entrada
  const stepMat=new THREE.MeshLambertMaterial({color:0x999999});
  [0,1,2].forEach(i=>{
    const fz=team==='red'?cz+2.25+i*.3:cz-2.25-i*.3;
    const step=new THREE.Mesh(new THREE.BoxGeometry(1.8,.15+i*.1,0.35),stepMat);
    step.position.set(cx,.075+i*.1,fz); onScene.add(step);
  });
  // Ventanas
  const fz=team==='red'?cz+2.26:cz-2.26;
  [-1.5,1.5].forEach(ox=>{
    const win=new THREE.Mesh(new THREE.BoxGeometry(.75,.65,.08),dmat);
    win.position.set(cx+ox,1.8,fz); onScene.add(win);
    // Marco ventana
    const frame=new THREE.Mesh(new THREE.BoxGeometry(.85,.75,.06),new THREE.MeshLambertMaterial({color:0xdddddd}));
    frame.position.set(cx+ox,1.8,fz); onScene.add(frame);
  });
  // Puerta
  const door=new THREE.Mesh(new THREE.BoxGeometry(1.1,1.6,.08),dmat);
  door.position.set(cx,.8,fz); onScene.add(door);
  // Sacos de arena alrededor de la base
  const sandMat2=new THREE.MeshLambertMaterial({color:0xc8a86a});
  [[-2.2,0,3.5],[2.2,0,3.5],[0,-2,3.5],[0,2,3.5]].forEach(([ox,oz,len])=>{
    const ry=Math.abs(oz)>.5?Math.PI/2:0;
    const sb=new THREE.Mesh(new THREE.BoxGeometry(ry?0.5:len,0.6,ry?len:0.5),sandMat2);
    sb.position.set(cx+ox,0.3,cz+oz*(team==='red'?-1:1)); onScene.add(sb);
  });
}

function onBuildLights(){
  onScene.add(new THREE.AmbientLight(0xffffff,.78));
  const sun=new THREE.DirectionalLight(0xfff4cc,1.3); sun.position.set(12,22,8); sun.castShadow=true; sun.shadow.mapSize.width=sun.shadow.mapSize.height=2048; onScene.add(sun);
  const fill=new THREE.DirectionalLight(0x88aaff,.35); fill.position.set(-10,10,-15); onScene.add(fill);
}

function onCreateRobloxChar(teamColor){
  const g=new THREE.Group(), col=new THREE.Color(teamColor);
  const mat=new THREE.MeshPhongMaterial({color:teamColor,shininess:25}),dark=new THREE.MeshPhongMaterial({color:col.clone().multiplyScalar(.5),shininess:15}),skin=new THREE.MeshPhongMaterial({color:0xffcc99}),shoe=new THREE.MeshPhongMaterial({color:0x111111});
  const head=new THREE.Mesh(new THREE.BoxGeometry(.46,.46,.46),skin); head.position.y=1.62; head.castShadow=true; g.add(head);
  const eyeM=new THREE.MeshBasicMaterial({color:0x111122});
  [-1,1].forEach(sx=>{ const e=new THREE.Mesh(new THREE.BoxGeometry(.09,.09,.02),eyeM); e.position.set(sx*.12,1.65,.24); g.add(e); });
  const hat=new THREE.Mesh(new THREE.BoxGeometry(.5,.1,.5),mat); hat.position.y=1.88; g.add(hat);
  const hatTop=new THREE.Mesh(new THREE.BoxGeometry(.38,.14,.38),mat); hatTop.position.y=1.98; g.add(hatTop);
  const torso=new THREE.Mesh(new THREE.BoxGeometry(.5,.56,.26),mat); torso.position.y=1.09; torso.castShadow=true; g.add(torso);
  const aLPivot=new THREE.Object3D(); aLPivot.position.set(-.35,1.37,0); g.add(aLPivot);
  const aLMesh=new THREE.Mesh(new THREE.BoxGeometry(.19,.5,.19),mat); aLMesh.position.y=-.25; aLPivot.add(aLMesh);
  const aRPivot=new THREE.Object3D(); aRPivot.position.set(.35,1.37,0); g.add(aRPivot);
  const aRMesh=new THREE.Mesh(new THREE.BoxGeometry(.19,.5,.19),dark); aRMesh.position.y=-.25; aRPivot.add(aRMesh);
  const lLPivot=new THREE.Object3D(); lLPivot.position.set(-.13,.72,0); g.add(lLPivot);
  const lLMesh=new THREE.Mesh(new THREE.BoxGeometry(.21,.5,.21),dark); lLMesh.position.y=-.25; lLPivot.add(lLMesh);
  const lRPivot=new THREE.Object3D(); lRPivot.position.set(.13,.72,0); g.add(lRPivot);
  const lRMesh=new THREE.Mesh(new THREE.BoxGeometry(.21,.5,.21),dark); lRMesh.position.y=-.25; lRPivot.add(lRMesh);
  const sg=new THREE.BoxGeometry(.23,.1,.26);
  const sh1=new THREE.Mesh(sg,shoe); sh1.position.set(-.13,.12,.03); g.add(sh1);
  const sh2=new THREE.Mesh(sg,shoe); sh2.position.set(.13,.12,.03); g.add(sh2);
  const hb=new THREE.Mesh(new THREE.BoxGeometry(.52,.95,.52),new THREE.MeshBasicMaterial({visible:false})); hb.position.y=1.1; g.add(hb); g.userData.hitbox=hb;
  // Hitbox de cabeza
  const headHB=new THREE.Mesh(new THREE.BoxGeometry(.5,.5,.5),new THREE.MeshBasicMaterial({visible:false})); headHB.position.y=1.72; g.add(headHB); g.userData.headHitbox=headHB;
  // Hitbox de piernas (zona baja)
  const legHB=new THREE.Mesh(new THREE.BoxGeometry(.52,.85,.52),new THREE.MeshBasicMaterial({visible:false})); legHB.position.y=.42; g.add(legHB); g.userData.legHitbox=legHB;
  const gm1=new THREE.MeshLambertMaterial({color:0x1a1a2a}),gm2=new THREE.MeshLambertMaterial({color:0x0a0a0f}),gm3=new THREE.MeshLambertMaterial({color:teamColor,emissive:teamColor,emissiveIntensity:.5});
  const gunGrp=new THREE.Group();
  const gb=new THREE.Mesh(new THREE.BoxGeometry(.05,.065,.32),gm1); gunGrp.add(gb);
  const gsl=new THREE.Mesh(new THREE.BoxGeometry(.04,.032,.28),new THREE.MeshLambertMaterial({color:0x333348})); gsl.position.set(0,.05,-.01); gunGrp.add(gsl);
  const gbar=new THREE.Mesh(new THREE.BoxGeometry(.024,.024,.14),gm2); gbar.position.set(0,.024,-.23); gunGrp.add(gbar);
  const gstr=new THREE.Mesh(new THREE.BoxGeometry(.052,.006,.14),gm3); gstr.position.set(0,.038,.0); gunGrp.add(gstr);
  const ghand=new THREE.Mesh(new THREE.BoxGeometry(.044,.095,.052),gm1); ghand.position.set(0,-.08,.05); ghand.rotation.x=.2; gunGrp.add(ghand);
  gunGrp.position.set(.12,-.18,-.16); gunGrp.rotation.y=-.05; aRPivot.add(gunGrp);
  g.userData.limbs={head,torso,aL:aLPivot,aR:aRPivot,lL:lLPivot,lR:lRPivot};
  g.userData.anim={walkPhase:0,shootT:0,deathT:0,dead:false,prevX:null,prevZ:null,idleT:Math.random()*100,jumping:false};
  return g;
}

function onAnimateChar(g,dt){
  const L=g.userData.limbs,A=g.userData.anim;
  if(!L||!A) return;
  A.idleT+=dt;
  const px=g.position.x,pz=g.position.z;
  const moved=A.prevX!==null&&(Math.abs(px-A.prevX)>.004||Math.abs(pz-A.prevZ)>.004);
  A.prevX=px; A.prevZ=pz;
  if(A.dead){ A.deathT=Math.min(1,A.deathT+dt*3.5); g.rotation.z=A.deathT*Math.PI*.48; g.position.y=-A.deathT*.55; return; }
  const idleY=Math.sin(A.idleT*1.1)*.018; if(!A.jumping) g.position.y=idleY;
  if(moved) A.walkPhase+=dt*9;
  const sw=Math.sin(A.walkPhase),blend=moved?1:0,walkAmt=sw*.52*blend;
  L.lL.rotation.x=walkAmt; L.lR.rotation.x=-walkAmt; L.aL.rotation.x=-walkAmt*.7; L.aR.rotation.x=walkAmt*.7;
  if(!moved){ L.lL.rotation.x*=.85; L.lR.rotation.x*=.85; L.aL.rotation.x*=.85; L.aR.rotation.x*=.85; }
  L.head.position.y=1.62+Math.abs(sw)*.025*blend;
  if(A.shootT>0){ A.shootT=Math.max(0,A.shootT-dt*7); L.aR.rotation.x=-Math.PI*.35*A.shootT; L.torso.rotation.x=A.shootT*.12; } else { L.torso.rotation.x*=.88; }
}

function onAddOppMesh(slot,team){
  if(onOpps.has(slot)) return;
  const group=onCreateRobloxChar(TEAM_COLORS[team]||0x4488ff);
  group.visible=false; onScene.add(group);
  onOpps.set(slot,{group,hitbox:group.userData.hitbox,headHitbox:group.userData.headHitbox,legHitbox:group.userData.legHitbox});
}

function onSpawnPlayer(spawn){
  if(!spawn) spawn=onMySpawn;
  onPos={x:spawn.x,z:spawn.z}; onYaw=spawn.yaw; onPitch=0; onAlive=true;
  onVelY=0; onPosY=0; onIsGrounded=true;
  onYawObj.position.set(spawn.x,ON_H,spawn.z); onYawObj.rotation.y=onYaw; onPitchObj.rotation.x=0;
  // Resetear HP + munici√≥n
  onUpdateHP(100);
  onAmmo={pistol:WEAPONS.pistol.ammoMax, rifle:WEAPONS.rifle.ammoMax, shotgun:WEAPONS.shotgun.ammoMax};
  onGrenades=2; onGrenCooldown=false;
  onReloading=false; onCanShoot=true; clearTimeout(onReloadT);
  onCurWeapon='pistol';
  onUpdateWeaponHUD();
  if(onGun&&onCamera){ onRebuildGunMesh(); }
  const grenEl=document.getElementById('duel-gren-hud');
  if(grenEl) grenEl.textContent='üí£'.repeat(onGrenades)||'‚Äî';
}
function onCollides(nx,nz){ for(const o of onObs) if(nx>o.x-o.hw&&nx<o.x+o.hw&&nz>o.z-o.hd&&nz<o.z+o.hd) return true; return false; }
function onMove(dt){
  if(!onAlive||!onActive) return;
  const fw=(onKeys['w']||onKeys['W']?1:0)-(onKeys['s']||onKeys['S']?1:0);
  const ri=(onKeys['d']||onKeys['D']?1:0)-(onKeys['a']||onKeys['A']?1:0);
  if((onKeys[' ']||onKeys['Spacebar'])&&onIsGrounded){ onVelY=ON_JUMP_FORCE; onIsGrounded=false; }
  onVelY-=ON_GRAVITY*dt; onPosY+=onVelY*dt;
  if(onPosY<=0){ onPosY=0; onVelY=0; onIsGrounded=true; }
  onYawObj.position.y=ON_H+onPosY;
  if(!fw&&!ri) return;
  const len=Math.sqrt(fw*fw+ri*ri),sp=ON_SPD*dt;
  const nx=onPos.x+((fw/len)*(-Math.sin(onYaw))+(ri/len)*Math.cos(onYaw))*sp;
  const nz=onPos.z+((fw/len)*(-Math.cos(onYaw))+(ri/len)*(-Math.sin(onYaw)))*sp;
  if(!onCollides(nx,onPos.z)) onPos.x=nx;
  if(!onCollides(onPos.x,nz)) onPos.z=nz;
  onYawObj.position.set(onPos.x,ON_H+onPosY,onPos.z);
}

// ‚úÖ CAMBIO: PVP usa CFG.sens din√°micamente (igual que el modo pr√°ctica)
function onApplyCam(){
  if(!onMX&&!onMY) return;
  const dynSens = CFG.sens * 0.00065;
  onYaw-=onMX*dynSens; onPitch-=onMY*dynSens;
  onPitch=Math.max(-Math.PI/2+.04,Math.min(Math.PI/2-.04,onPitch));
  onYawObj.rotation.y=onYaw; onPitchObj.rotation.x=onPitch; onMX=onMY=0;
}

function onUpdateOpp(slot,pos,yaw,pitch,posY){
  const o=onOpps.get(slot); if(!o) return;
  const oy=posY||0; o.group.visible=true; o.group.position.set(pos.x,oy,pos.z); o.group.rotation.y=yaw;
  if(o.group.userData.anim) o.group.userData.anim.jumping=(oy>0.05);
  if(pitch!==undefined&&o.group.userData.limbs){ const L=o.group.userData.limbs,cp=Math.max(-.7,Math.min(.7,pitch)); L.head.rotation.x=cp; L.aR.rotation.x=-cp*.6; L.torso.rotation.x=cp*.25; }
}
function onHandlePlayerRespawn(slot,spawn){
  const o=onOpps.get(slot);
  if(o&&spawn) o.group.position.set(spawn.x,0,spawn.z);
  if(o&&o.group.userData.anim){ const a=o.group.userData.anim; a.dead=false; a.deathT=0; o.group.rotation.z=0; o.group.position.y=0; }
}

function onTryShoot(){
  if(!onAlive||!onActive||!onCanShoot||onReloading) return;
  const wp=WEAPONS[onCurWeapon];
  if(onAmmo[onCurWeapon]<=0){ onStartReload(); return; }
  onCanShoot=false; setTimeout(()=>onCanShoot=true, wp.cd);
  onAmmo[onCurWeapon]--;
  onUpdateWeaponHUD();
  if(onAmmo[onCurWeapon]===0) setTimeout(onStartReload, 300);
  playGunshot(); onGunAnim=1;
  const fl=new THREE.PointLight(0xff3d71,7,2); fl.position.set(0,.03,-.42); onCamera.add(fl); setTimeout(()=>onCamera.remove(fl),55);
  onSend({type:'shoot'});
  // Disparar pellets (1 para pistola/rifle, 7 para escopeta)
  for(let p=0;p<wp.pellets;p++){
    const spread=wp.spread;
    const dx=(Math.random()-.5)*spread*2, dy=(Math.random()-.5)*spread*2;
    const dir=new THREE.Vector2(dx,dy);
    onRaycaster.setFromCamera(dir,onCamera);
    const wallHits=onRaycaster.intersectObjects(onWalls,false);
    const wallDist=wallHits.length>0?wallHits[0].distance:Infinity;
    let hit=false;

    // ‚îÄ‚îÄ 1. CABEZA (headshot) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const headBoxes=[...onOpps.values()].map(o=>o.headHitbox).filter(Boolean);
    const headHits=onRaycaster.intersectObjects(headBoxes,false);
    if(headHits.length>0&&headHits[0].distance<wallDist){
      for(const [slot,opp] of onOpps){
        if(opp.headHitbox===headHits[0].object){
          onSend({type:'hit',victimSlot:slot,dmg:wp.dmgHead,zone:'head'});
          onShowHitMarker('head');
          onFlashOppHit(opp);
          hit=true; break;
        }
      }
      if(hit) continue;
    }

    // ‚îÄ‚îÄ 2. CUERPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const bodyBoxes=[...onOpps.values()].map(o=>o.hitbox).filter(Boolean);
    const bodyHits=onRaycaster.intersectObjects(bodyBoxes,false);
    if(bodyHits.length>0&&bodyHits[0].distance<wallDist){
      for(const [slot,opp] of onOpps){
        if(opp.hitbox===bodyHits[0].object){
          onSend({type:'hit',victimSlot:slot,dmg:wp.dmgBody,zone:'body'});
          onShowHitMarker('body');
          onFlashOppHit(opp);
          hit=true; break;
        }
      }
      if(hit) continue;
    }

    // ‚îÄ‚îÄ 3. PIERNAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const legBoxes=[...onOpps.values()].map(o=>o.legHitbox).filter(Boolean);
    const legHits=onRaycaster.intersectObjects(legBoxes,false);
    if(legHits.length>0&&legHits[0].distance<wallDist){
      for(const [slot,opp] of onOpps){
        if(opp.legHitbox===legHits[0].object){
          onSend({type:'hit',victimSlot:slot,dmg:wp.dmgLegs,zone:'legs'});
          onShowHitMarker('legs');
          onFlashOppHit(opp);
          break;
        }
      }
    }
  }
}

// zone: 'head' | 'body' | 'legs'
function onShowHitMarker(zone){
  const f=document.getElementById('duel-hit-flash');
  const isHead = zone==='head';
  const isLegs = zone==='legs';
  f.style.opacity= isHead ? '0.55' : isLegs ? '0.18' : '0.28';
  f.style.background = isHead
    ? 'radial-gradient(ellipse at center,rgba(255,215,0,.65) 0%,transparent 65%)'
    : 'radial-gradient(ellipse at center,rgba(255,61,113,.35) 0%,transparent 70%)';
  setTimeout(()=>{ f.style.opacity='0'; }, isHead?140:90);
  // Marcador flotante
  if(isHead){
    const el=document.createElement('div');
    el.innerHTML='üí• HEADSHOT! <span style="font-size:.75em;color:#ffaa00">+50</span>';
    el.style.cssText='position:fixed;top:37%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:1.15rem;font-weight:900;color:#ffd700;text-shadow:0 0 22px #ffd700,0 0 8px #ff8800;pointer-events:none;z-index:65;animation:float-up 1s ease-out forwards;';
    document.body.appendChild(el); setTimeout(()=>el.remove(),1000);
  } else if(isLegs){
    const el=document.createElement('div');
    el.textContent='ü¶µ PIERNA';
    el.style.cssText='position:fixed;top:42%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:.7rem;font-weight:700;color:#aaaaff;text-shadow:0 0 10px #8888ff;pointer-events:none;z-index:65;animation:float-up .7s ease-out forwards;';
    document.body.appendChild(el); setTimeout(()=>el.remove(),700);
  }
}

// Flash rojo breve en el personaje del oponente al recibir bala
function onFlashOppHit(opp){
  if(!opp||!opp.group) return;
  const mats=[];
  opp.group.traverse(c=>{ if(c.isMesh&&c.material&&c.material.visible!==false){ mats.push({m:c.material,orig:c.material.emissive.clone(),oi:c.material.emissiveIntensity}); c.material.emissive.setHex(0xff0000); c.material.emissiveIntensity=1.2; } });
  setTimeout(()=>mats.forEach(({m,orig,oi})=>{ m.emissive.copy(orig); m.emissiveIntensity=oi; }),90);
}

function onStartReload(){
  if(onReloading||!onAlive) return;
  const wp=WEAPONS[onCurWeapon];
  if(onAmmo[onCurWeapon]>=wp.ammoMax) return;
  onReloading=true; onCanShoot=false;
  const nameEl=document.getElementById('duel-weapon-name');
  const origName=wp.name;
  nameEl.textContent='‚ü≥ RECARGANDO...'; nameEl.style.color='#ffd700';
  clearTimeout(onReloadT);
  onReloadT=setTimeout(()=>{
    onAmmo[onCurWeapon]=wp.ammoMax;
    onReloading=false; onCanShoot=true;
    nameEl.textContent=origName; nameEl.style.color='#fff';
    onUpdateWeaponHUD();
  }, wp.reload);
}

function onSwitchWeapon(id){
  if(onCurWeapon===id||onReloading) return;
  clearTimeout(onReloadT); onReloading=false; onCanShoot=true;
  onCurWeapon=id;
  onUpdateWeaponHUD();
  onRebuildGunMesh();
}

function onUpdateWeaponHUD(){
  const wp=WEAPONS[onCurWeapon];
  const nameEl=document.getElementById('duel-weapon-name');
  const ammoEl=document.getElementById('duel-ammo-hud');
  if(nameEl&&!onReloading) nameEl.textContent=wp.name;
  if(ammoEl) ammoEl.textContent=onAmmo[onCurWeapon]+' / '+wp.ammoMax;
  // Resaltar slot activo
  document.querySelectorAll('.duel-wp-slot').forEach(s=>{
    s.style.borderColor = s.dataset.wp===onCurWeapon ? '#fff' : 'rgba(255,255,255,.2)';
    s.style.background  = s.dataset.wp===onCurWeapon ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.05)';
  });
}

function onUpdateHP(hp){
  onMyHP=Math.max(0,Math.min(100,hp));
  const bar=document.getElementById('duel-hp-bar');
  const num=document.getElementById('duel-hp-num');
  if(bar){ bar.style.width=onMyHP+'%'; bar.style.background=onMyHP>60?'linear-gradient(90deg,#44cc66,#66ff88)':onMyHP>30?'linear-gradient(90deg,#ffaa00,#ffd700)':'linear-gradient(90deg,#ff2200,#ff5533)'; }
  if(num){ num.textContent=onMyHP; num.style.color=onMyHP>60?'#66ff88':onMyHP>30?'#ffd700':'#ff4444'; }
}

// HP estimado del rival (solo 1v1, calculado client-side)
let onOppHP = 100;
function onUpdateOppHP(slot, hp){
  if(onRoomMode!=='1v1') return;
  if(hp!==null&&hp!==undefined) onOppHP=Math.max(0,Math.min(100,hp));
  const hud=document.getElementById('duel-opp-hp-hud');
  const bar=document.getElementById('duel-opp-hp-bar');
  const num=document.getElementById('duel-opp-hp-num');
  const lbl=document.getElementById('duel-opp-hp-label');
  if(!hud) return;
  hud.style.display='flex';
  const oppName=slot!=null?onPlayerNames.get(slot):null;
  if(lbl&&oppName) lbl.textContent=oppName.toUpperCase();
  if(bar){ bar.style.width=onOppHP+'%'; bar.style.background=onOppHP>60?'linear-gradient(90deg,#4488ff,#88ccff)':onOppHP>30?'linear-gradient(90deg,#ffaa00,#ffd700)':'linear-gradient(90deg,#ff3300,#ff6600)'; }
  if(num){ num.textContent=onOppHP; num.style.color=onOppHP>60?'#88ccff':onOppHP>30?'#ffd700':'#ff4444'; }
}

function onRebuildGunMesh(){
  if(!onGun||!onCamera) return;
  onCamera.remove(onGun); onGun=null; onBuildGun();
}

function onStartGame(msg){
  if(!onThreeReady) onInitThree();
  onRoomMode=msg.mode; onFirstTo=msg.firstTo; onTeamScores=[0,0]; onPScores={}; onActive=true; onWaitPlayers=[];
  msg.players.forEach(p=>{ onPlayerNames.set(p.slot,p.name); if(p.slot===onMySlot){onMySpawn=p.spawn;onMyTeam=p.team;} else onAddOppMesh(p.slot,p.team); });
  onSpawnPlayer(onMySpawn);
  // Mostrar barra rival en 1v1
  if(msg.mode==='1v1'){ const w=document.getElementById('duel-opp-hp-wrap'); if(w) w.style.display='flex'; }
  const myCol=TEAM_HEX[onMyTeam]||'#ff4444';
  document.getElementById('duel-my-name-hud').textContent=onMyName.toUpperCase();
  document.getElementById('duel-opp-name-hud').textContent=msg.mode==='ffa'?'FFA':'RIVAL';
  // Mostrar barra HP rival solo en 1v1
  const oppHpHud=document.getElementById('duel-opp-hp-hud');
  if(oppHpHud) oppHpHud.style.display=msg.mode==='1v1'?'flex':'none';
  onOppHP=100;
  document.getElementById('duel-team-label').textContent=TEAM_LBL[onMyTeam]||'?';
  document.getElementById('duel-team-label').style.color=myCol;
  document.getElementById('duel-my-kills').style.color=myCol;
  document.getElementById('duel-my-kills').style.textShadow='0 0 12px '+myCol;
  const ft=document.getElementById('duel-firstto'); if(ft) ft.textContent=msg.firstTo;
  onPing=0; onUpdatePingDisplay(); onRefreshHUD(); onInitWeaponSlots();
  const oppNames=msg.players.filter(p=>p.slot!==onMySlot).map(p=>p.name).join(', ');
  document.getElementById('duel-opp-name-lock').textContent=oppNames||'Rival';
  document.getElementById('duel-lock-team').textContent='Equipo: '+TEAM_LBL[onMyTeam];
  onShowScreen(null);
  document.getElementById('duel-canvas').style.display='block';
  document.getElementById('duel-hud').style.display='block';

  if(mobileMode){
    document.getElementById('duel-lock-screen').style.display='none';
    document.getElementById('duel-crosshair').style.display='block';
    document.getElementById('duel-mobile-controls').classList.add('active');
    onLocked=true;
    onKeys['w']=onKeys['s']=onKeys['a']=onKeys['d']=false;
  } else {
    document.getElementById('duel-lock-screen').style.display='flex';
    document.getElementById('duel-mobile-controls').classList.remove('active');
  }

  clearInterval(onStateIv);
  onStateIv=setInterval(()=>{ if(onAlive&&onActive) onSend({type:'state',pos:{...onPos},yaw:onYaw,pitch:onPitch,posY:onPosY}); },50);
  if(onAnimId) cancelAnimationFrame(onAnimId);
  let last=performance.now(),fF=0,fA=0;
  function onLoop(now){
    onAnimId=requestAnimationFrame(onLoop);
    const dt=Math.min((now-last)/1000,.05); last=now;
    fF++; fA+=dt;
    if(fA>=.5){ document.getElementById('duel-fps-hud').textContent=Math.round(fF/fA)+' FPS'; fF=0; fA=0; }
    if(onActive){ onMove(dt); onApplyCam(); onAnimGun(dt); onAnimateAllChars(dt); onUpdateGrenades(dt); onApplyCamShake(dt); }
    onRenderer.render(onScene,onCamera);
  }
  onLoop(performance.now());
}

// ‚îÄ‚îÄ MANEJO DE DA√ëO RECIBIDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onHandleDamage(msg){
  onUpdateHP(msg.hp);
  const dmg=msg.dmg||25, zone=msg.zone||'body';
  const isHead=(zone==='head'), isLegs=(zone==='legs');

  // ‚îÄ‚îÄ Efecto pantalla: intensidad proporcional al da√±o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const v=document.getElementById('duel-death-vignette');
  const intensity=Math.min(1, 0.2 + (dmg/100)*1.2); // 15‚Üí38%  25‚Üí50%  50‚Üí80%
  v.style.display='block'; v.style.opacity=intensity.toFixed(2);
  v.style.background=isHead
    ? 'radial-gradient(ellipse at center,rgba(255,0,0,.0) 25%,rgba(255,0,0,.98) 100%)'
    : 'radial-gradient(ellipse at center,rgba(160,0,0,.0) 35%,rgba(200,0,0,.88) 100%)';
  const dur=isHead?420:230;
  setTimeout(()=>{ if(!onAlive) return; v.style.opacity='0'; setTimeout(()=>{ if(!onAlive) return; v.style.display='none'; v.style.background=''; },320); }, dur);

  // ‚îÄ‚îÄ Shake de c√°mara proporcional al da√±o ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onCamShake = 0.05 + (dmg/100)*0.32;

  // ‚îÄ‚îÄ Sonido de impacto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  try{
    const ac=new AudioContext();
    const osc=ac.createOscillator(), g=ac.createGain();
    osc.connect(g); g.connect(ac.destination);
    osc.frequency.setValueAtTime(isHead?70:130, ac.currentTime);
    g.gain.setValueAtTime(isHead?.4:.25, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, ac.currentTime+.18);
    osc.start(); osc.stop(ac.currentTime+.18);
  }catch(e){}

  // ‚îÄ‚îÄ Mensaje flotante de zona recibida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const zoneLabel = isHead ? 'üíÄ HEADSHOT  -'+dmg : isLegs ? 'ü¶µ PIERNAS  -'+dmg : 'üéØ CUERPO  -'+dmg;
  const zoneCol   = isHead ? '#ff1111' : isLegs ? '#ff9900' : '#ff5533';
  const fSize     = isHead ? '1.15rem' : '.82rem';
  const el=document.createElement('div');
  el.textContent=zoneLabel;
  el.style.cssText='position:fixed;top:36%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:'+fSize+';font-weight:900;color:'+zoneCol+';text-shadow:0 0 20px '+zoneCol+';pointer-events:none;z-index:65;animation:float-up .9s ease-out forwards;';
  document.body.appendChild(el); setTimeout(()=>el.remove(),900);
}

// ‚îÄ‚îÄ HP del rival cuando le acertamos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onHandleOppHP(msg){
  const hp=Math.max(0,Math.min(100,msg.hp||0));
  const zone=msg.zone||'body', dmg=msg.dmg||0;
  const wrap=document.getElementById('duel-opp-hp-wrap');
  const bar =document.getElementById('duel-opp-hp-bar');
  const num =document.getElementById('duel-opp-hp-num');
  // Mostrar barra solo si hay exactamente 1 rival
  if(wrap&&(onRoomMode==='1v1'||onOpps.size<=1)) wrap.style.display='flex';
  if(bar){
    bar.style.width=hp+'%';
    bar.style.background=hp>60?'linear-gradient(90deg,#44cc66,#66ff88)':hp>30?'linear-gradient(90deg,#ffaa00,#ffd700)':'linear-gradient(90deg,#ff2200,#ff5533)';
    bar.style.filter='brightness(2.2)'; setTimeout(()=>{ bar.style.filter=''; },140);
  }
  if(num){ num.textContent=hp; num.style.color=hp>60?'#66ff88':hp>30?'#ffd700':'#ff4444'; }

  // ‚îÄ‚îÄ Flash rojo en el modelo 3D del rival ‚îÄ‚îÄ
  const opp=onOpps.get(msg.slot);
  if(opp&&opp.group){
    opp.group.traverse(c=>{
      if(c.isMesh&&c.material&&c.material.color){
        if(c.userData._oc===undefined) c.userData._oc=c.material.color.getHex();
        c.material.color.setHex(0xff1100);
        c.material.emissive&&c.material.emissive.setHex(0xff1100);
      }
    });
    setTimeout(()=>{
      if(!opp||!opp.group) return;
      opp.group.traverse(c=>{
        if(c.isMesh&&c.material&&c.userData._oc!==undefined){
          c.material.color.setHex(c.userData._oc);
          c.material.emissive&&c.material.emissive.setHex(0x000000);
        }
      });
    },90);
  }

  // ‚îÄ‚îÄ Notificaci√≥n de headshot dado ‚îÄ‚îÄ
  if(zone==='head'){
    const he=document.createElement('div');
    he.textContent='üí• HEADSHOT!';
    he.style.cssText='position:fixed;top:28%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:1.25rem;font-weight:900;color:#ffd700;text-shadow:0 0 25px #ffd700,0 0 50px #ff8800;pointer-events:none;z-index:66;animation:float-up 1s ease-out forwards;';
    document.body.appendChild(he); setTimeout(()=>he.remove(),1000);
  }

  // ‚îÄ‚îÄ Da√±o flotante en posici√≥n rival ‚îÄ‚îÄ
  const zLabel = zone==='head'?'+'+dmg+' üéØ':zone==='legs'?'+'+dmg+' ü¶µ':'+'+dmg;
  const zCol   = zone==='head'?'#ffd700':zone==='legs'?'#ff9900':'#ff4444';
  const de=document.createElement('div');
  de.textContent=zLabel;
  de.style.cssText='position:fixed;top:44%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:.9rem;font-weight:900;color:'+zCol+';text-shadow:0 0 14px '+zCol+';pointer-events:none;z-index:65;animation:float-up .75s ease-out forwards;';
  document.body.appendChild(de); setTimeout(()=>de.remove(),750);
}

function onHandleOppGrenade(msg){
  if(!onScene) return;
  // Crear grenade visual del oponente
  const geo=new THREE.SphereGeometry(.12,8,8);
  const mat=new THREE.MeshLambertMaterial({color:0x4a2a0a});
  const mesh=new THREE.Mesh(geo,mat); mesh.castShadow=true;
  // Lanzar desde la posici√≥n del oponente
  const opp=onOpps.get(msg.slot);
  const startX=msg.pos?msg.pos.x:0, startZ=msg.pos?msg.pos.z:0;
  mesh.position.set(startX, ON_H-.1, startZ);
  onScene.add(mesh);
  const yaw=msg.yaw||0, pitch=msg.pitch||0;
  const vel=new THREE.Vector3(-Math.sin(yaw)*Math.cos(pitch), Math.sin(pitch)+0.4, -Math.cos(yaw)*Math.cos(pitch)).multiplyScalar(18).add(new THREE.Vector3(0,8,0));
  onGrenList.push({mesh,vel,life:0,exploded:false});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ü§ñ MODO BOTS OFFLINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let btActive=false, btBots=[], btScore={player:0}, btAnimId=null, btDiff='easy', btFirstTo=10;
const BT_DIFF={
  easy:   {spd:2.5,  aimErr:0.18, reactionT:1.8, shootCd:1400, dmg:15, vision:12},
  medium: {spd:4.0,  aimErr:0.08, reactionT:0.9, shootCd:900,  dmg:20, vision:18},
  hard:   {spd:5.5,  aimErr:0.02, reactionT:0.3, shootCd:500,  dmg:25, vision:24}
};
const BT_SPAWNS_RED=[ {x:-14,z:-12,yaw:0.75},{x:-12,z:-5,yaw:0.6},{x:-15,z:1,yaw:0.35} ];
const BT_SPAWNS_BLUE=[ {x:14,z:12,yaw:-Math.PI+0.75},{x:12,z:5,yaw:-Math.PI+0.6},{x:15,z:-1,yaw:-Math.PI+0.35} ];

function botsStartMatch(count, diff){
  if(btActive) botsCleanup();
  btActive=true; btBots=[]; btDiff=diff; btFirstTo=10;
  btScore={player:0};
  Object.keys(btScore); // init
  if(!onThreeReady) onInitThree();
  onBuildMap(); onBuildLights();

  // Set up scene as PVP
  onMyTeam=0; onMySlot=0; onRoomMode='1v1'; onFirstTo=btFirstTo; onActive=true;
  onPlayerNames=new Map([[0,currentUser?.name||'T√ö']]);
  onTeamScores=[0,0]; onPScores={};

  // Spawn player
  const pSpawn=BT_SPAWNS_RED[0];
  onMySpawn=pSpawn;
  onSpawnPlayer(pSpawn);

  // Show HUD
  document.getElementById('duel-canvas').style.display='block';
  document.getElementById('duel-hud').style.display='block';
  document.getElementById('duel-crosshair').style.display='block';
  document.getElementById('duel-my-name-hud').textContent=(currentUser?.name||'T√ö').toUpperCase();
  document.getElementById('duel-opp-name-hud').textContent=count===1?'ü§ñ BOT':'ü§ñ BOTS';
  document.getElementById('duel-my-kills').textContent='0';
  document.getElementById('duel-opp-kills').textContent='0';
  document.getElementById('duel-score-label').textContent='FIRST TO '+btFirstTo;
  onInitWeaponSlots();

  // Lock pointer
  if(!mobileMode){
    document.getElementById('duel-lock-screen').style.display='flex';
  } else {
    onLocked=true;
    document.getElementById('duel-mobile-controls').classList.add('active');
  }

  // Create bots
  for(let i=0;i<count;i++){
    const sp=BT_SPAWNS_BLUE[i%BT_SPAWNS_BLUE.length];
    btSpawnBot(i+1, sp, diff);
  }

  // Update HUD back button to return to menu
  document.getElementById('duel-menu-btn').onclick=()=>{
    botsCleanup();
    document.getElementById('duel-canvas').style.display='none';
    document.getElementById('duel-hud').style.display='none';
    document.getElementById('duel-crosshair').style.display='none';
    document.getElementById('menu-screen').classList.remove('hidden');
  };

  // Start loop
  if(btAnimId) cancelAnimationFrame(btAnimId);
  let last=performance.now();
  function btLoop(now){
    btAnimId=requestAnimationFrame(btLoop);
    const dt=Math.min((now-last)/1000,.05); last=now;
    if(btActive){ onMove(dt); onApplyCam(); onAnimGun(dt); btUpdateBots(dt); onUpdateGrenades(dt); onApplyCamShake(dt); onAnimateAllChars(dt); }
    onRenderer.render(onScene,onCamera);
  }
  btLoop(performance.now());
}

function btSpawnBot(slot, spawn, diff){
  const col=TEAM_COLORS[1]||0x2277ff;
  const g=onCreateRobloxChar(col);
  g.position.set(spawn.x,0,spawn.z);
  onScene.add(g);
  const cfg=BT_DIFF[diff];
  const bot={
    slot, group:g,
    hitbox:g.userData.hitbox,
    headHitbox:g.userData.headHitbox,
    legHitbox:g.userData.legHitbox,
    hp:100, alive:true,
    spawn, diff, cfg,
    state:'patrol',      // patrol | chase | shoot | dead
    patrolTarget:null,
    shootCd:0,
    reactionT:0,
    stuckT:0,
    prevX:null, prevZ:null,
    name:'BOT '+(slot)
  };
  onOpps.set(slot,{group:g,hitbox:g.userData.hitbox,headHitbox:g.userData.headHitbox,legHitbox:g.userData.legHitbox});
  onPlayerNames.set(slot, bot.name);
  btBots.push(bot);
}

function btUpdateBots(dt){
  if(!btActive) return;
  btBots.forEach(bot=>{
    if(!bot.alive) return;
    const cfg=bot.cfg;
    const px=onPos.x, pz=onPos.z;
    const bx=bot.group.position.x, bz=bot.group.position.z;
    const dx=px-bx, dz=pz-bz;
    const dist=Math.sqrt(dx*dx+dz*dz);

    // ‚îÄ‚îÄ Visi√≥n de l√≠nea recta (sin obst√°culos por simplicidad) ‚îÄ‚îÄ
    const canSee = dist < cfg.vision;

    // ‚îÄ‚îÄ M√°quina de estados ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!canSee){
      bot.state='patrol';
      bot.reactionT=cfg.reactionT;
    } else if(canSee && bot.reactionT>0){
      bot.reactionT-=dt;
      bot.state='chase';
    } else {
      bot.state= dist>5 ? 'chase' : 'shoot';
    }

    // ‚îÄ‚îÄ Patrulla: ir a punto aleatorio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(bot.state==='patrol'){
      if(!bot.patrolTarget || btDist(bot.group.position,bot.patrolTarget)<1.2){
        bot.patrolTarget={x:(Math.random()-.5)*24, z:(Math.random()-.5)*24};
      }
      const tx=bot.patrolTarget.x-bx, tz=bot.patrolTarget.z-bz;
      const td=Math.sqrt(tx*tx+tz*tz)||1;
      const spd=cfg.spd*.5*dt;
      const nx=bx+tx/td*spd, nz=bz+tz/td*spd;
      if(!onCollides(nx,nz)){ bot.group.position.x=nx; bot.group.position.z=nz; }
      bot.group.rotation.y=Math.atan2(tx,tz);
    }

    // ‚îÄ‚îÄ Perseguir jugador ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(bot.state==='chase'||bot.state==='shoot'){
      bot.group.rotation.y=Math.atan2(dx,dz);
      if(bot.state==='chase'&&dist>1.5){
        const spd=cfg.spd*dt;
        const nx=bx+dx/dist*spd, nz=bz+dz/dist*spd;
        if(!onCollides(nx,nz)){ bot.group.position.x=nx; bot.group.position.z=nz; }
        else{
          // Intentar rodear obst√°culo
          const nx2=bx+(-dz/dist)*spd, nz2=bz+(dx/dist)*spd;
          if(!onCollides(nx2,nz2)){ bot.group.position.x=nx2; bot.group.position.z=nz2; }
        }
      }
    }

    // ‚îÄ‚îÄ Disparar al jugador ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    bot.shootCd=Math.max(0,bot.shootCd-dt*1000);
    if(bot.state==='shoot' && bot.shootCd<=0 && onAlive){
      bot.shootCd=cfg.shootCd;
      // Error de punter√≠a
      const aimX=dx/dist + (Math.random()-.5)*cfg.aimErr*2;
      const aimZ=dz/dist + (Math.random()-.5)*cfg.aimErr*2;
      // Calcular si acierta (dot product)
      const acc=1-cfg.aimErr;
      const roll=Math.random();
      if(roll<acc){
        // Zona aleatoria ponderada
        const r2=Math.random();
        const zone=r2<.15?'head':r2<.55?'body':'legs';
        const dmg=zone==='head'?50:zone==='body'?cfg.dmg:15;
        onMyHP=Math.max(0,onMyHP-dmg);
        onUpdateHP(onMyHP);
        onHandleDamage({hp:onMyHP, dmg, zone});
        if(onMyHP<=0) btPlayerDied(bot);
      }
      // Flash de disparo en el bot
      if(bot.group.userData.anim) bot.group.userData.anim.shootT=1;
      onAddFeed(bot.name+' ‚û§ '+(currentUser?.name||'T√ö'),'#4488ff');
    }

    onAnimateChar(bot.group, dt);
  });
}

function btDist(a,b){ const dx=a.x-b.x,dz=a.z-b.z; return Math.sqrt(dx*dx+dz*dz); }

function btPlayerDied(killer){
  if(!onAlive) return;
  onAlive=false;
  onTeamScores[1]=(onTeamScores[1]||0)+1;
  document.getElementById('duel-opp-kills').textContent=onTeamScores[1];
  document.getElementById('duel-death-vignette').style.display='block';
  document.getElementById('duel-death-vignette').style.opacity='1';
  const rm=document.getElementById('duel-respawn-msg');
  rm.textContent='üíÄ REAPARECIENDO...'; rm.style.display='block'; rm.style.color='#ff3d71';
  if(onTeamScores[1]>=btFirstTo){ btGameOver(false); return; }
  setTimeout(()=>{
    if(!btActive) return;
    onSpawnPlayer(onMySpawn);
    document.getElementById('duel-death-vignette').style.display='none';
    document.getElementById('duel-respawn-msg').style.display='none';
    // Bots tambi√©n respawnean
    btBots.forEach(b=>btRespawnBot(b));
  },1500);
}

function btBotKilled(bot){
  bot.alive=false; bot.hp=0;
  onOpps.delete(bot.slot);
  if(bot.group.userData.anim){ bot.group.userData.anim.dead=true; bot.group.userData.anim.deathT=0; }
  setTimeout(()=>{ onScene.remove(bot.group); },1500);

  onTeamScores[0]=(onTeamScores[0]||0)+1;
  document.getElementById('duel-my-kills').textContent=onTeamScores[0];
  onAddFeed((currentUser?.name||'T√ö')+' ‚û§ '+bot.name,'#44ff88');

  // Show opp HP at 0
  const wrap=document.getElementById('duel-opp-hp-wrap');
  const bar=document.getElementById('duel-opp-hp-bar');
  const num=document.getElementById('duel-opp-hp-num');
  if(wrap) wrap.style.display='flex';
  if(bar){ bar.style.width='0%'; bar.style.background='linear-gradient(90deg,#ff2200,#ff5533)'; }
  if(num){ num.textContent=0; num.style.color='#ff4444'; }

  if(onTeamScores[0]>=btFirstTo){ btGameOver(true); return; }

  // Respawn bot after 1.5s
  setTimeout(()=>{
    if(!btActive) return;
    btRespawnBot(bot);
    // Player also respawns
    onSpawnPlayer(onMySpawn);
    document.getElementById('duel-death-vignette').style.display='none';
    document.getElementById('duel-respawn-msg').style.display='none';
  },1500);
}

function btRespawnBot(bot){
  const sp=BT_SPAWNS_BLUE[bot.slot%BT_SPAWNS_BLUE.length];
  // Rebuild mesh
  const col=TEAM_COLORS[1]||0x2277ff;
  const g=onCreateRobloxChar(col);
  g.position.set(sp.x+(Math.random()-.5)*2, 0, sp.z+(Math.random()-.5)*2);
  onScene.add(g);
  bot.group=g; bot.hp=100; bot.alive=true; bot.spawn=sp;
  bot.hitbox=g.userData.hitbox; bot.headHitbox=g.userData.headHitbox; bot.legHitbox=g.userData.legHitbox;
  onOpps.set(bot.slot,{group:g,hitbox:g.userData.hitbox,headHitbox:g.userData.headHitbox,legHitbox:g.userData.legHitbox});
  // Update opp HP bar
  const bar=document.getElementById('duel-opp-hp-bar');
  const num=document.getElementById('duel-opp-hp-num');
  if(bar){ bar.style.width='100%'; bar.style.background='linear-gradient(90deg,#44cc66,#66ff88)'; }
  if(num){ num.textContent=100; num.style.color='#66ff88'; }
}

function btGameOver(won){
  btActive=false;
  const t=document.getElementById('duel-go-title');
  const s=document.getElementById('duel-go-score');
  if(t){ t.textContent=won?'¬°VICTORIA!':'DERROTA'; t.style.color=won?'var(--green)':'var(--accent2)'; }
  if(s) s.textContent='T√∫ '+onTeamScores[0]+' ‚Äî Bots '+onTeamScores[1];
  document.getElementById('duel-go-vs').textContent='VS BOTS ¬∑ '+btDiff.toUpperCase();
  onShowScreen('duel-gameover-screen');
  // Play again ‚Üí bots again
  document.getElementById('play-again-btn').onclick=()=>{ onShowScreen(null); botsStartMatch(btBots.length,btDiff); };
  document.getElementById('menu-btn').onclick=()=>{ botsCleanup(); onShowScreen(null); document.getElementById('menu-screen').classList.remove('hidden'); };
}

function botsCleanup(){
  btActive=false;
  btBots.forEach(b=>{ if(b.group&&onScene) onScene.remove(b.group); });
  btBots=[]; onOpps.clear();
  if(btAnimId){ cancelAnimationFrame(btAnimId); btAnimId=null; }
  onActive=false; onLocked=false;
  try{ document.exitPointerLock(); }catch(e){}
}

// ‚îÄ‚îÄ Hook: interceptar hits del jugador para da√±ar bots ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _origTryShoot=onTryShoot;
function onTryShoot(){
  if(!btActive){ _origTryShoot(); return; }
  if(!onAlive||!onActive||!onCanShoot||onReloading) return;
  const wp=WEAPONS[onCurWeapon];
  if(onAmmo[onCurWeapon]<=0){ onStartReload(); return; }
  onCanShoot=false; setTimeout(()=>onCanShoot=true,wp.cd);
  onAmmo[onCurWeapon]--; onUpdateWeaponHUD();
  if(onAmmo[onCurWeapon]===0) setTimeout(onStartReload,300);
  playGunshot(); onGunAnim=1;
  const fl=new THREE.PointLight(0xff3d71,7,2); fl.position.set(0,.03,-.42); onCamera.add(fl); setTimeout(()=>onCamera.remove(fl),55);

  for(let p=0;p<wp.pellets;p++){
    const dx2=(Math.random()-.5)*wp.spread*2, dy2=(Math.random()-.5)*wp.spread*2;
    onRaycaster.setFromCamera(new THREE.Vector2(dx2,dy2),onCamera);
    const wallHits=onRaycaster.intersectObjects(onWalls,false);
    const wallDist=wallHits.length>0?wallHits[0].distance:Infinity;

    // Head
    const heads=btBots.filter(b=>b.alive&&b.headHitbox).map(b=>b.headHitbox);
    const hh=onRaycaster.intersectObjects(heads,false);
    if(hh.length>0&&hh[0].distance<wallDist){
      const bot=btBots.find(b=>b.headHitbox===hh[0].object);
      if(bot&&bot.alive){
        btDamageBotByPlayer(bot,wp.dmgHead,'head'); onShowHitMarker(true); continue;
      }
    }
    // Body
    const bodies=btBots.filter(b=>b.alive&&b.hitbox).map(b=>b.hitbox);
    const bh=onRaycaster.intersectObjects(bodies,false);
    if(bh.length>0&&bh[0].distance<wallDist){
      const bot=btBots.find(b=>b.hitbox===bh[0].object);
      if(bot&&bot.alive){ btDamageBotByPlayer(bot,wp.dmgBody,'body'); onShowHitMarker(false); continue; }
    }
    // Legs
    const legs=btBots.filter(b=>b.alive&&b.legHitbox).map(b=>b.legHitbox);
    const lh=onRaycaster.intersectObjects(legs,false);
    if(lh.length>0&&lh[0].distance<wallDist){
      const bot=btBots.find(b=>b.legHitbox===lh[0].object);
      if(bot&&bot.alive){ btDamageBotByPlayer(bot,wp.dmgLegs,'legs'); onShowHitMarker(false); }
    }
  }
}

function btDamageBotByPlayer(bot,dmg,zone){
  bot.hp=Math.max(0,bot.hp-dmg);
  // Flash rojo en bot
  bot.group.traverse(c=>{ if(c.isMesh&&c.material?.color){ if(!c.userData._oc) c.userData._oc=c.material.color.getHex(); c.material.color.setHex(0xff1100); } });
  setTimeout(()=>bot.group.traverse(c=>{ if(c.isMesh&&c.userData._oc) c.material.color.setHex(c.userData._oc); }),90);
  // Update opp HP bar
  onHandleOppHP({slot:bot.slot, hp:bot.hp, dmg, zone});
  if(bot.hp<=0) btBotKilled(bot);
}

// ‚îÄ‚îÄ MODO ZOMBIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let zmActive=false, zmWave=0, zmBots=[], zmScore=0, zmHP=100, zmAnimId=null;
const ZM_SPAWNS=[{x:-18,z:-18},{x:18,z:-18},{x:-18,z:18},{x:18,z:18},{x:0,z:-19},{x:0,z:19}];

// ‚îÄ‚îÄ MAPA NOCTURNO ZOMBIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function zmBuildMap(){
  // Limpiar obst√°culos previos (no jugadores ni armas)
  onWalls.length=0; onObs.length=0;
  // Cielo nocturno + niebla oscura
  onScene.background=new THREE.Color(0x0a0d14);
  onScene.fog=new THREE.FogExp2(0x0a0d14,0.045);
  // Limpiar objetos de mapa previo conservando jugadores
  const toRemove=[];
  onScene.children.forEach(c=>{ if(c.userData.isMapObj) toRemove.push(c); });
  toRemove.forEach(c=>onScene.remove(c));

  function addMap(obj){ obj.userData.isMapObj=true; onScene.add(obj); return obj; }

  // ‚îÄ‚îÄ SUELO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const gc=document.createElement('canvas'); gc.width=gc.height=1024;
  const gx=gc.getContext('2d');
  gx.fillStyle='#1a1208'; gx.fillRect(0,0,1024,1024);
  // Tierra irregular
  gx.fillStyle='#221810';
  for(let i=0;i<80;i++) gx.fillRect(Math.random()*1024,Math.random()*1024,20+Math.random()*60,15+Math.random()*40);
  // Manchas hierba muerta
  gx.fillStyle='#1a2010';
  for(let i=0;i<40;i++) gx.fillRect(Math.random()*1024,Math.random()*1024,30+Math.random()*80,25+Math.random()*50);
  // Caminos de tierra
  gx.fillStyle='#2a1f14'; gx.fillRect(430,0,160,1024); gx.fillRect(0,430,1024,160);
  const groundTex=new THREE.CanvasTexture(gc);
  const ground=new THREE.Mesh(new THREE.PlaneGeometry(56,56),new THREE.MeshLambertMaterial({map:groundTex}));
  ground.rotation.x=-Math.PI/2; addMap(ground);

  // ‚îÄ‚îÄ ILUMINACI√ìN NOCTURNA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  addMap(new THREE.AmbientLight(0x1a2040,0.6));
  const moon=new THREE.DirectionalLight(0x3040a0,0.4); moon.position.set(-8,20,5); addMap(moon);

  // ‚îÄ‚îÄ FUNCI√ìN AUXILIAR: fuego/antorcha ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addFire(x,z,scale=1){
    const base=new THREE.Mesh(new THREE.CylinderGeometry(.12,.15,.25,8),new THREE.MeshLambertMaterial({color:0x333333}));
    base.position.set(x,.12,z); addMap(base);
    const flame=new THREE.Mesh(new THREE.ConeGeometry(.12*scale,.35*scale,7),new THREE.MeshBasicMaterial({color:0xff6600}));
    flame.position.set(x,.45*scale,z); flame.userData.isFlame=true; addMap(flame);
    const light=new THREE.PointLight(0xff4400,2.5*scale,5*scale); light.position.set(x,.6*scale,z); light.userData.isFlameLight=true; addMap(light);
  }

  // ‚îÄ‚îÄ FUNCI√ìN: edificio abandonado CON PUERTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addBuilding(cx,cz,w,d,h,rot,hasLight){
    const wallM=new THREE.MeshLambertMaterial({color:0x2a2218});
    const roofM=new THREE.MeshLambertMaterial({color:0x1a1510});
    const doorW=1.1, doorH=1.9;  // Tama√±o de la puerta

    // Construir 4 paredes con hueco de puerta en la pared frontal (sur)
    // Pared trasera (norte) ‚Äî s√≥lida
    const wBack=new THREE.Mesh(new THREE.BoxGeometry(w,.1+h,.22),wallM);
    wBack.position.set(cx,h/2-.05,cz-d/2+.11); addMap(wBack); onWalls.push(wBack);

    // Paredes laterales ‚Äî s√≥lidas
    const wLeft=new THREE.Mesh(new THREE.BoxGeometry(.22,h,d),wallM);
    wLeft.position.set(cx-w/2+.11,h/2,cz); addMap(wLeft); onWalls.push(wLeft);
    const wRight=new THREE.Mesh(new THREE.BoxGeometry(.22,h,d),wallM);
    wRight.position.set(cx+w/2-.11,h/2,cz); addMap(wRight); onWalls.push(wRight);

    // Pared frontal (sur) ‚Äî con hueco de puerta en el centro
    const sideW=(w-doorW)/2-.11;
    if(sideW>0.1){
      // Segmento izquierdo de pared frontal
      const wFL=new THREE.Mesh(new THREE.BoxGeometry(sideW,h,.22),wallM);
      wFL.position.set(cx-(doorW/2+sideW/2),h/2,cz+d/2-.11); addMap(wFL); onWalls.push(wFL);
      // Segmento derecho de pared frontal
      const wFR=new THREE.Mesh(new THREE.BoxGeometry(sideW,h,.22),wallM);
      wFR.position.set(cx+(doorW/2+sideW/2),h/2,cz+d/2-.11); addMap(wFR); onWalls.push(wFR);
    }
    // Dintel sobre la puerta
    const wFTop=new THREE.Mesh(new THREE.BoxGeometry(w,.22*(h-doorH),.22),wallM);
    wFTop.position.set(cx,doorH+(h-doorH)/2,cz+d/2-.11);
    if(h>doorH+0.1){ addMap(wFTop); onWalls.push(wFTop); }

    // Colisi√≥n: 3 cajas (izq, der, fondo) dejando hueco al frente
    onObs.push({x:cx-w/2+.6,  z:cz,      hw:.6,  hd:d/2+.1}); // pared izq
    onObs.push({x:cx+w/2-.6,  z:cz,      hw:.6,  hd:d/2+.1}); // pared der
    onObs.push({x:cx,          z:cz-d/2+.3, hw:w/2, hd:.3  }); // pared fondo

    // Techo
    const roof=new THREE.Mesh(new THREE.BoxGeometry(w+.25,0.14,d+.25),roofM);
    roof.position.set(cx,h+.07,cz); addMap(roof);
    // Techo inclinado
    const ridgeM=new THREE.MeshLambertMaterial({color:0x151210});
    const ridge=new THREE.Mesh(new THREE.CylinderGeometry(0,Math.max(w,d)*.52,1.1,4),ridgeM);
    ridge.position.set(cx,h+.65,cz); ridge.rotation.y=Math.PI/4; addMap(ridge);

    // Luz interior si tiene
    if(hasLight){
      const wl=new THREE.PointLight(0x806020,1.5,7); wl.position.set(cx,h*.6,cz); addMap(wl);
      // Efecto de luz saliendo por la puerta
      const dl=new THREE.PointLight(0x604010,.8,3.5); dl.position.set(cx,1.0,cz+d/2+.3); addMap(dl);
    }

    // Marco de puerta
    const frameM=new THREE.MeshLambertMaterial({color:0x120c06});
    const fL=new THREE.Mesh(new THREE.BoxGeometry(.1,doorH,.22),frameM);
    fL.position.set(cx-doorW/2,doorH/2,cz+d/2-.11); addMap(fL);
    const fR=new THREE.Mesh(new THREE.BoxGeometry(.1,doorH,.22),frameM);
    fR.position.set(cx+doorW/2,doorH/2,cz+d/2-.11); addMap(fR);
    const fT=new THREE.Mesh(new THREE.BoxGeometry(doorW+.1,.1,.22),frameM);
    fT.position.set(cx,doorH,cz+d/2-.11); addMap(fT);

    // Tablones decorativos en paredes laterales
    const plankM=new THREE.MeshLambertMaterial({color:0x1a100a});
    for(let i=0;i<2;i++){
      const plank=new THREE.Mesh(new THREE.BoxGeometry(.04,.06,d*.7),plankM);
      plank.position.set(cx-w/2+.12,0.5+i*.6,cz); addMap(plank);
    }
  }

  // ‚îÄ‚îÄ FUNCI√ìN: carro oxidado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addCar(x,z,rot){
    const carM=new THREE.MeshLambertMaterial({color:0x2a1a10});
    const rustM=new THREE.MeshLambertMaterial({color:0x3d1a08});
    const body=new THREE.Mesh(new THREE.BoxGeometry(1.9,.7,4.0),carM);
    body.position.set(x,.4,z); body.rotation.y=rot; body.castShadow=true;
    addMap(body); onWalls.push(body); onObs.push({x,z,hw:1.1,hd:2.1});
    const cab=new THREE.Mesh(new THREE.BoxGeometry(1.7,.65,2.0),rustM);
    cab.position.set(x,.92+.3,z-.3); cab.rotation.y=rot; addMap(cab);
    // Ruedas
    [[-.95,-.0,1.2],[.95,-.0,1.2],[-.95,-.0,-1.2],[.95,-.0,-1.2]].forEach(([wx,wy,wz])=>{
      const wheel=new THREE.Mesh(new THREE.CylinderGeometry(.32,.32,.22,12),new THREE.MeshLambertMaterial({color:0x0a0a0a}));
      wheel.rotation.z=Math.PI/2; wheel.position.set(x+wx,.28,z+wz); addMap(wheel);
    });
  }

  // ‚îÄ‚îÄ FUNCI√ìN: bus abandonado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addBus(x,z,rot){
    const busM=new THREE.MeshLambertMaterial({color:0x222018});
    const bus=new THREE.Mesh(new THREE.BoxGeometry(2.4,1.8,7.5),busM);
    bus.position.set(x,.9,z); bus.rotation.y=rot; bus.castShadow=true;
    addMap(bus); onWalls.push(bus); onObs.push({x,z,hw:1.3,hd:3.9});
    // Ventanas rotas (oscuras)
    const winM=new THREE.MeshBasicMaterial({color:0x0a0f14});
    for(let i=-2;i<=2;i++){
      const win=new THREE.Mesh(new THREE.PlaneGeometry(.55,.5),winM);
      win.position.set(x+1.21,1.2,z+i*1.1); win.rotation.y=Math.PI/2; addMap(win);
    }
    // Ruedas
    [[-1.2,0,2.8],[1.2,0,2.8],[-1.2,0,-2.8],[1.2,0,-2.8]].forEach(([wx,wy,wz])=>{
      const w2=new THREE.Mesh(new THREE.CylinderGeometry(.42,.42,.28,12),new THREE.MeshLambertMaterial({color:0x080808}));
      w2.rotation.z=Math.PI/2; w2.position.set(x+wx,.32,z+wz); addMap(w2);
    });
  }

  // ‚îÄ‚îÄ FUNCI√ìN: barricada de cajas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addBarricade(x,z,rot,count=3){
    const boxM=new THREE.MeshLambertMaterial({color:0x2a1e0e});
    for(let i=0;i<count;i++){
      const box=new THREE.Mesh(new THREE.BoxGeometry(.65,.55,.55),boxM);
      box.position.set(x+Math.cos(rot)*i*.6,  .28, z+Math.sin(rot)*i*.6);
      box.rotation.y=rot+Math.random()*.3; addMap(box); onWalls.push(box);
    }
    onObs.push({x,z,hw:count*.35,hd:.4});
  }

  // ‚îÄ‚îÄ FUNCI√ìN: √°rbol muerto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addDeadTree(x,z){
    const trunkM=new THREE.MeshLambertMaterial({color:0x1a1208});
    const trunk=new THREE.Mesh(new THREE.CylinderGeometry(.12,.18,3.5,6),trunkM);
    trunk.position.set(x,1.75,z); addMap(trunk);
    [[.6,3.2,.5,0,.4],[-.7,2.8,.45,0,.35],[ .3,3.6,.35,0,.28],[-.2,2.4,.4,0,.32]].forEach(([bx,by,bz,_,r])=>{
      const br=new THREE.Mesh(new THREE.CylinderGeometry(.03,.07,1.4,5),trunkM);
      br.position.set(x+bx,by,z+bz); br.rotation.z=(bx>0?1:-1)*.6; br.rotation.x=.3; addMap(br);
    });
  }

  // ‚îÄ‚îÄ LAYOUT DEL MAPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Edificio central (taller con luz verde interior)
  addBuilding(0,0,6,5,3.2,0,true);
  // Edificio superior izquierdo (galp√≥n)
  addBuilding(-13,12,7,5.5,2.8,0,false);
  // Edificio superior derecho (iglesia peque√±a)
  addBuilding(13,12,4.5,5,4.0,0,true);
  // Edificio izquierdo (garaje)
  addBuilding(-13,-2,6,5.5,2.6,.05,true);
  // Edificio derecho (casa destruida)
  addBuilding(13,-2,5.5,5,2.8,-.04,false);
  // Edificio inferior izquierdo (bunker)
  addBuilding(-8,-13,5,4.5,2.2,0,false);
  // Edificio inferior central (ruinas)
  addBuilding(2,-13,4.5,4,2.0,.1,false);

  // Bus en el centro-derecha
  addBus(5,2,Math.PI/2);
  // Carros oxidados
  addCar(-4,6,0.3);
  addCar(10,-8,-0.2);
  addCar(-9,8,2.8);

  // Barricadas de cajas
  addBarricade(4,-5, 0.1, 4);
  addBarricade(-5,4, 1.6, 3);
  addBarricade(8,6,  0.8, 3);
  addBarricade(-3,-7,2.2, 3);

  // Fuegos dispersos (como en la imagen)
  addFire(-13, 2);   // frente garaje izq
  addFire( 13, 6);   // esquina der
  addFire(-8,  12);  // zona superior izq
  addFire( 3, -11);  // zona inferior
  addFire( 0,  6,1.4); // fuego grande central
  addFire(-5, -4, 0.8);
  addFire( 9, -3, 0.9);
  addFire(-14,-10, 0.7);

  // Barriles
  const barrelM=new THREE.MeshLambertMaterial({color:0x1a1010});
  [[-6,2],[6,-6],[3,8],[-10,5],[11,3],[-4,-10],[7,11],[-11,-7]].forEach(([bx,bz])=>{
    const b=new THREE.Mesh(new THREE.CylinderGeometry(.25,.28,.7,8),barrelM);
    b.position.set(bx,.35,bz); addMap(b);
  });

  // √Årboles muertos en bordes
  addDeadTree(-22,-22); addDeadTree(22,-20); addDeadTree(-20,20);
  addDeadTree(21,21);   addDeadTree(0,-22);  addDeadTree(-22,5);
  addDeadTree(22,8);

  // Cerca de madera perimetral
  const fenceM=new THREE.MeshLambertMaterial({color:0x1a1208});
  for(let i=-5;i<=5;i++){
    const post=new THREE.Mesh(new THREE.BoxGeometry(.08,1.2,.08),fenceM);
    post.position.set(i*4.2,-0.1,-23); addMap(post);
    const post2=new THREE.Mesh(new THREE.BoxGeometry(.08,1.2,.08),fenceM);
    post2.position.set(i*4.2,-0.1,23); addMap(post2);
  }

  // Piedras dispersas
  const stoneM=new THREE.MeshLambertMaterial({color:0x252220});
  [[4,4],[-7,8],[8,-4],[-3,12],[11,10],[-12,-5]].forEach(([sx,sz])=>{
    if(!isNaN(sx)){
      const s=new THREE.Mesh(new THREE.SphereGeometry(.18+Math.random()*.12,5,4),stoneM);
      s.position.set(sx,.1,sz); addMap(s);
    }
  });

  // Animaci√≥n de llamas (flickering)
  function flickerFires(){
    onScene.children.forEach(c=>{
      if(c.userData.isFlame){c.scale.y=0.85+Math.random()*.3; c.rotation.y+=.08; c.material.color.setHSL(.06+Math.random()*.04,.9,.5+Math.random()*.1);}
      if(c.userData.isFlameLight){c.intensity=2+Math.random()*1.5;}
    });
    if(zmActive) requestAnimationFrame(flickerFires);
  }
  flickerFires();
}

// ‚îÄ‚îÄ ZOMBIE REALISTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function zmCreateZombie(){
  const g=new THREE.Group();
  // Variaci√≥n aleatoria de zombie (3 tipos)
  const variant=Math.floor(Math.random()*3);
  // Piel putrefacta (verdosa / gris)
  const skinColors=[0x3d4a1a, 0x2e3d18, 0x3a4030];
  const skinM=new THREE.MeshPhongMaterial({color:skinColors[variant],shininess:5});
  // Ropa desgarrada (marr√≥n oscuro / gris)
  const clothColors=[0x2a1a0e, 0x1e1e1e, 0x2e2010];
  const clothM=new THREE.MeshPhongMaterial({color:clothColors[variant],shininess:3});
  const darkM=new THREE.MeshPhongMaterial({color:0x0f0f0f,shininess:2});

  // Cabeza ligeramente agrandada y encorvada
  const head=new THREE.Mesh(new THREE.BoxGeometry(.48,.5,.46),skinM); head.position.y=1.55; head.rotation.x=.25; // encorvado hacia adelante
  head.castShadow=true; g.add(head);

  // Ojos brillantes (rojizos o amarillos)
  const eyeColors=[0xff1100,0xffaa00,0xff6600];
  const eyeM=new THREE.MeshBasicMaterial({color:eyeColors[variant]});
  [-1,1].forEach(sx=>{
    const eye=new THREE.Mesh(new THREE.BoxGeometry(.1,.1,.03),eyeM);
    eye.position.set(sx*.12,1.58,.24); g.add(eye);
    // Brillo de ojos
    const glow=new THREE.PointLight(eyeColors[variant],.6,1.2); glow.position.set(sx*.1,1.58,.2); g.add(glow);
  });

  // Boca abierta (dientes)
  const mouthM=new THREE.MeshBasicMaterial({color:0x0a0000});
  const mouth=new THREE.Mesh(new THREE.BoxGeometry(.18,.06,.02),mouthM); mouth.position.set(0,1.45,.24); g.add(mouth);
  const toothM=new THREE.MeshBasicMaterial({color:0xccbb99});
  [-1,0,1].forEach(ti=>{
    const tooth=new THREE.Mesh(new THREE.BoxGeometry(.04,.06,.02),toothM); tooth.position.set(ti*.06,1.46,.245); g.add(tooth);
  });

  // Torso encorvado y corpulento
  const torso=new THREE.Mesh(new THREE.BoxGeometry(.54,.6,.3),clothM); torso.position.y=1.05; torso.rotation.x=.2; torso.castShadow=true; g.add(torso);

  // Brazos asim√©tricos (uno levantado tipo zombie)
  const aLPivot=new THREE.Object3D(); aLPivot.position.set(-.35,1.35,0); g.add(aLPivot);
  const aLMesh=new THREE.Mesh(new THREE.BoxGeometry(.2,.52,.2),clothM); aLMesh.position.y=-.26; aLPivot.add(aLMesh);
  aLPivot.rotation.x=-0.9; // brazo izquierdo levantado (ataque)

  const aRPivot=new THREE.Object3D(); aRPivot.position.set(.35,1.35,0); g.add(aRPivot);
  const aRMesh=new THREE.Mesh(new THREE.BoxGeometry(.2,.52,.2),skinM); aRMesh.position.y=-.26; aRPivot.add(aRMesh);
  aRPivot.rotation.x=-0.5;

  // Manos con garras
  const clawM=new THREE.MeshPhongMaterial({color:0x1a1a0a,shininess:8});
  const lHand=new THREE.Mesh(new THREE.BoxGeometry(.22,.18,.18),skinM); lHand.position.y=-.5; aLPivot.add(lHand);
  [-1,0,1].forEach(fi=>{
    const claw=new THREE.Mesh(new THREE.BoxGeometry(.04,.12,.04),clawM); claw.position.set(fi*.06,-.64,0); claw.rotation.x=.4; aLPivot.add(claw);
  });
  const rHand=new THREE.Mesh(new THREE.BoxGeometry(.22,.18,.18),skinM); rHand.position.y=-.5; aRPivot.add(rHand);

  // Piernas
  const lLPivot=new THREE.Object3D(); lLPivot.position.set(-.14,.7,0); g.add(lLPivot);
  const lLMesh=new THREE.Mesh(new THREE.BoxGeometry(.22,.52,.22),clothM); lLMesh.position.y=-.26; lLPivot.add(lLMesh);
  const lRPivot=new THREE.Object3D(); lRPivot.position.set(.14,.7,0); g.add(lRPivot);
  const lRMesh=new THREE.Mesh(new THREE.BoxGeometry(.22,.52,.22),darkM); lRMesh.position.y=-.26; lRPivot.add(lRMesh);

  // Pies
  const footM=new THREE.MeshPhongMaterial({color:0x0a0808});
  const fL=new THREE.Mesh(new THREE.BoxGeometry(.24,.12,.28),footM); fL.position.set(-.14,.1,.04); g.add(fL);
  const fR=new THREE.Mesh(new THREE.BoxGeometry(.24,.12,.28),footM); fR.position.set(.14,.1,.04); g.add(fR);

  // Manchas de sangre (decoraci√≥n)
  const bloodM=new THREE.MeshBasicMaterial({color:0x330000});
  const blood=new THREE.Mesh(new THREE.BoxGeometry(.15,.08,.31),bloodM); blood.position.set(.1,1.1,.16); g.add(blood);

  // Hitboxes
  const hb=new THREE.Mesh(new THREE.BoxGeometry(.54,.95,.54),new THREE.MeshBasicMaterial({visible:false})); hb.position.y=1.05; g.add(hb); g.userData.hitbox=hb;
  const headHB=new THREE.Mesh(new THREE.BoxGeometry(.5,.52,.5),new THREE.MeshBasicMaterial({visible:false})); headHB.position.y=1.58; g.add(headHB); g.userData.headHitbox=headHB;
  const legHB=new THREE.Mesh(new THREE.BoxGeometry(.54,.75,.54),new THREE.MeshBasicMaterial({visible:false})); legHB.position.y=.4; g.add(legHB); g.userData.legHitbox=legHB;

  g.userData.limbs={head,torso,aL:aLPivot,aR:aRPivot,lL:lLPivot,lR:lRPivot};
  g.userData.anim={walkPhase:0,shootT:0,deathT:0,dead:false,prevX:null,prevZ:null,idleT:Math.random()*100,jumping:false};
  g.userData.isZombie=true;
  return g;
}

function zmStart(){
  if(zmActive) return;
  zmActive=true; zmWave=0; zmBots=[]; zmScore=0; zmHP=100;
  if(!onThreeReady) onInitThree();
  zmBuildMap(); // Cambiar a mapa nocturno zombie
  // Reusar pantalla PVP
  document.getElementById('duel-canvas').style.display='block';
  document.getElementById('duel-hud').style.display='block';
  document.getElementById('duel-crosshair').style.display='block';
  onSpawnPlayer({x:0,z:0,yaw:0});
  onActive=true;
  // HUD zombie
  document.getElementById('duel-my-name-hud').textContent='ZOMBIES';
  document.getElementById('duel-opp-name-hud').textContent='OLEADA';
  document.getElementById('duel-my-kills').textContent='0';
  document.getElementById('duel-opp-kills').textContent='1';
  onInitWeaponSlots();
  if(!mobileMode){
    document.getElementById('duel-lock-screen').style.display='flex';
    document.getElementById('duel-lock-btn').onclick=()=>{
      document.getElementById('duel-canvas').requestPointerLock();
      document.getElementById('duel-lock-screen').style.display='none';
    };
  } else {
    onLocked=true;
    document.getElementById('duel-mobile-controls').classList.add('active');
  }
  if(onAnimId) cancelAnimationFrame(onAnimId);
  let last=performance.now();
  function zmLoop(now){
    onAnimId=requestAnimationFrame(zmLoop);
    const dt=Math.min((now-last)/1000,.05); last=now;
    if(zmActive){ onMove(dt); onApplyCam(); onAnimGun(dt); zmUpdateBots(dt); onUpdateGrenades(dt); onApplyCamShake(dt); }
    onRenderer.render(onScene,onCamera);
  }
  zmLoop(performance.now());
  setTimeout(()=>zmSpawnWave(),800);
}

function zmSpawnWave(){
  if(!zmActive) return;
  zmWave++;
  document.getElementById('duel-opp-kills').textContent=zmWave;
  const count=Math.min(3+zmWave*2,16);
  const waveEl=document.createElement('div');
  waveEl.textContent='üßü OLEADA '+zmWave+' ¬∑ '+count+' ZOMBIES';
  waveEl.style.cssText='position:fixed;top:30%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:1.3rem;font-weight:900;color:#44ff44;text-shadow:0 0 20px #00ff00;pointer-events:none;z-index:65;animation:float-up 1.8s ease-out forwards;';
  document.body.appendChild(waveEl); setTimeout(()=>waveEl.remove(),1800);
  for(let i=0;i<count;i++){
    setTimeout(()=>{ if(zmActive) zmSpawnBot(); }, i*400);
  }
}

function zmSpawnBot(){
  const sp=ZM_SPAWNS[Math.floor(Math.random()*ZM_SPAWNS.length)];
  const g=zmCreateZombie();
  g.position.set(sp.x+(Math.random()-.5)*3, 0, sp.z+(Math.random()-.5)*3);
  onScene.add(g);
  const bot={
    group:g, hp:Math.min(40+zmWave*15,200),
    hitbox:g.userData.hitbox, headHitbox:g.userData.headHitbox,
    slot:'zm_'+Date.now()+'_'+Math.random(),
    alive:true, attackCd:0
  };
  onOpps.set(bot.slot, {group:g, hitbox:g.userData.hitbox, headHitbox:g.userData.headHitbox, legHitbox:g.userData.legHitbox});
  zmBots.push(bot);
}

function zmUpdateBots(dt){
  const px=onPos.x, pz=onPos.z;
  zmBots.forEach(bot=>{
    if(!bot.alive) return;
    const bx=bot.group.position.x, bz=bot.group.position.z;
    const dx=px-bx, dz=pz-bz, dist=Math.sqrt(dx*dx+dz*dz);
    // Rotar hacia el jugador
    bot.group.rotation.y=Math.atan2(dx,dz);
    // Moverse hacia el jugador
    if(dist>0.8){
      const spd=(1.8+zmWave*0.15)*dt;
      bot.group.position.x+=dx/dist*spd;
      bot.group.position.z+=dz/dist*spd;
    } else {
      // Atacar
      bot.attackCd-=dt;
      if(bot.attackCd<=0){
        bot.attackCd=1.2;
        zmHP=Math.max(0,zmHP-15);
        onUpdateHP(zmHP);
        onCamShake=0.35;
        if(zmHP<=0){ zmGameOver(); return; }
      }
    }
    // Animar
    onAnimateChar(bot.group,dt);
  });
  // Checar si oleada completada
  if(zmBots.length>0&&zmBots.every(b=>!b.alive)){
    zmBots=[];
    // Curar un poco entre oleadas
    zmHP=Math.min(100,zmHP+20); onUpdateHP(zmHP);
    setTimeout(()=>{ if(zmActive) zmSpawnWave(); },2000);
  }
}

function zmOnShoot(){
  if(!zmActive||!onCanShoot||onReloading) return;
  const wp=WEAPONS[onCurWeapon];
  if(onAmmo[onCurWeapon]<=0){ onStartReload(); return; }
  onCanShoot=false; setTimeout(()=>onCanShoot=true,wp.cd);
  onAmmo[onCurWeapon]--; onUpdateWeaponHUD();
  if(onAmmo[onCurWeapon]===0) setTimeout(onStartReload,300);
  playGunshot(); onGunAnim=1;
  for(let p=0;p<wp.pellets;p++){
    const spread=wp.spread;
    const dir=new THREE.Vector2((Math.random()-.5)*spread*2,(Math.random()-.5)*spread*2);
    onRaycaster.setFromCamera(dir,onCamera);
    const wallHits=onRaycaster.intersectObjects(onWalls,false);
    const wallDist=wallHits.length>0?wallHits[0].distance:Infinity;
    // Head
    const headBoxes=zmBots.filter(b=>b.alive&&b.headHitbox).map(b=>b.headHitbox);
    const hHits=onRaycaster.intersectObjects(headBoxes,false);
    if(hHits.length>0&&hHits[0].distance<wallDist){
      const hit=zmBots.find(b=>b.headHitbox===hHits[0].object);
      if(hit&&hit.alive){ zmDamageBot(hit,wp.dmgHead,true); continue; }
    }
    // Body
    const bodyBoxes=zmBots.filter(b=>b.alive&&b.hitbox).map(b=>b.hitbox);
    const bHits=onRaycaster.intersectObjects(bodyBoxes,false);
    if(bHits.length>0&&bHits[0].distance<wallDist){
      const hit=zmBots.find(b=>b.hitbox===bHits[0].object);
      if(hit&&hit.alive) zmDamageBot(hit,wp.dmgBody,false);
    }
  }
}

function zmDamageBot(bot,dmg,head){
  bot.hp-=dmg;
  onShowHitMarker(head);
  if(bot.hp<=0){
    bot.alive=false;
    onOpps.delete(bot.slot);
    if(bot.group.userData.anim){ bot.group.userData.anim.dead=true; bot.group.userData.anim.deathT=0; }
    setTimeout(()=>onScene.remove(bot.group),1500);
    zmScore+=head?200:100; zmScore+=zmWave*10;
    document.getElementById('duel-my-kills').textContent=zmScore;
    const el=document.createElement('div');
    el.textContent=head?'üí• +'+(200+zmWave*10):'+'+( 100+zmWave*10);
    el.style.cssText='position:fixed;top:45%;left:50%;transform:translateX(-50%);font-family:Orbitron,monospace;font-size:.85rem;color:'+(head?'#ffd700':'#00ff88')+';pointer-events:none;z-index:65;animation:float-up .7s ease-out forwards;';
    document.body.appendChild(el); setTimeout(()=>el.remove(),700);
  }
}

function zmGameOver(){
  zmActive=false;
  zmBots.forEach(b=>{ if(onScene) onScene.remove(b.group); }); zmBots=[];
  onOpps.forEach(o=>onScene.remove(o.group)); onOpps.clear();
  onCleanup();
  const t=document.getElementById('duel-go-title');
  t.textContent='üíÄ GAME OVER'; t.style.color='#ff3d71'; t.style.textShadow='0 0 30px #ff3d71';
  document.getElementById('duel-go-vs').textContent='MODO ZOMBIE ¬∑ OLEADA '+zmWave;
  document.getElementById('duel-go-score').textContent='PUNTUACI√ìN: '+zmScore;
  document.getElementById('duel-gameover-screen').classList.remove('hidden');
}

// ‚îÄ‚îÄ GRANADAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onThrowGrenade(){
  if(!onAlive||!onActive||onGrenades<=0||onGrenCooldown) return;
  onGrenades--;
  onGrenCooldown=true;
  setTimeout(()=>onGrenCooldown=false,3500);
  const grenEl=document.getElementById('duel-gren-hud');
  if(grenEl) grenEl.textContent=onGrenades>0?'üí£'.repeat(onGrenades):'‚Äî';
  // Crear mesh de granada
  const geo=new THREE.SphereGeometry(.12,8,8);
  const mat=new THREE.MeshLambertMaterial({color:0x2a4a1a});
  const mesh=new THREE.Mesh(geo,mat); mesh.castShadow=true;
  // Posici√≥n: frente a la c√°mara
  const dir=new THREE.Vector3(); onCamera.getWorldDirection(dir);
  const startPos=new THREE.Vector3(onPos.x, ON_H+onPosY-.1, onPos.z).addScaledVector(dir,.4);
  mesh.position.copy(startPos);
  onScene.add(mesh);
  onSend({type:'grenade', pos:{x:onPos.x,z:onPos.z}, yaw:onYaw, pitch:onPitch});
  // F√≠sica simple
  const vel=dir.clone().multiplyScalar(18).add(new THREE.Vector3(0,8,0));
  const gData={mesh,vel,life:0,exploded:false};
  onGrenList.push(gData);
}

function onUpdateGrenades(dt){
  for(let i=onGrenList.length-1;i>=0;i--){
    const g=onGrenList[i]; if(g.exploded){onGrenList.splice(i,1);continue;}
    g.life+=dt;
    g.vel.y-=18*dt;
    g.mesh.position.addScaledVector(g.vel,dt);
    g.mesh.rotation.x+=dt*8; g.mesh.rotation.z+=dt*5;
    if(g.mesh.position.y<0.15) g.mesh.position.y=0.15;
    if(g.life>=2.5) onExplodeGrenade(g,i);
  }
}

function onExplodeGrenade(g,idx){
  g.exploded=true;
  const pos=g.mesh.position.clone();
  onScene.remove(g.mesh);
  // Flash de explosi√≥n
  const fl=new THREE.PointLight(0xff6600,20,8); fl.position.copy(pos); onScene.add(fl);
  setTimeout(()=>onScene.remove(fl),180);
  // Esfera de onda visual
  const sphere=new THREE.Mesh(new THREE.SphereGeometry(.1,12,12),new THREE.MeshBasicMaterial({color:0xff6600,transparent:true,opacity:.9}));
  sphere.position.copy(pos); onScene.add(sphere);
  let t=0;
  function expandWave(){
    t+=0.05; sphere.scale.setScalar(1+t*40); sphere.material.opacity=Math.max(0,.9-t*3);
    if(t<.3) requestAnimationFrame(expandWave); else onScene.remove(sphere);
  }
  requestAnimationFrame(expandWave);
  // Shake de c√°mara si cerca
  const dist=new THREE.Vector3(onPos.x,ON_H,onPos.z).distanceTo(pos);
  if(dist<6){ onCamShake=0.4*(1-dist/6); }
}

let onCamShake=0;
function onApplyCamShake(dt){
  if(onCamShake<=0) return;
  onCamShake=Math.max(0,onCamShake-dt*3);
  onCamera.position.x=(Math.random()-.5)*onCamShake*.12;
  onCamera.position.y=(Math.random()-.5)*onCamShake*.12;
}

// ‚îÄ‚îÄ INIT WEAPON HUD SLOTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onInitWeaponSlots(){
  const container=document.getElementById('duel-weapon-slots');
  if(!container) return;
  container.innerHTML='';
  Object.entries(WEAPONS).forEach(([id,wp])=>{
    const slot=document.createElement('div');
    slot.className='duel-wp-slot';
    slot.dataset.wp=id;
    slot.style.cssText='padding:4px 10px;border:1px solid rgba(255,255,255,.2);border-radius:3px;cursor:pointer;font-family:Orbitron,monospace;font-size:.52rem;letter-spacing:.1em;color:#ccc;background:rgba(255,255,255,.05);transition:all .15s;';
    slot.innerHTML='<div style="font-size:.65rem">'+wp.key+'</div><div>'+wp.name+'</div>';
    slot.onclick=()=>onSwitchWeapon(id);
    container.appendChild(slot);
  });
  onUpdateWeaponHUD();
}

function onHandleKill(msg){
  onRefreshHUD();
  const killerName=onPlayerNames.get(msg.killerSlot)||'?', victimName=onPlayerNames.get(msg.victimSlot)||'?';
  if(msg.victimSlot===onMySlot){
    // Yo fui eliminado ‚Üí respawnear en MI spawn (equipo de la v√≠ctima)
    onAlive=false;
    document.getElementById('duel-death-vignette').style.display='block';
    document.getElementById('duel-respawn-msg').style.display='block';
    onAddFeed(killerName+' ‚û§ '+onMyName,'#ff4444');
    if(!msg.matchOver) setTimeout(()=>{ if(onActive){ onHandleRespawn(msg.victimSpawn||onMySpawn); } },1500);
  } else if(msg.killerSlot===onMySlot){
    // Resetear HP del rival en la barra (respawnear√° con 100)
    onOppHP=100; onUpdateOppHP(msg.victimSlot,100);
    // Yo elimin√© al rival ‚Üí yo TAMBI√âN respawnero en MI spawn (equipo del killer)
    document.getElementById('duel-kill-notif').style.opacity='1';
    setTimeout(()=>document.getElementById('duel-kill-notif').style.opacity='0',1600);
    onAddFeed(onMyName+' ‚û§ '+victimName,'#44ff88');
    const vO=onOpps.get(msg.victimSlot); if(vO&&vO.group.userData.anim){vO.group.userData.anim.dead=true;vO.group.userData.anim.deathT=0;}
    if(!msg.matchOver){
      onAlive=false;
      const rMsg=document.getElementById('duel-respawn-msg');
      rMsg.textContent='‚ö° REPOSICIONANDO...'; rMsg.style.display='block';
      rMsg.style.color='#00ff88'; rMsg.style.textShadow='0 0 14px #00ff88';
      document.getElementById('duel-death-vignette').style.opacity='0.12';
      document.getElementById('duel-death-vignette').style.display='block';
      setTimeout(()=>{
        if(onActive){
          onHandleRespawn(msg.killerSpawn||onMySpawn); // killer vuelve a su spawn de equipo
          rMsg.textContent='üíÄ REAPARECIENDO...'; rMsg.style.color='#ff3d71'; rMsg.style.textShadow='0 0 14px #ff3d71';
          document.getElementById('duel-death-vignette').style.opacity='1';
        }
      },1500);
    }
  } else {
    // Otro jugador elimin√≥ a otro ‚Üí animar muerte del rival
    onAddFeed(killerName+' ‚û§ '+victimName,'#aaaaaa');
    const vO2=onOpps.get(msg.victimSlot); if(vO2&&vO2.group.userData.anim){vO2.group.userData.anim.dead=true;vO2.group.userData.anim.deathT=0;}
  }
  if(msg.matchOver){ const won=msg.killerTeam===onMyTeam||msg.killerSlot===onMySlot; setTimeout(()=>onShowGameOver(won),1800); }
}
function onHandleRespawn(spawn){ onSpawnPlayer(spawn||onMySpawn); document.getElementById('duel-death-vignette').style.display='none'; document.getElementById('duel-respawn-msg').style.display='none'; }
function onRefreshHUD(){
  if(onRoomMode==='ffa'){ document.getElementById('duel-my-kills').textContent=onPScores[onMyName]||0; document.getElementById('duel-opp-kills').textContent='FFA'; }
  else{ document.getElementById('duel-my-kills').textContent=onTeamScores[onMyTeam]||0; document.getElementById('duel-opp-kills').textContent=onTeamScores[onMyTeam===0?1:0]||0; }
}
function onAddFeed(text,color){
  const feed=document.getElementById('duel-kill-feed'), el=document.createElement('div');
  el.style.cssText='font-size:.6rem;letter-spacing:.06em;background:rgba(5,8,15,.88);padding:4px 10px;border-left:3px solid '+color+';color:'+color;
  el.textContent=text; feed.appendChild(el);
  if(feed.children.length>6) feed.removeChild(feed.firstChild);
  setTimeout(()=>{ try{el.remove();}catch(e){} },5000);
}
function onShowGameOver(won){
  onCleanup();
  const t=document.getElementById('duel-go-title');
  t.textContent=won?'¬°VICTORIA!':'DERROTA'; t.style.color=won?'var(--green)':'var(--accent2)'; t.style.textShadow='0 0 30px '+(won?'var(--green)':'var(--accent2)');
  const myK=onRoomMode==='ffa'?(onPScores[onMyName]||0):onTeamScores[onMyTeam], oppK=onRoomMode==='ffa'?'?':onTeamScores[onMyTeam===0?1:0];
  document.getElementById('duel-go-vs').textContent='Modo: '+onRoomMode.toUpperCase();
  document.getElementById('duel-go-score').textContent=onRoomMode==='ffa'?('Tu score: '+myK):(myK+' ‚Äî '+oppK);
  onShowScreen('duel-gameover-screen');
}
function onSetErr(msg){ onCleanup(); onLobbyErr(msg); onShowScreen('duel-lobby-screen'); onConnect(); }
function onCleanup(){
  zmActive=false; onActive=false; onLocked=false; clearInterval(onStateIv);
  try{document.exitPointerLock();}catch(e){}
  document.getElementById('duel-canvas').style.display='none'; document.getElementById('duel-hud').style.display='none';
  document.getElementById('duel-crosshair').style.display='none'; document.getElementById('duel-lock-screen').style.display='none';
  document.getElementById('duel-death-vignette').style.display='none'; document.getElementById('duel-respawn-msg').style.display='none';
  const oppHpW=document.getElementById('duel-opp-hp-wrap'); if(oppHpW) oppHpW.style.display='none';
  document.getElementById('duel-mobile-controls').classList.remove('active');
  onOpps.forEach(o=>{if(onScene)onScene.remove(o.group);}); onOpps.clear();
  if(onAnimId){cancelAnimationFrame(onAnimId);onAnimId=null;}
}

document.addEventListener('pointerlockchange',()=>{
  if(!onActive) return;
  onLocked=document.pointerLockElement===document.getElementById('duel-canvas');
  if(!mobileMode){
    document.getElementById('duel-crosshair').style.display=onLocked?'block':'none';
    document.getElementById('duel-lock-screen').style.display=onLocked?'none':'flex';
  }
});
document.getElementById('duel-lock-btn').addEventListener('click',()=>{
  if(mobileMode && onActive){
    onLocked=true;
    document.getElementById('duel-lock-screen').style.display='none';
    document.getElementById('duel-crosshair').style.display='block';
    document.getElementById('duel-mobile-controls').classList.add('active');
  } else {
    document.getElementById('duel-canvas').requestPointerLock();
  }
});
document.addEventListener('mousemove',e=>{ if((!onLocked&&!mobileMode)||!onActive) return; onMX+=e.movementX; onMY+=e.movementY; });
document.getElementById('duel-canvas').addEventListener('click',()=>{
  if(!onLocked||!mobileMode) {
    if(zmActive) zmOnShoot();
    else if(onActive) onTryShoot();
  }
});
document.getElementById('open-zombie-btn').addEventListener('click',()=>{
  menuScreen.classList.add('hidden');
  onMyName=currentUser?.name||'Jugador';
  onMySpawn={x:0,z:0,yaw:0};
  zmStart();
});
document.addEventListener('keydown',e=>{
  onKeys[e.key]=true;
  if(!onActive) return;
  if(e.key==='1') onSwitchWeapon('pistol');
  if(e.key==='2') onSwitchWeapon('rifle');
  if(e.key==='3') onSwitchWeapon('shotgun');
  if(e.key==='r'||e.key==='R') onStartReload();
  if(e.key==='g'||e.key==='G'){ if(zmActive||onActive) onThrowGrenade(); }
});
document.addEventListener('keyup',  e=>{ onKeys[e.key]=false; });

function onAnimateAllChars(dt){ onOpps.forEach(opp=>{ if(opp.group&&opp.group.visible) onAnimateChar(opp.group,dt); }); }

// ============================================================
// MOBILE CONTROLS SYSTEM
// ============================================================
let mobileMode = false;
const isMobileDevice = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || navigator.maxTouchPoints > 1;

const mobLook = { active:false, id:-1, lastX:0, lastY:0 };
const duelJoy = { active:false, id:-1, baseX:0, baseY:0 };
const duelLook = { active:false, id:-1, lastX:0, lastY:0 };
const DJOY_MAX = 50;

function setMobileMode(on) {
  mobileMode = on;
  try { localStorage.setItem('ina_mobile', on?'1':'0'); } catch(e){}
  document.querySelectorAll('.mob-toggle-btn').forEach(b => {
    b.classList.toggle('on', on);
    b.textContent = on ? 'üì± M√ìVIL: ON ‚úì' : 'üì± MODO M√ìVIL';
  });
  const hint = document.getElementById('lock-hint');
  if(hint){
    hint.innerHTML = on
      ? 'Arrastra el lado derecho para apuntar<br>üî¥ para disparar ¬∑ ‚¨Ü para saltar'
      : 'Mueve el mouse para apuntar<br>Clic izquierdo para disparar<br>Presiona <strong style="color:var(--accent)">ESC</strong> para pausar';
  }
}

(function(){
  try {
    const s = localStorage.getItem('ina_mobile');
    if(s !== null) setMobileMode(s==='1');
    else if(isMobileDevice) setMobileMode(true);
  } catch(e){}
})();

document.getElementById('mob-toggle-btn').addEventListener('click', ()=>setMobileMode(!mobileMode));
document.getElementById('mob-toggle-menu-btn').addEventListener('click', ()=>setMobileMode(!mobileMode));
document.getElementById('mob-toggle-duel-btn').addEventListener('click', ()=>setMobileMode(!mobileMode));
document.getElementById('mob-toggle-duel-btn-lock').addEventListener('click', ()=>setMobileMode(!mobileMode));

// SOLO look zone
const soloLookZone = document.getElementById('look-zone');
soloLookZone.addEventListener('touchstart', e=>{
  if(!mobileMode || !state.running) return;
  e.preventDefault();
  const t = e.changedTouches[0];
  mobLook.active=true; mobLook.id=t.identifier;
  mobLook.lastX=t.clientX; mobLook.lastY=t.clientY;
},{passive:false});
soloLookZone.addEventListener('touchmove', e=>{
  if(!mobLook.active) return;
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier!==mobLook.id) continue;
    const dx=t.clientX-mobLook.lastX, dy=t.clientY-mobLook.lastY;
    mobLook.lastX=t.clientX; mobLook.lastY=t.clientY;
    if(state.running && yawObj){
      const sens = CFG.sens * 0.004;
      yawObj.rotation.y   -= dx * sens;
      pitchObj.rotation.x  = Math.max(-Math.PI/2+.05, Math.min(Math.PI/2-.05, pitchObj.rotation.x - dy*sens));
    }
  }
},{passive:false});
soloLookZone.addEventListener('touchend',    e=>{for(const t of e.changedTouches) if(t.identifier===mobLook.id){mobLook.active=false;mobLook.id=-1;} e.preventDefault();},{passive:false});
soloLookZone.addEventListener('touchcancel', e=>{mobLook.active=false; mobLook.id=-1;},{passive:false});

document.getElementById('btn-fire').addEventListener('touchstart', e=>{
  e.preventDefault();
  if(!mobileMode || !state.running) return;
  doMobileShoot();
},{passive:false});

function doMobileShoot(){
  if(!state.running) return;
  const m=state.modeId;
  if(m==='tracking') return;
  playGunshot(); triggerShoot();
  const ch=document.getElementById('crosshair'); ch.classList.add('shoot'); setTimeout(()=>ch.classList.remove('shoot'),100);
  if(m==='gridshot'){
    const at=state.targets.find(t=>t.gridIdx===gridActive);
    if(at){ raycaster.setFromCamera(new THREE.Vector2(0,0),camera); if(raycaster.intersectObject(at.mesh,false).length>0){gridHit(at);return;} }
    recordMiss(); return;
  }
  raycaster.setFromCamera(new THREE.Vector2(0,0),camera);
  const hits=raycaster.intersectObjects(state.targets.map(t=>t.mesh).filter(Boolean),false);
  if(hits.length>0){
    const ht=state.targets.find(t=>t.mesh===hits[0].object||t.mesh===hits[0].object.parent);
    if(ht&&ht.alive){recordHit(ht);if(m==='flicking')setTimeout(spawnFor3D,200);}else recordMiss();
  } else recordMiss();
}

document.getElementById('btn-pause-mob').addEventListener('touchstart', e=>{
  e.preventDefault(); if(state.running) showPause();
},{passive:false});
document.getElementById('btn-pause-mob').addEventListener('click', ()=>{ if(state.running) showPause(); });
document.getElementById('joy-zone').addEventListener('touchstart', e=>e.preventDefault(),{passive:false});

// DUEL joystick
const duelJoyZone  = document.getElementById('duel-joy-zone');
const duelJoyBase  = document.getElementById('duel-joy-base');
const duelJoyKnob  = document.getElementById('duel-joy-knob');
const duelLookZone = document.getElementById('duel-look-zone');

duelJoyZone.addEventListener('touchstart', e=>{
  if(!mobileMode||!onActive) return;
  e.preventDefault();
  const t=e.changedTouches[0];
  duelJoy.active=true; duelJoy.id=t.identifier;
  duelJoy.baseX=t.clientX; duelJoy.baseY=t.clientY;
  duelJoyBase.style.cssText=`position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08);border:2px solid rgba(255,61,113,.4);transform:translate(-50%,-50%);left:${t.clientX}px;top:${t.clientY}px;display:block;`;
  duelJoyKnob.style.cssText=`position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,61,113,.7);box-shadow:0 0 18px rgba(255,61,113,.5);border:2px solid rgba(255,61,113,.9);transform:translate(-50%,-50%);left:${t.clientX}px;top:${t.clientY}px;display:block;`;
},{passive:false});

duelJoyZone.addEventListener('touchmove', e=>{
  if(!duelJoy.active) return;
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier!==duelJoy.id) continue;
    const dx=t.clientX-duelJoy.baseX, dy=t.clientY-duelJoy.baseY;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const clamp=Math.min(dist,DJOY_MAX);
    const ang=Math.atan2(dy,dx);
    duelJoyKnob.style.left=(duelJoy.baseX+Math.cos(ang)*clamp)+'px';
    duelJoyKnob.style.top =(duelJoy.baseY+Math.sin(ang)*clamp)+'px';
    const ndx=dx/DJOY_MAX, ndy=dy/DJOY_MAX;
    onKeys['w']=ndy<-.25; onKeys['s']=ndy>.25;
    onKeys['a']=ndx<-.25; onKeys['d']=ndx>.25;
  }
},{passive:false});

function duelJoyEnd(e){
  for(const t of e.changedTouches){
    if(t.identifier!==duelJoy.id) continue;
    duelJoy.active=false; duelJoy.id=-1;
    onKeys['w']=onKeys['s']=onKeys['a']=onKeys['d']=false;
    duelJoyBase.style.display='none'; duelJoyKnob.style.display='none';
  }
  e.preventDefault();
}
duelJoyZone.addEventListener('touchend',    duelJoyEnd,{passive:false});
duelJoyZone.addEventListener('touchcancel', duelJoyEnd,{passive:false});

duelLookZone.addEventListener('touchstart', e=>{
  if(!mobileMode||!onActive) return;
  e.preventDefault();
  const t=e.changedTouches[0];
  duelLook.active=true; duelLook.id=t.identifier;
  duelLook.lastX=t.clientX; duelLook.lastY=t.clientY;
},{passive:false});

duelLookZone.addEventListener('touchmove', e=>{
  if(!duelLook.active) return;
  e.preventDefault();
  for(const t of e.changedTouches){
    if(t.identifier!==duelLook.id) continue;
    const dx=t.clientX-duelLook.lastX, dy=t.clientY-duelLook.lastY;
    duelLook.lastX=t.clientX; duelLook.lastY=t.clientY;
    const mobileSensMult = CFG.sens * 0.18;
    onMX+=dx*mobileSensMult; onMY+=dy*mobileSensMult;
  }
},{passive:false});

duelLookZone.addEventListener('touchend',    e=>{for(const t of e.changedTouches) if(t.identifier===duelLook.id){duelLook.active=false;duelLook.id=-1;} e.preventDefault();},{passive:false});
duelLookZone.addEventListener('touchcancel', e=>{duelLook.active=false; duelLook.id=-1;},{passive:false});

document.getElementById('duel-btn-fire').addEventListener('touchstart', e=>{
  e.preventDefault();
  if(mobileMode&&onActive){ if(zmActive) zmOnShoot(); else onTryShoot(); }
},{passive:false});

document.getElementById('duel-btn-jump').addEventListener('touchstart', e=>{
  e.preventDefault();
  if(mobileMode&&onActive&&onIsGrounded){ onVelY=ON_JUMP_FORCE; onIsGrounded=false; }
},{passive:false});

document.getElementById('duel-btn-pause-mob').addEventListener('touchstart', e=>{
  e.preventDefault();
  if(onActive){
    onLocked=false;
    document.getElementById('duel-mobile-controls').classList.remove('active');
    document.getElementById('duel-crosshair').style.display='none';
    document.getElementById('duel-lock-screen').style.display='flex';
  }
},{passive:false});
document.getElementById('duel-btn-pause-mob').addEventListener('click', ()=>{
  if(onActive){
    onLocked=false;
    document.getElementById('duel-mobile-controls').classList.remove('active');
    document.getElementById('duel-crosshair').style.display='none';
    document.getElementById('duel-lock-screen').style.display='flex';
  }
});

if(isMobileDevice) setMobileMode(true);
</script>
</body>
</html>
